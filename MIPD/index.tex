% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrreprt}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother
% definitions for citeproc citations
\NewDocumentCommand\citeproctext{}{}
\NewDocumentCommand\citeproc{mm}{%
  \begingroup\def\citeproctext{#2}\cite{#1}\endgroup}
\makeatletter
 % allow citations to break across lines
 \let\@cite@ofmt\@firstofone
 % avoid brackets around text for \cite:
 \def\@biblabel#1{}
 \def\@cite#1#2{{#1\if@tempswa , #2\fi}}
\makeatother
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-indent, #2 entry-spacing
 {\begin{list}{}{%
  \setlength{\itemindent}{0pt}
  \setlength{\leftmargin}{0pt}
  \setlength{\parsep}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
   \setlength{\leftmargin}{\cslhangindent}
   \setlength{\itemindent}{-1\cslhangindent}
  \fi
  % set entry spacing
  \setlength{\itemsep}{#2\baselineskip}}}
 {\end{list}}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{\hfill\break\parbox[t]{\linewidth}{\strut\ignorespaces#1\strut}}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}

\usepackage{booktabs}
\usepackage{caption}
\usepackage{longtable}
\usepackage{colortbl}
\usepackage{array}
\usepackage{anyfontsize}
\usepackage{multirow}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{bookmark}{}{\usepackage{bookmark}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother

\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={STP-BRIOCHE : A priori MIPD - Amoxicillin},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}


\title{STP-BRIOCHE : A priori MIPD - Amoxicillin}
\author{}
\date{2027-04-05}

\begin{document}
\maketitle

\renewcommand*\contentsname{Table of contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}

\bookmarksetup{startatroot}

\chapter*{Preface}\label{preface}
\addcontentsline{toc}{chapter}{Preface}

\markboth{Preface}{Preface}

This book contains all that is related to the a priori MIPD developped
in STP-BRIOCHE

\bookmarksetup{startatroot}

\chapter{Objectives}\label{objectives}

To compare the capacity of different MIPD approaches to predict (first)
dose to obtain target concentrations of 40-80 mg.\(L^{-1}\) based on the
patient's covariates.

\bookmarksetup{startatroot}

\chapter{Judgement criteria}\label{judgement-criteria}

The proportion of subjects whose predicted dose allows for obtaining
concentrations in the target interval of 40-80 mg.\(L^{-1}\) (target
interval is based on the guidelines of SFPT - the French Society of
Pharmacology and Therapeutics Guilhaumou et al. (2019)). For patients,
whose extrapolated dose to reach 40 mg/L was higher than 20 g, the
ability to predict the fact that the dose is above 20 g was evaluated.

\bookmarksetup{startatroot}

\chapter{Context}\label{context}

Numerous MIPD approaches have already been developed to predict \emph{a
posteriori} concentrations. Application of the \emph{a priori}
approaches developed in this project could help certain patients to
reach target concentrations interval faster this way improving clinical
results and to reduce the number of necessary blood samples.

\bookmarksetup{startatroot}

\chapter{Covariate simulation}\label{covariate-simulation}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(here)}
\FunctionTok{library}\NormalTok{(knitr)}
\FunctionTok{library}\NormalTok{(rriskDistributions) }\CommentTok{\# to fit distributions}
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(msm) }\CommentTok{\# for truncated normal }
\FunctionTok{library}\NormalTok{(gt) }\CommentTok{\# for complex tables}
\FunctionTok{library}\NormalTok{(MASS) }\CommentTok{\# for colinarity}
\FunctionTok{library}\NormalTok{(tibble)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(MASS)}
\FunctionTok{library}\NormalTok{(ggcorrplot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Objective}\label{objective}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n\_patient }\OtherTok{\textless{}{-}} \DecValTok{625}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{here}\SpecialCharTok{::}\FunctionTok{i\_am}\NormalTok{(}\StringTok{"Amoxicillin/a\_priori/For\_publication/covariate\_simulation.qmd"}\NormalTok{)}
\NormalTok{cov\_data }\OtherTok{\textless{}{-}} \FunctionTok{read\_csv}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"Amoxicillin/a\_priori/Simulations/cov\_distrib\_from\_papers.csv"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

For each included paper we want to simulate 625 patients. We define a
patient by a vector of covariate values. The covariates of interest are
:

\begin{itemize}
\tightlist
\item
  WT : Body weight (kg)
\item
  CRCL : Creatinine clearance (mL/min)
\item
  ICU : Is the patient an ICU patient (=1) or not (=0)
\item
  BURN : Is the patient a burn patient (=1) or not (=0)
\item
  OBESE : Is the patient a obese - BMI \textgreater{} 30 kg/m\^{}2 (=1)
  or not (=0)
\item
  SEX : Male (=0) or female (=1)
\item
  HT : height (cm)
\item
  AGE : age (years)
\end{itemize}

To simulate covariate values we use information on the distribution of
the covariates taken from the included papers.

We included 4 papers :

\begin{itemize}
\item
  Carlier et al. (2013)
\item
  Fournier et al. (2018)
\item
  Mellon et al. (2020)
\item
  Rambaud et al. (2020)
\end{itemize}

We obtained a clinical dataset composed of more than 16000 ICU patients
(Johnson et al. (2023)). Age, serum creatinine, body weight, sex, height
and BMI were obtained for these patients and the creatinine clearance
was calculated (in mL/min for Cockroft and Gault and CKD-EPI and in
mL/min/1.73 m2 for MDRD (to correspond to Mellon)). A correlation matrix
was calculated for each of the respective model development cohorts
separately for females and males.

This correlation matrix is used to simulate correlations between the
simulated WT, CRCL, AGE, and HT/BMI if necessary to convert CRCL to
serum creatinine. (CRCL\_MDRD\_norm means CRCL in mL/min/1.73 mÂ² used
for Mellon and CRCL\_MDRD in mL/min.). Different correlation matrices
are used based on sex. This way two different mutlivariate distributions
are simulated based on the two matrices with a number of patients that
respects the original article's proportions.

We can find correlations for the log-transformed forms of certain
variables. For the covariates where a log-normal distribution fits
better the log mean and standard deviation of this distribution will be
used to sample log values with a multivariate normal distribution. At
the end, the log variables will be retransformed to normal ones.

\section{Carlier et al. (2013)}\label{carlier2013-bq}

\subsection{Covariate distribution}\label{covariate-distribution}

All patients are ICU patients and we will assume that they are not burn
and not obese patients. Creatinine clearance was obtained using the
measured urinary equation. Thus for all patients ICU = 1, BURN = 0.

As discussed in the article, renal replacement therapy is an exclusion
criterion, therefore the minimum value of creatinine clearance is set to
10 mL/min. CRCL was calculated using the measured urinary equation.

For WT and CRCL here are the data from the paper :

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_data\_carlier }\OtherTok{\textless{}{-}}\NormalTok{ cov\_data }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Paper }\SpecialCharTok{==} \StringTok{"Carlier\_2013"}\NormalTok{)}

\NormalTok{cov\_data\_carlier }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Covariate }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{,}\StringTok{"CRCL"}\NormalTok{,}\StringTok{"AGE"}\NormalTok{,}\StringTok{"BMI"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{kable}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllrrrrr@{}}
\toprule\noalign{}
Paper & Covariate & Unit & Median & Q1 & Q3 & Min & Max \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Carlier\_2013 & WT & kg & 75 & 70 & 79 & NA & NA \\
Carlier\_2013 & CRCL & mL/min & 102 & 50 & 157 & 10 & NA \\
Carlier\_2013 & BMI & kg/m\^{}\{2\} & 24 & 21 & 25 & NA & NA \\
Carlier\_2013 & AGE & year & 62 & 58 & 72 & NA & NA \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Carlier\_F }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Carlier\_F.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Carlier\_F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                    CREAT   CREAT_log         AGE          WT      WT_log
CREAT          1.00000000  0.93719806  0.17043554  0.07114115  0.07024583
CREAT_log      0.93719806  1.00000000  0.22904749  0.09016458  0.09019928
AGE            0.17043554  0.22904749  1.00000000 -0.11058359 -0.10874794
WT             0.07114115  0.09016458 -0.11058359  1.00000000  0.99663272
WT_log         0.07024583  0.09019928 -0.10874794  0.99663272  1.00000000
HT            -0.02615290 -0.03452481 -0.22145176  0.36158540  0.35423946
HT_log        -0.02656759 -0.03481661 -0.22200991  0.36341580  0.35641748
BMI            0.09120381  0.11653457  0.01416104  0.83213862  0.83590568
BMI_log        0.08905860  0.11477057  0.01748252  0.82644900  0.83409794
CRCL_MDRD     -0.73311938 -0.90200963 -0.35625197  0.05193539  0.05083450
CRCL_MDRD_log -0.91894029 -0.98323371 -0.33894619  0.05521443  0.05501799
                       HT      HT_log         BMI     BMI_log   CRCL_MDRD
CREAT         -0.02615290 -0.02656759  0.09120381  0.08905860 -0.73311938
CREAT_log     -0.03452481 -0.03481661  0.11653457  0.11477057 -0.90200963
AGE           -0.22145176 -0.22200991  0.01416104  0.01748252 -0.35625197
WT             0.36158540  0.36341580  0.83213862  0.82644900  0.05193539
WT_log         0.35423946  0.35641748  0.83590568  0.83409794  0.05083450
HT             1.00000000  0.99908709 -0.21054270 -0.21983890  0.15405745
HT_log         0.99908709  1.00000000 -0.20907388 -0.21810288  0.15428482
BMI           -0.21054270 -0.20907388  1.00000000  0.99655760 -0.03784624
BMI_log       -0.21983890 -0.21810288  0.99655760  1.00000000 -0.03799028
CRCL_MDRD      0.15405745  0.15428482 -0.03784624 -0.03799028  1.00000000
CRCL_MDRD_log  0.14873339  0.14934183 -0.03146339 -0.03070224  0.92275219
              CRCL_MDRD_log
CREAT           -0.91894029
CREAT_log       -0.98323371
AGE             -0.33894619
WT               0.05521443
WT_log           0.05501799
HT               0.14873339
HT_log           0.14934183
BMI             -0.03146339
BMI_log         -0.03070224
CRCL_MDRD        0.92275219
CRCL_MDRD_log    1.00000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Carlier\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: female"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/carlier-cor-matrix-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Carlier\_M }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Carlier\_M.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Carlier\_M)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                    CREAT   CREAT_log          AGE          WT      WT_log
CREAT          1.00000000  0.93656904  0.129584751  0.03477888  0.03489511
CREAT_log      0.93656904  1.00000000  0.191015858  0.06256888  0.06255796
AGE            0.12958475  0.19101586  1.000000000 -0.05978080 -0.05792048
WT             0.03477888  0.06256888 -0.059780801  1.00000000  0.99691085
WT_log         0.03489511  0.06255796 -0.057920475  0.99691085  1.00000000
HT            -0.01562634 -0.02015099 -0.099371429  0.33471772  0.33277207
HT_log        -0.01514335 -0.01943840 -0.098654543  0.33778296  0.33606644
BMI            0.04448518  0.07478234  0.002442579  0.78722872  0.78753911
BMI_log        0.04503665  0.07581809  0.004260007  0.79489820  0.79912510
CRCL_MDRD     -0.73662552 -0.90639303 -0.327115476  0.04508957  0.04511819
CRCL_MDRD_log -0.92158994 -0.98613183 -0.287263519  0.06492902  0.06504475
                       HT      HT_log          BMI      BMI_log   CRCL_MDRD
CREAT         -0.01562634 -0.01514335  0.044485175  0.045036646 -0.73662552
CREAT_log     -0.02015099 -0.01943840  0.074782343  0.075818092 -0.90639303
AGE           -0.09937143 -0.09865454  0.002442579  0.004260007 -0.32711548
WT             0.33471772  0.33778296  0.787228725  0.794898201  0.04508957
WT_log         0.33277207  0.33606644  0.787539107  0.799125098  0.04511819
HT             1.00000000  0.99918214 -0.312182156 -0.300458114  0.12810278
HT_log         0.99918214  1.00000000 -0.309805459 -0.297640862  0.12729396
BMI           -0.31218216 -0.30980546  1.000000000  0.996020588 -0.03549251
BMI_log       -0.30045811 -0.29764086  0.996020588  1.000000000 -0.03551703
CRCL_MDRD      0.12810278  0.12729396 -0.035492514 -0.035517032  1.00000000
CRCL_MDRD_log  0.11829734  0.11791657 -0.010057809 -0.009333342  0.92462410
              CRCL_MDRD_log
CREAT          -0.921589942
CREAT_log      -0.986131825
AGE            -0.287263519
WT              0.064929019
WT_log          0.065044752
HT              0.118297341
HT_log          0.117916569
BMI            -0.010057809
BMI_log        -0.009333342
CRCL_MDRD       0.924624105
CRCL_MDRD_log   1.000000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Carlier\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: male"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/carlier-cor-matrix-2.pdf}}

We are going to fit normal and log-normal distributions to the observed
quantiles and select the best fitting one

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{compute\_cv\_from\_sd\_lnorm }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(sdlog)\{}
  \CommentTok{\#\textquotesingle{} Compute the geometric coefficient of variation from the standard deviation of a lognormal distribution}
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param sdlog numeric. standard deviation of the log transformed variable}
  \CommentTok{\#\textquotesingle{} }
  \CommentTok{\#\textquotesingle{} @return numeric. geometric coefficient of variation}
  \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{exp}\NormalTok{(sdlog}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}

\NormalTok{extract\_cov\_param }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(cov\_data, cov\_name) \{}
  
  \CommentTok{\#\textquotesingle{} Get covariate quantiles from covariate characteristics table}
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param cov\_data tibble containing the covariate information}
  \CommentTok{\#\textquotesingle{} @param cov\_name character. name of the covariate to select, comes from the Covariate column of cov\_data.}
  \CommentTok{\#\textquotesingle{} @return list with :}
  \CommentTok{\#\textquotesingle{}  {-} p : numeric vector of probabilities}
  \CommentTok{\#\textquotesingle{}  {-} q : numeric vector of quantiles}
  \CommentTok{\#\textquotesingle{}  {-} cov\_name : character string containing the covariate name}
  \CommentTok{\#\textquotesingle{}  {-} cov\_unit : character string containing the unit of the covariate}
  
  
\NormalTok{  cov\_filtered\_df }\OtherTok{\textless{}{-}}\NormalTok{ cov\_data }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{filter}\NormalTok{(Covariate }\SpecialCharTok{==}\NormalTok{ cov\_name) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pivot\_longer}\NormalTok{(}
      \AttributeTok{cols =} \FunctionTok{c}\NormalTok{(Median, Q1, Q3, Min, Max), }\CommentTok{\# if the format of the csv columns ever changes, this will need to change}
      \AttributeTok{names\_to =} \StringTok{"p"}\NormalTok{,}
      \AttributeTok{values\_to =} \StringTok{"q"}
\NormalTok{    ) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{p =} \FunctionTok{case\_match}\NormalTok{(p, }\StringTok{"Median"} \SpecialCharTok{\textasciitilde{}} \FloatTok{0.5}\NormalTok{, }\StringTok{"Q1"} \SpecialCharTok{\textasciitilde{}} \FloatTok{0.25}\NormalTok{, }\StringTok{"Q3"} \SpecialCharTok{\textasciitilde{}} \FloatTok{0.75}\NormalTok{, }\StringTok{"Min"} \SpecialCharTok{\textasciitilde{}} \FloatTok{0.01}\NormalTok{, }\StringTok{"Max"} \SpecialCharTok{\textasciitilde{}} \FloatTok{0.99}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
    \CommentTok{\# if the format of the csv columns ever changes, the code above will need to change}
    \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(q)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{group\_by}\NormalTok{(Paper) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{arrange}\NormalTok{(p, }\AttributeTok{.by\_group =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{ungroup}\NormalTok{()}
  
  \FunctionTok{list}\NormalTok{(}
    \AttributeTok{p =}\NormalTok{ cov\_filtered\_df}\SpecialCharTok{$}\NormalTok{p,}
    \AttributeTok{q =}\NormalTok{ cov\_filtered\_df}\SpecialCharTok{$}\NormalTok{q,}
    \AttributeTok{cov\_name =} \FunctionTok{unique}\NormalTok{(cov\_filtered\_df}\SpecialCharTok{$}\NormalTok{Covariate),}
    \AttributeTok{cov\_unit =} \FunctionTok{unique}\NormalTok{(cov\_filtered\_df}\SpecialCharTok{$}\NormalTok{Unit)}
\NormalTok{  )}
  
  
\NormalTok{\}}

\NormalTok{evaluate\_distrib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, q, cov\_name, cov\_unit, min\_plot, max\_plot,}\AttributeTok{tol =} \FloatTok{0.001}\NormalTok{) \{}
  \CommentTok{\#\textquotesingle{} Fit normal and lognormal distribution to observed quantiles}
  \CommentTok{\#\textquotesingle{} @param p numeric vector of probabilities}
  \CommentTok{\#\textquotesingle{} @param q numeric vector of quantiles}
  \CommentTok{\#\textquotesingle{} @param cov\_name character string containing the covariate name}
  \CommentTok{\#\textquotesingle{} @param cov\_unit character string containing the unit of the covariate}
  \CommentTok{\#\textquotesingle{} @param min\_plot minimal value of the covariate for which the distribution should be plotted}
  \CommentTok{\#\textquotesingle{} @param max\_plot maximal value of the covariate for which the distribution should be plotted}
  \CommentTok{\#\textquotesingle{} @param tol numeric. tolerance value for the fitting algorithm, default is 0.001}
  \CommentTok{\#\textquotesingle{} @return list with :}
  \CommentTok{\#\textquotesingle{}  {-} plot : ggplot2 showing the fitted distributions and the observed covariate}
  \CommentTok{\#\textquotesingle{}  {-} lnorm\_par : named numeric vector with the lognormal distribution parameters}
  \CommentTok{\#\textquotesingle{}  {-} norm\_par : named numeric vector with the normal distribution parameters}
  
  
\NormalTok{  lnorm\_par }\OtherTok{\textless{}{-}} \FunctionTok{get.lnorm.par}\NormalTok{(}\AttributeTok{p =}\NormalTok{ p, }\AttributeTok{q =}\NormalTok{ q, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{show.output =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{tol =}\NormalTok{ tol)}
\NormalTok{  norm\_par }\OtherTok{\textless{}{-}} \FunctionTok{get.norm.par}\NormalTok{(}\AttributeTok{p =}\NormalTok{ p, }\AttributeTok{q =}\NormalTok{ q, }\AttributeTok{plot =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{show.output =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{tol=}\NormalTok{tol)}
  
  \CommentTok{\#create a dataset with the true percentiles to be able to show them on the plot}
\NormalTok{  true\_percentiles }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(p, q) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{label =} \FunctionTok{case\_match}\NormalTok{(p, }
                              \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{"True min"}\NormalTok{,}
                              \FloatTok{0.25} \SpecialCharTok{\textasciitilde{}} \StringTok{"True Q1"}\NormalTok{,}
                              \FloatTok{0.5} \SpecialCharTok{\textasciitilde{}} \StringTok{"True median"}\NormalTok{,}
                              \FloatTok{0.75} \SpecialCharTok{\textasciitilde{}} \StringTok{"True Q3"}\NormalTok{,}
                              \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \StringTok{"True max"}\NormalTok{)) }
  
  \CommentTok{\#create a dataset with the percentiles of the fitted distributiosn to be able to show them on the plot}
\NormalTok{  distrib\_percentiles }\OtherTok{\textless{}{-}}  \FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{probability =}\NormalTok{ p,}
    \AttributeTok{lnorm =} \FunctionTok{qlnorm}\NormalTok{(probability, }\AttributeTok{meanlog =}\NormalTok{ lnorm\_par[}\StringTok{"meanlog"}\NormalTok{], }\AttributeTok{sdlog =}
\NormalTok{                     lnorm\_par[}\StringTok{"sdlog"}\NormalTok{]),}
    \AttributeTok{norm =} \FunctionTok{qnorm}\NormalTok{(probability, }\AttributeTok{mean =}\NormalTok{ norm\_par[}\StringTok{"mean"}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ norm\_par[}\StringTok{"sd"}\NormalTok{])}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(lnorm, norm), }\AttributeTok{names\_to =} \StringTok{"distrib"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{density =} \FunctionTok{case\_match}\NormalTok{(}
\NormalTok{      distrib,}
      \StringTok{"norm"} \SpecialCharTok{\textasciitilde{}} \FunctionTok{dnorm}\NormalTok{(value, }\AttributeTok{mean =}\NormalTok{ norm\_par[}\StringTok{"mean"}\NormalTok{], }\AttributeTok{sd =}
\NormalTok{                       norm\_par[}\StringTok{"sd"}\NormalTok{]),}
      \StringTok{"lnorm"} \SpecialCharTok{\textasciitilde{}} \FunctionTok{dlnorm}\NormalTok{(value, }\AttributeTok{meanlog =}\NormalTok{ lnorm\_par[}\StringTok{"meanlog"}\NormalTok{], }\AttributeTok{sdlog =}
\NormalTok{                         lnorm\_par[}\StringTok{"sdlog"}\NormalTok{])}
\NormalTok{    )) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{label =} \FunctionTok{case\_match}\NormalTok{(probability, }
                              \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{"Min"}\NormalTok{,}
                              \FloatTok{0.25} \SpecialCharTok{\textasciitilde{}} \StringTok{"Q1"}\NormalTok{,}
                              \FloatTok{0.5} \SpecialCharTok{\textasciitilde{}} \StringTok{"Median"}\NormalTok{,}
                              \FloatTok{0.75} \SpecialCharTok{\textasciitilde{}} \StringTok{"Q3"}\NormalTok{,}
                              \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \StringTok{"Max"}\NormalTok{)) }
  
  
  \CommentTok{\#simulate 1000 datapoints from the fitted distributions to show on the plot}
\NormalTok{  param\_data }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{variable =} \FunctionTok{seq}\NormalTok{(min\_plot, max\_plot, }\AttributeTok{length.out =} \DecValTok{1000}\NormalTok{),}
    \AttributeTok{lnorm =} \FunctionTok{dlnorm}\NormalTok{(variable, }\AttributeTok{meanlog =}\NormalTok{ lnorm\_par[}\StringTok{"meanlog"}\NormalTok{], }\AttributeTok{sdlog =}\NormalTok{ lnorm\_par[}\StringTok{"sdlog"}\NormalTok{]),}
    \AttributeTok{norm =} \FunctionTok{dnorm}\NormalTok{(variable, }\AttributeTok{mean =}\NormalTok{ norm\_par[}\StringTok{"mean"}\NormalTok{], }\AttributeTok{sd =}\NormalTok{ norm\_par[}\StringTok{"sd"}\NormalTok{])}
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(lnorm, norm), }\AttributeTok{names\_to =} \StringTok{"distrib"}\NormalTok{)}
  
  
\NormalTok{  plot }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(param\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ variable, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{color =}\NormalTok{ distrib)) }\SpecialCharTok{+}
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{data =}\NormalTok{ true\_percentiles, }\AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ q),}\AttributeTok{lty =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ distrib\_percentiles, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ value, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{yend =}
\NormalTok{                                                   density)) }\SpecialCharTok{+}
    \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_brewer}\NormalTok{(}\StringTok{"Distribution"}\NormalTok{, }\AttributeTok{palette =} \StringTok{"Dark2"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{ylab}\NormalTok{(}\StringTok{"Density"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlab}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(cov\_name, }\StringTok{" ("}\NormalTok{, cov\_unit, }\StringTok{")"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{annotate}\NormalTok{(}
      \AttributeTok{geom =} \StringTok{"text"}\NormalTok{,}
      \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}
        \StringTok{"N \textasciitilde{} ("}\NormalTok{,}
        \FunctionTok{signif}\NormalTok{(norm\_par[}\StringTok{"mean"}\NormalTok{], }\DecValTok{3}\NormalTok{),}
        \StringTok{", "}\NormalTok{,}
        \FunctionTok{signif}\NormalTok{(norm\_par[}\StringTok{"sd"}\NormalTok{], }\DecValTok{3}\NormalTok{),}
        \StringTok{")}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
        \StringTok{"LN \textasciitilde{} ("}\NormalTok{,}
        \FunctionTok{signif}\NormalTok{(}\FunctionTok{exp}\NormalTok{(lnorm\_par[}\StringTok{"meanlog"}\NormalTok{]), }\DecValTok{3}\NormalTok{),}
        \StringTok{", "}\NormalTok{,}
        \FunctionTok{signif}\NormalTok{(}\FunctionTok{compute\_cv\_from\_sd\_lnorm}\NormalTok{(lnorm\_par[}\StringTok{"sdlog"}\NormalTok{]), }\DecValTok{3}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
        \StringTok{" \%)"}
\NormalTok{      ),}
      \AttributeTok{x =} \FunctionTok{min}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{variable) }\SpecialCharTok{+} \FloatTok{0.99} \SpecialCharTok{*} \FunctionTok{diff}\NormalTok{(}\FunctionTok{range}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{variable)),}
      \AttributeTok{y =} \FunctionTok{min}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{value) }\SpecialCharTok{+} \FloatTok{0.99} \SpecialCharTok{*} \FunctionTok{diff}\NormalTok{(}\FunctionTok{range}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{value)),}
      \AttributeTok{hjust =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{vjust =} \DecValTok{1}
\NormalTok{    )}\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}
      \AttributeTok{data =}\NormalTok{ true\_percentiles,}
      \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ q,}\AttributeTok{label =}\NormalTok{ label,}\AttributeTok{color=}\ConstantTok{NULL}\NormalTok{),}
      \AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{y =} \FunctionTok{min}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{value) }\SpecialCharTok{+} \FloatTok{0.95} \SpecialCharTok{*} \FunctionTok{diff}\NormalTok{(}\FunctionTok{range}\NormalTok{(param\_data}\SpecialCharTok{$}\NormalTok{value)),}
      \AttributeTok{hjust =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
      \AttributeTok{angle =} \DecValTok{90}
\NormalTok{    )}\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}
      \AttributeTok{data =}\NormalTok{ distrib\_percentiles,}
      \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ value, }\AttributeTok{y=}\NormalTok{density,}\AttributeTok{label =}\NormalTok{ label),}
      \AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{hjust =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
      \AttributeTok{angle =} \DecValTok{90}
\NormalTok{    )}
  
  \FunctionTok{list}\NormalTok{(}\AttributeTok{plot =}\NormalTok{ plot,}
       \AttributeTok{lnorm\_par =}\NormalTok{ lnorm\_par,}
       \AttributeTok{norm\_par =}\NormalTok{ norm\_par)}
  
\NormalTok{\}}

\NormalTok{fit\_cov\_wrapper }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(cov\_data, cov\_name, min\_plot, max\_plot, }\AttributeTok{tol =} \FloatTok{0.001}\NormalTok{) \{}
  
  \CommentTok{\#\textquotesingle{} Wrapper to get covariate quantiles from covariate characteristics table and fit normal and lognormal distribution}
  \CommentTok{\#\textquotesingle{} to observed quantiles }
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param cov\_data tibble containing the covariate information}
  \CommentTok{\#\textquotesingle{} @param cov\_name character. name of the covariate to select, comes from the Covariate column of cov\_data.}
  \CommentTok{\#\textquotesingle{} @param min\_plot minimal value of the covariate for which the distribution should be plotted}
  \CommentTok{\#\textquotesingle{} @param max\_plot maximal value of the covariate for which the distribution should be plotted}
  \CommentTok{\#\textquotesingle{} @param tol numeric. tolerance value for the fitting algorithm, default is 0.001}
  \CommentTok{\#\textquotesingle{} @return list with :}
  \CommentTok{\#\textquotesingle{}  {-} plot : ggplot2 showing the fitted distributions and the observed covariate}
  \CommentTok{\#\textquotesingle{}  {-} lnorm\_par : named numeric vector with the lognormal distribution parameters}
  \CommentTok{\#\textquotesingle{}  {-} norm\_par : named numeric vector with the normal distribution parameters}
  
  
\NormalTok{  cov\_df }\OtherTok{\textless{}{-}} \FunctionTok{extract\_cov\_param}\NormalTok{(cov\_data, cov\_name)}
  
  \FunctionTok{evaluate\_distrib}\NormalTok{(}
    \AttributeTok{p =}\NormalTok{ cov\_df}\SpecialCharTok{$}\NormalTok{p,}
    \AttributeTok{q =}\NormalTok{ cov\_df}\SpecialCharTok{$}\NormalTok{q,}
    \AttributeTok{min\_plot =}\NormalTok{ min\_plot,}
    \AttributeTok{max\_plot =}\NormalTok{ max\_plot,}
    \AttributeTok{cov\_name =}\NormalTok{ cov\_df}\SpecialCharTok{$}\NormalTok{cov\_name,}
    \AttributeTok{cov\_unit =}\NormalTok{ cov\_df}\SpecialCharTok{$}\NormalTok{cov\_unit,}
    \AttributeTok{tol =}\NormalTok{ tol}
\NormalTok{  )}
  
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{carlier\_crcl }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_carlier,}
  \AttributeTok{cov\_name =} \StringTok{"CRCL"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{250}
\NormalTok{)}

\NormalTok{carlier\_crcl}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-carlier-crcl-1.pdf}}

Normal distribution seems better than log-normal.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{carlier\_wt }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_carlier,}
  \AttributeTok{cov\_name =} \StringTok{"WT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{carlier\_wt}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-carlier-wt-1.pdf}}

No discernable difference in fit. We have to use the log-normal
distribution to be able to calculate height.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{carlier\_age }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_carlier,}
  \AttributeTok{cov\_name =} \StringTok{"AGE"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{carlier\_age}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-carlier-age-1.pdf}}

No discernible difference in fit. We will use the normal distribution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{carlier\_bmi }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_carlier,}
  \AttributeTok{cov\_name =} \StringTok{"BMI"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{tol=}\FloatTok{0.002}
\NormalTok{)}

\NormalTok{carlier\_bmi}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-carlier-bmi-1.pdf}}

Tolerance was increased to 0.002. No discernible difference in fit. We
have to use the log-normal distribution to be able to obtain height.

\subsection{Simulation of covariates}\label{simulation-of-covariates}

Covariates will be sampled from the following distributions :

\begin{itemize}
\tightlist
\item
  CRCL : Normal distribution with a minimum of 10 mL/min, with mean 4.54
  mL/min and standard deviation 0.866 mL/min
\item
  WT : Lognormal distribution with mean 74.6 kg, and coefficient of
  variation 9.04 \%
\item
  AGE : Normal distribution with mean 63.7 mL/min and standard deviation
  11 years and with a minimum of 18 years
\item
  BMI : Normal distribution with mean 3.15 mL/min and standard deviation
  0.141 kg/m\^{}\{2\}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sim\_norm\_without\_negatives }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n,mean,sd)\{}
      
  \CommentTok{\#\textquotesingle{} Simulate values from normal distribution but resample negative values}
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param n numeric. number of samples to simulate}
  \CommentTok{\#\textquotesingle{} @param mean numeric. mean of the normal distribution}
  \CommentTok{\#\textquotesingle{} @param sd numeric. standard deviation of the normal distribtuion}
  \CommentTok{\#\textquotesingle{} @return numeric vector of n values}
\NormalTok{  sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n,mean,sd)}
\NormalTok{  neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}=}\DecValTok{0}\NormalTok{]}
\NormalTok{  pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{]}

  \ControlFlowTok{while}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    new\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values),mean,sd)}
\NormalTok{    sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pos\_values,new\_values)}
\NormalTok{    neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}=}\DecValTok{0}\NormalTok{]}
\NormalTok{    pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{]}
\NormalTok{    \}}
\NormalTok{  sim\_values}
\NormalTok{\}}

\CommentTok{\# Only for normal distribution when the minimum is 10 ml/min, resample below 10}
\NormalTok{sim\_norm\_without\_dialysis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n,mean,sd)\{}
      
  \CommentTok{\#\textquotesingle{} Simulate values from normal distribution but resample negative values}
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param n numeric. number of samples to simulate}
  \CommentTok{\#\textquotesingle{} @param mean numeric. mean of the normal distribution}
  \CommentTok{\#\textquotesingle{} @param sd numeric. standard deviation of the normal distribtuion}
  \CommentTok{\#\textquotesingle{} @return numeric vector of n values}
\NormalTok{  sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n,mean,sd)}
\NormalTok{  neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}=}\DecValTok{10}\NormalTok{]}
\NormalTok{  pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}}\DecValTok{10}\NormalTok{]}

  \ControlFlowTok{while}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    new\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values),mean,sd)}
\NormalTok{    sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pos\_values,new\_values)}
\NormalTok{    neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}=}\DecValTok{10}\NormalTok{]}
\NormalTok{    pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}}\DecValTok{10}\NormalTok{]}
\NormalTok{    \}}
\NormalTok{  sim\_values}
\NormalTok{\}}
\CommentTok{\# Resimulate subjects younger than 18 years for normally distributed age}
\NormalTok{sim\_norm\_without\_minors }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n,mean,sd)\{}
      
  \CommentTok{\#\textquotesingle{} Simulate values from normal distribution but resample negative values}
  \CommentTok{\#\textquotesingle{}}
  \CommentTok{\#\textquotesingle{} @param n numeric. number of samples to simulate}
  \CommentTok{\#\textquotesingle{} @param mean numeric. mean of the normal distribution}
  \CommentTok{\#\textquotesingle{} @param sd numeric. standard deviation of the normal distribtuion}
  \CommentTok{\#\textquotesingle{} @return numeric vector of n values}
\NormalTok{  sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(n,mean,sd)}
\NormalTok{  neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}}\DecValTok{18}\NormalTok{]}
\NormalTok{  pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}=}\DecValTok{18}\NormalTok{]}

  \ControlFlowTok{while}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{)\{}
\NormalTok{    new\_values }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{length}\NormalTok{(neg\_values),mean,sd)}
\NormalTok{    sim\_values }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pos\_values,new\_values)}
\NormalTok{    neg\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textless{}}\DecValTok{18}\NormalTok{]}
\NormalTok{    pos\_values }\OtherTok{\textless{}{-}}\NormalTok{ sim\_values[sim\_values}\SpecialCharTok{\textgreater{}=}\DecValTok{18}\NormalTok{]}
\NormalTok{    \}}
\NormalTok{  sim\_values}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The relevant part of the correlation matrix is converted to a covariance
matrix by multiplying the already calculated standard deviations of the
variables with the diagonal of the correlation matrix. More information
can be found at
\href{https://blogs.sas.com/content/iml/2010/12/10/converting-between-correlation-and-covariance-matrices.html}{SAS}
and at
\href{https://stats.stackexchange.com/questions/62850/obtaining-covariance-matrix-from-correlation-matrix}{stats}.
A multivariate normal distribution is fitted with resimulation of CRCL
below 10 ml/min, AGE below 18 years, and other variables below 0.

The proportion of males is 0.85 in the original article, so the number
of males is 531 and the number of females is 94 to add up to 625.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mean\_WT }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(carlier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{])}
\NormalTok{sd\_WT }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(carlier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{])}
\NormalTok{mean\_BMI }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(carlier\_bmi}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{])}
\NormalTok{sd\_BMI }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(carlier\_bmi}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{])}
\NormalTok{r\_M }\OtherTok{\textless{}{-}} \FloatTok{0.34} \CommentTok{\# Pearson correlation between HT\_log and WT\_log for males}
\NormalTok{r\_F }\OtherTok{\textless{}{-}} \FloatTok{0.36} \CommentTok{\# Pearson correlation for females}

\CommentTok{\# sd is different based on sex}
\NormalTok{mean\_HT }\OtherTok{=}\NormalTok{ (mean\_WT }\SpecialCharTok{{-}}\NormalTok{ mean\_BMI) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{sd\_HT\_M }\OtherTok{=}\NormalTok{ (}\SpecialCharTok{{-}}\NormalTok{r\_M }\SpecialCharTok{*}\NormalTok{ sd\_WT }\SpecialCharTok{+} \FunctionTok{sqrt}\NormalTok{(r\_M}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ sd\_WT}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ sd\_WT}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ sd\_BMI}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{/}\DecValTok{2} \CommentTok{\# quadratic equation with positive result}
\NormalTok{sd\_HT\_F }\OtherTok{=}\NormalTok{ (}\SpecialCharTok{{-}}\NormalTok{r\_F }\SpecialCharTok{*}\NormalTok{ sd\_WT }\SpecialCharTok{+} \FunctionTok{sqrt}\NormalTok{(r\_F}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{*}\NormalTok{ sd\_WT}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ sd\_WT}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ sd\_BMI}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}\SpecialCharTok{/}\DecValTok{2} \CommentTok{\# quadratic equation with positive}

\NormalTok{correlated\_simulation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, means, cov\_matrix) \{}
  \FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\NormalTok{  collected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(means))}
  \FunctionTok{colnames}\NormalTok{(collected) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

  \ControlFlowTok{while}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(collected) }\SpecialCharTok{\textless{}}\NormalTok{ n) \{}
\NormalTok{    batch }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{mvrnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{mu =}\NormalTok{ means, }\AttributeTok{Sigma =}\NormalTok{ cov\_matrix)}
    \FunctionTok{colnames}\NormalTok{(batch) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

\NormalTok{    valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[, }\StringTok{"AGE"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{18} \SpecialCharTok{\&}
\NormalTok{             batch[, }\StringTok{"CRCL\_MDRD"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{10}

\NormalTok{    batch\_valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[valid, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{    collected }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(collected, batch\_valid)}
\NormalTok{  \}}

\NormalTok{  collected[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{\}}

\NormalTok{means }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_MDRD =}\NormalTok{ carlier\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ carlier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{],}
  \AttributeTok{AGE     =}\NormalTok{ carlier\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{HT\_log     =}\NormalTok{ mean\_HT}
\NormalTok{)}

\NormalTok{sds\_M }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_MDRD =}\NormalTok{ carlier\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ carlier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{], }
  \AttributeTok{AGE     =}\NormalTok{ carlier\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{HT\_log     =}\NormalTok{ sd\_HT\_M}
\NormalTok{)}

\NormalTok{sds\_F }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_MDRD =}\NormalTok{ carlier\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ carlier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{], }
  \AttributeTok{AGE     =}\NormalTok{ carlier\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{HT\_log     =}\NormalTok{ sd\_HT\_F}
\NormalTok{)}

\NormalTok{covariates }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CRCL\_MDRD"}\NormalTok{, }\StringTok{"WT\_log"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"HT\_log"}\NormalTok{)}

\FunctionTok{names}\NormalTok{(means) }\OtherTok{\textless{}{-}}\NormalTok{ covariates}

\CommentTok{\# Correlation and Covariance Matrix}
\NormalTok{cor\_carlier\_M }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Carlier\_M[covariates, covariates]}
\NormalTok{cov\_matrix\_M }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds\_M) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_carlier\_M }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds\_M)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_M)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4.705706e+03 1.077951e+02 8.326780e-03 1.446538e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_carlier\_F }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Carlier\_F[covariates, covariates]}
\NormalTok{cov\_matrix\_F }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds\_F) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_carlier\_F }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds\_F)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_F)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4.708164e+03 1.053367e+02 8.259148e-03 1.338558e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Simulate}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{531}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_M)}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_M) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{0}\NormalTok{)}

\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{94}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_F)}
\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_F) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{1}\NormalTok{)}

\NormalTok{sim\_data }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sim\_data\_M, sim\_data\_F)}

\CommentTok{\# Put the covariates together}
\NormalTok{sim\_cov\_carlier }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{Paper =} \StringTok{"Carlier\_2013"}\NormalTok{,}
  \AttributeTok{ID\_within\_paper =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_patient,}
  \AttributeTok{ICU =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{BURN =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{OBESE =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{CRCL =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{CRCL\_MDRD,}
  \AttributeTok{WT\_log   =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{WT\_log,}
  \AttributeTok{AGE  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{AGE,}
  \AttributeTok{HT\_log  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{HT\_log,}
  \AttributeTok{SEX =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{SEX}
\NormalTok{)}

\CommentTok{\# Add OBESE variable and reconvert logWT to WT}
\NormalTok{sim\_cov\_carlier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{WT =} \FunctionTok{exp}\NormalTok{(WT\_log),}
         \AttributeTok{HT =}\NormalTok{ (}\FunctionTok{exp}\NormalTok{(HT\_log))}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}
         \AttributeTok{BMI =}\NormalTok{ WT }\SpecialCharTok{/}\NormalTok{ (HT}\SpecialCharTok{/}\DecValTok{100}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
         \AttributeTok{OBESE =} \FunctionTok{ifelse}\NormalTok{(BMI }\SpecialCharTok{\textgreater{}} \DecValTok{30}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}

\NormalTok{summary\_sim\_cov\_carlier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(ICU,BURN,OBESE,CRCL,WT,AGE,BMI),}
               \AttributeTok{names\_to =} \StringTok{"Covariate"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{.by =} \FunctionTok{c}\NormalTok{(Covariate,Paper),}
            \AttributeTok{Min =} \FunctionTok{min}\NormalTok{(value),}
            \AttributeTok{Q1 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.25}\NormalTok{),}
            \AttributeTok{Median =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{Q3 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.75}\NormalTok{),}
            \AttributeTok{Max =} \FunctionTok{max}\NormalTok{(value))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_carlier\_compare }\OtherTok{\textless{}{-}}\NormalTok{ summary\_sim\_cov\_carlier }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{rename\_with}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_sim"}\NormalTok{), }\SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{rename\_with}\NormalTok{(}
\NormalTok{    cov\_data\_carlier,}
    \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_true"}\NormalTok{),}
    \SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{, }\StringTok{"Unit"}\NormalTok{)}
\NormalTok{  )) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Covariate, }\AttributeTok{.after =}\NormalTok{ Paper) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Unit, }\AttributeTok{.after =}\NormalTok{ Covariate)}

\NormalTok{cov\_carlier\_compare }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{gt}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{fmt\_scientific}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Min"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Min"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q1"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q1"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Median"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Median"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q3"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q3"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Max"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Max"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\fontsize{12.0pt}{14.4pt}\selectfont
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lllrrrrrrrrrr}
\toprule
 &  &  & \multicolumn{2}{c}{Min} & \multicolumn{2}{c}{Q1} & \multicolumn{2}{c}{Median} & \multicolumn{2}{c}{Q3} & \multicolumn{2}{c}{Max} \\ 
\cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9} \cmidrule(lr){10-11} \cmidrule(lr){12-13}
Paper & Covariate & Unit & Min\_sim & Min\_true & Q1\_sim & Q1\_true & Median\_sim & Median\_true & Q3\_sim & Q3\_true & Max\_sim & Max\_true \\ 
\midrule\addlinespace[2.5pt]
Carlier\_2013 & ICU & Unitless & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\ 
Carlier\_2013 & BURN & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Carlier\_2013 & OBESE & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 0.00 \\ 
Carlier\_2013 & CRCL & mL/min & 1.18 $\times$ 10\textsuperscript{1} & 1.00 $\times$ 10\textsuperscript{1} & 6.68 $\times$ 10\textsuperscript{1} & 5.00 $\times$ 10\textsuperscript{1} & 1.15 $\times$ 10\textsuperscript{2} & 1.02 $\times$ 10\textsuperscript{2} & 1.64 $\times$ 10\textsuperscript{2} & 1.57 $\times$ 10\textsuperscript{2} & 3.64 $\times$ 10\textsuperscript{2} & NA \\ 
Carlier\_2013 & WT & kg & 5.89 $\times$ 10\textsuperscript{1} & NA & 7.02 $\times$ 10\textsuperscript{1} & 7.00 $\times$ 10\textsuperscript{1} & 7.47 $\times$ 10\textsuperscript{1} & 7.50 $\times$ 10\textsuperscript{1} & 7.98 $\times$ 10\textsuperscript{1} & 7.90 $\times$ 10\textsuperscript{1} & 1.01 $\times$ 10\textsuperscript{2} & NA \\ 
Carlier\_2013 & AGE & year & 2.84 $\times$ 10\textsuperscript{1} & NA & 5.38 $\times$ 10\textsuperscript{1} & 5.80 $\times$ 10\textsuperscript{1} & 6.30 $\times$ 10\textsuperscript{1} & 6.20 $\times$ 10\textsuperscript{1} & 7.00 $\times$ 10\textsuperscript{1} & 7.20 $\times$ 10\textsuperscript{1} & 9.82 $\times$ 10\textsuperscript{1} & NA \\ 
Carlier\_2013 & BMI & kg/m\textasciicircum{}\{2\} & 1.66 $\times$ 10\textsuperscript{1} & NA & 2.19 $\times$ 10\textsuperscript{1} & 2.10 $\times$ 10\textsuperscript{1} & 2.32 $\times$ 10\textsuperscript{1} & 2.40 $\times$ 10\textsuperscript{1} & 2.50 $\times$ 10\textsuperscript{1} & 2.50 $\times$ 10\textsuperscript{1} & 3.14 $\times$ 10\textsuperscript{1} & NA \\ 
\bottomrule
\end{tabular*}
\end{table}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{evaluate\_cov\_sim }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, q, cov\_name, cov\_unit, cov\_sim) \{}
  \CommentTok{\#\textquotesingle{} Plot simulated covariate distribution versus observed quantiles from the paper}
  \CommentTok{\#\textquotesingle{} @param p numeric vector of probabilities}
  \CommentTok{\#\textquotesingle{} @param q numeric vector of quantiles}
  \CommentTok{\#\textquotesingle{} @param cov\_name character string containing the covariate name}
  \CommentTok{\#\textquotesingle{} @param cov\_unit character string containing the unit of the covariate}
  \CommentTok{\#\textquotesingle{} @param cov\_sim tibble containing the simulated values for the covariate}
  \CommentTok{\#\textquotesingle{} @return ggplot2 showing the distributions of the simulated covariate and the observed covariate quantiles}
  
  
  \CommentTok{\#create a dataset with the true percentiles to be able to show them on the plot}
\NormalTok{  true\_percentiles }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(p, q) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{label =} \FunctionTok{case\_match}\NormalTok{(p, }
                              \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{"True min"}\NormalTok{,}
                              \FloatTok{0.25} \SpecialCharTok{\textasciitilde{}} \StringTok{"True Q1"}\NormalTok{,}
                              \FloatTok{0.5} \SpecialCharTok{\textasciitilde{}} \StringTok{"True median"}\NormalTok{,}
                              \FloatTok{0.75} \SpecialCharTok{\textasciitilde{}} \StringTok{"True Q3"}\NormalTok{,}
                              \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \StringTok{"True max"}\NormalTok{)) }
  
  \CommentTok{\#create a dataset with the percentiles of the fitted distributions to be able to show them on the plot}
\NormalTok{   sim\_percentiles }\OtherTok{\textless{}{-}}  \FunctionTok{tibble}\NormalTok{(}
    \AttributeTok{probability =}\NormalTok{ p,}
    \AttributeTok{q =} \FunctionTok{quantile}\NormalTok{(}\FunctionTok{pull}\NormalTok{(cov\_sim,cov\_name),p) }
\NormalTok{  ) }\SpecialCharTok{|\textgreater{}} 
        \FunctionTok{mutate}\NormalTok{(}\AttributeTok{label =} \FunctionTok{case\_match}\NormalTok{(probability, }
                              \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{"Sim min"}\NormalTok{,}
                              \FloatTok{0.25} \SpecialCharTok{\textasciitilde{}} \StringTok{"Sim Q1"}\NormalTok{,}
                              \FloatTok{0.5} \SpecialCharTok{\textasciitilde{}} \StringTok{"Sim median"}\NormalTok{,}
                              \FloatTok{0.75} \SpecialCharTok{\textasciitilde{}} \StringTok{"Sim Q3"}\NormalTok{,}
                              \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \StringTok{"Sim max"}\NormalTok{))}
   
\CommentTok{\# create an initial histogram in order to be able to extract statistics of the binned covariate}
\NormalTok{hist\_ini }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(cov\_sim, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ .data[[cov\_name]])) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins=}\DecValTok{15}\NormalTok{)}
   
\NormalTok{hist\_data }\OtherTok{\textless{}{-}} \FunctionTok{layer\_data}\NormalTok{(hist\_ini)}
   
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(hist\_data) }\SpecialCharTok{+}
  \FunctionTok{geom\_rect}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{xmin=}\NormalTok{xmin,}\AttributeTok{xmax=}\NormalTok{xmax, }\AttributeTok{ymin=}\DecValTok{0}\NormalTok{, }\AttributeTok{ymax=}\NormalTok{count),}
            \AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{data =}\NormalTok{ true\_percentiles,}
                \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ q,}\AttributeTok{color =} \StringTok{"True"}\NormalTok{),}
                \AttributeTok{lty =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sim\_percentiles,}
                \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ q,}\AttributeTok{color =} \StringTok{"Sim"}\NormalTok{),}
                \AttributeTok{lty =} \StringTok{"solid"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
     \FunctionTok{ylab}\NormalTok{(}\StringTok{"Count"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{xlab}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(cov\_name, }\StringTok{" ("}\NormalTok{, cov\_unit, }\StringTok{")"}\NormalTok{))  }\SpecialCharTok{+}

     \FunctionTok{geom\_text}\NormalTok{(}
       \AttributeTok{data =}\NormalTok{ true\_percentiles,}
       \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ q, }\AttributeTok{label =}\NormalTok{ label, }\AttributeTok{color =} \StringTok{"True"}\NormalTok{),}
       \AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{,}
       \AttributeTok{y =} \FloatTok{0.95}\SpecialCharTok{*}\FunctionTok{max}\NormalTok{(hist\_data}\SpecialCharTok{$}\NormalTok{ymax),}
       \AttributeTok{hjust =} \DecValTok{1}\NormalTok{,}
       \AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
       \AttributeTok{angle =} \DecValTok{90}
\NormalTok{     ) }\SpecialCharTok{+}
     \FunctionTok{geom\_text}\NormalTok{(}
       \AttributeTok{data =}\NormalTok{ sim\_percentiles,}
       \AttributeTok{mapping =} \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ q, }\AttributeTok{label =}\NormalTok{ label, }\AttributeTok{color =} \StringTok{"Sim"}\NormalTok{),}
       \AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{,}
       \AttributeTok{y =} \FloatTok{0.95}\SpecialCharTok{*}\FunctionTok{max}\NormalTok{(hist\_data}\SpecialCharTok{$}\NormalTok{ymax),}
       \AttributeTok{hjust =} \DecValTok{1}\NormalTok{,}
       \AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}
       \AttributeTok{angle =} \DecValTok{90}
\NormalTok{     ) }\SpecialCharTok{+}
     \FunctionTok{scale\_color\_brewer}\NormalTok{(}\AttributeTok{name =} \StringTok{"Quantiles"}\NormalTok{,}
                        \AttributeTok{palette =}\StringTok{"Dark2"}\NormalTok{)}
\NormalTok{   plot}
\NormalTok{\}}

\NormalTok{plot\_sim\_cov\_wrapper }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(cov\_data,cov\_name,cov\_sim)\{}
\NormalTok{  cov\_df }\OtherTok{\textless{}{-}} \FunctionTok{extract\_cov\_param}\NormalTok{(cov\_data, cov\_name)}

\FunctionTok{evaluate\_cov\_sim}\NormalTok{(cov\_df}\SpecialCharTok{$}\NormalTok{p,cov\_df}\SpecialCharTok{$}\NormalTok{q,cov\_df}\SpecialCharTok{$}\NormalTok{cov\_name,cov\_df}\SpecialCharTok{$}\NormalTok{cov\_unit,}
\NormalTok{                 cov\_sim)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_carlier,}\StringTok{"CRCL"}\NormalTok{,sim\_cov\_carlier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-carlier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_carlier,}\StringTok{"WT"}\NormalTok{,sim\_cov\_carlier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-carlier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_carlier,}\StringTok{"AGE"}\NormalTok{,sim\_cov\_carlier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-carlier-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_carlier,}\StringTok{"BMI"}\NormalTok{,sim\_cov\_carlier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-carlier-4.pdf}}

Then, based on BMI and WT, height (HT) is calculated to be able to
calculate the body surface area (BSA). CRCL was calculated using the
measured urinary equation, and as we have know information about the
urinary volume or urinary creatinine concentration, we cannot reconvert
CRCL to CREAT based on this equation. The most recommended equation is
CKD-EPI, however as different exponents are used based on the value of
CREAT, it can't be used for reconversion of CRCL to CREAT. Thus, the
second best equation, MDRD is used.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reconvert\_MDRD }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(AGE, CRCL, SEX) \{}
    \CommentTok{\# Mutliply by 0.742 for females}
\NormalTok{    sex\_factor }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.742}\NormalTok{)}
    
    \CommentTok{\# Calculate DFG}
\NormalTok{   CREAT }\OtherTok{\textless{}{-}}\NormalTok{ (CRCL }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{175} \SpecialCharTok{*}\NormalTok{ (AGE}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.203}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ sex\_factor))}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{/} \FloatTok{1.154}\NormalTok{)}
  
  \FunctionTok{return}\NormalTok{(CREAT)}
\NormalTok{\}}

\NormalTok{sim\_cov\_carlier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{BSA =}\NormalTok{ (WT}\SpecialCharTok{\^{}}\FloatTok{0.425} \SpecialCharTok{*}\NormalTok{ (HT}\SpecialCharTok{\^{}}\FloatTok{0.725}\NormalTok{) }\SpecialCharTok{*} \FloatTok{0.007184}\NormalTok{), }\CommentTok{\# Calculate body surface area based on Dubois\&Dubois formula}
    \AttributeTok{CRCL =}\NormalTok{ CRCL }\SpecialCharTok{*}\NormalTok{ (}\FloatTok{1.73} \SpecialCharTok{/}\NormalTok{BSA) }\CommentTok{\# convert mL/min to mL/min/1.73 m2}
\NormalTok{  )}
\NormalTok{sim\_cov\_carlier}\SpecialCharTok{$}\NormalTok{CREAT }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(reconvert\_MDRD, sim\_cov\_carlier}\SpecialCharTok{$}\NormalTok{AGE, sim\_cov\_carlier}\SpecialCharTok{$}\NormalTok{CRCL, sim\_cov\_carlier}\SpecialCharTok{$}\NormalTok{SEX)}
\NormalTok{sim\_cov\_carlier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Paper, ID\_within\_paper, ICU, BURN, OBESE, CREAT, WT, BSA, BMI, AGE, SEX, HT)}

\CommentTok{\# Calculate the simulated correlation matrices separately for the two sexes to compare with the original}
\NormalTok{sim\_cov\_carlier\_M }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{sim\_cov\_carlier\_F }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_carlier }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}

\NormalTok{cor\_sim\_M }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_carlier\_M }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
\NormalTok{cor\_sim\_F }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_carlier\_F }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}

\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Carlier\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Carlier original (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_carlier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Carlier simulated (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_carlier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Carlier\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Carlier original (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_carlier-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Carlier simulated (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_carlier-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot\_codistribution\_cov }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data,covariate\_x,covariate\_y)\{}
\NormalTok{data }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{any\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(covariate\_x,covariate\_y))) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{.data[[covariate\_x]],}
             \AttributeTok{y=}\NormalTok{.data[[covariate\_y]]))}\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{theme\_classic}\NormalTok{()}
\NormalTok{\}}

\FunctionTok{plot\_codistribution\_cov}\NormalTok{(sim\_cov\_carlier,}\AttributeTok{covariate\_x =} \StringTok{"WT"}\NormalTok{,}\AttributeTok{covariate\_y =} \StringTok{"CREAT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-codistribution-cov-carlier-1.pdf}}

\section{Fournier et al. (2018)}\label{fournier2018}

\section{General considerations about the
paper}\label{general-considerations-about-the-paper}

This study includes only 21 patients, thus deriving distributions from
the reported covariates values might be difficult

\subsection{Covariate distribution}\label{covariate-distribution-1}

All patients are ICU patients with burns who are assumed to be non
obese. Creatinine clearance is calculated based on the Cockcroft \&
Gault equation, whose output is in mL/min, so there is no need to
calculate BSA. Thus for all patients ICU = 1, BURN = 1 and OBESE=0.

It is not mentioned in the article if certain patients are on renal
replacement therapy, therefore we assume that they are not, and set the
minimum value of creatinine clearance to 10 mL/min. CRCL was estimated
using the Cockroft and Gault equation.

For AGE, not the median and IQR is given but the mean (50.1) and
standard deviation (24.3). As we cannot compare the simulated
distribution to the true one, so we suppose that the distribution
follows a normal distribution.

The proportion of males in the original article is 0.762.

Neither BMI nor HT or BSA are provided in the article, thus the height
is simulated based on the height obtained from the MIMIC clinical
dataset (normal distribution with mean of 169 and sd of 10.3).

For WT, AGE and CRCL here are the data from the paper :

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_data\_fournier }\OtherTok{\textless{}{-}}\NormalTok{ cov\_data }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Paper }\SpecialCharTok{==} \StringTok{"Fournier\_2018"}\NormalTok{)}

\NormalTok{cov\_data\_fournier }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Covariate }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{,}\StringTok{"CRCL"}\NormalTok{,}\StringTok{"AGE"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{kable}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllrrrrr@{}}
\toprule\noalign{}
Paper & Covariate & Unit & Median & Q1 & Q3 & Min & Max \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Fournier\_2018 & WT & kg & 72.4 & 67 & 83.6 & NA & NA \\
Fournier\_2018 & CRCL & mL/min & 128.0 & 65 & 150.0 & 10 & NA \\
Fournier\_2018 & AGE & year & 50.1 & NA & NA & NA & NA \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Fournier\_F }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Fournier\_F.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Fournier\_F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
              CREAT         AGE         WT     WT_log          HT      HT_log
CREAT    1.00000000  0.11092068  0.1240980  0.1236777 -0.01115272 -0.01163038
AGE      0.11092068  1.00000000 -0.1411092 -0.1377268 -0.21810675 -0.21757157
WT       0.12409798 -0.14110923  1.0000000  0.9910295  0.26291857  0.26261857
WT_log   0.12367767 -0.13772678  0.9910295  1.0000000  0.27210890  0.27214801
HT      -0.01115272 -0.21810675  0.2629186  0.2721089  1.00000000  0.99936169
HT_log  -0.01163038 -0.21757157  0.2626186  0.2721480  0.99936169  1.00000000
BMI      0.13219801 -0.06085883  0.9199729  0.9108563 -0.12595561 -0.12641807
CRCL_CG -0.57789581 -0.60548019  0.3271195  0.3230419  0.20870474  0.20811864
                BMI    CRCL_CG
CREAT    0.13219801 -0.5778958
AGE     -0.06085883 -0.6054802
WT       0.91997291  0.3271195
WT_log   0.91085635  0.3230419
HT      -0.12595561  0.2087047
HT_log  -0.12641807  0.2081186
BMI      1.00000000  0.2518084
CRCL_CG  0.25180837  1.0000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Fournier\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: female"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Fournier-cor-matrix-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Fournier\_M }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Fournier\_M.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Fournier\_M)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
              CREAT         AGE          WT      WT_log          HT      HT_log
CREAT    1.00000000  0.08421679  0.07887415  0.07757763 -0.01796103 -0.01782471
AGE      0.08421679  1.00000000 -0.11683417 -0.11039865 -0.13268497 -0.13114182
WT       0.07887415 -0.11683417  1.00000000  0.99316445  0.36730646  0.36578272
WT_log   0.07757763 -0.11039865  0.99316445  1.00000000  0.36989373  0.36884368
HT      -0.01796103 -0.13268497  0.36730646  0.36989373  1.00000000  0.99929302
HT_log  -0.01782471 -0.13114182  0.36578272  0.36884368  0.99929302  1.00000000
BMI      0.09421423 -0.05819520  0.87199105  0.86717872 -0.12604976 -0.12807159
CRCL_CG -0.60813562 -0.55803721  0.29302773  0.28921272  0.18756329  0.18568377
                BMI    CRCL_CG
CREAT    0.09421423 -0.6081356
AGE     -0.05819520 -0.5580372
WT       0.87199105  0.2930277
WT_log   0.86717872  0.2892127
HT      -0.12604976  0.1875633
HT_log  -0.12807159  0.1856838
BMI      1.00000000  0.2145950
CRCL_CG  0.21459503  1.0000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Fournier\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: male"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Fournier-cor-matrix-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fournier\_crcl }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_fournier,}
  \AttributeTok{cov\_name =} \StringTok{"CRCL"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{250}\NormalTok{,}
  \AttributeTok{tol=}\FloatTok{0.002}
\NormalTok{)}

\NormalTok{fournier\_crcl}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-fournier-crcl-1.pdf}}

Tolerance was increased to 0.002 to have a fit for log-normal. Normal
distribution is better suited.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fournier\_wt }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_fournier,}
  \AttributeTok{cov\_name =} \StringTok{"WT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{fournier\_wt}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-fournier-wt-1.pdf}}

In this case the log-normal distribution quantiles are closer to the
true quantiles than the normal ones. We will take the log-normal ones.

\subsection{Simulation of covariates}\label{simulation-of-covariates-1}

Covariates will be sampled from the following distributions :

\begin{itemize}
\tightlist
\item
  CRCL : Normal distribution with mean 117.016 mL/min and standard
  deviation 63.3 mL/min
\item
  WT : Lognormal distribution with mean 73.8 kg, and coefficient of
  variation 17 \%
\item
  AGE : Supposed normal distribution with mean of 50.1 years and
  standard deviation of 24.3
\end{itemize}

The proportion of males is 0.762 in the original article, so the number
of males is 476 and the number of females is 149 to add up to 625.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{correlated\_simulation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, means, cov\_matrix) \{}
  \FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\NormalTok{  collected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(means))}
  \FunctionTok{colnames}\NormalTok{(collected) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

  \ControlFlowTok{while}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(collected) }\SpecialCharTok{\textless{}}\NormalTok{ n) \{}
\NormalTok{    batch }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{mvrnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{mu =}\NormalTok{ means, }\AttributeTok{Sigma =}\NormalTok{ cov\_matrix)}
    \FunctionTok{colnames}\NormalTok{(batch) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

\NormalTok{    valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[, }\StringTok{"AGE"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{18} \SpecialCharTok{\&}
\NormalTok{             batch[, }\StringTok{"CRCL\_CG"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{10}

\NormalTok{    batch\_valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[valid, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{    collected }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(collected, batch\_valid)}
\NormalTok{  \}}

\NormalTok{  collected[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{\}}

\NormalTok{means }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_CG =}\NormalTok{ fournier\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ fournier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{],}
  \AttributeTok{AGE     =} \FloatTok{50.1}\NormalTok{,}
  \AttributeTok{HT\_log =} \FunctionTok{log}\NormalTok{(}\DecValTok{169}\NormalTok{)}
\NormalTok{)}

\NormalTok{sds }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_CG =}\NormalTok{ fournier\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ fournier\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{],}
  \AttributeTok{AGE     =} \FloatTok{24.3}\NormalTok{,}
  \AttributeTok{HT\_log =} \FunctionTok{log}\NormalTok{(}\FloatTok{10.3}\NormalTok{)}
\NormalTok{)}

\NormalTok{covariates }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CRCL\_CG"}\NormalTok{, }\StringTok{"WT\_log"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"HT\_log"}\NormalTok{)}

\FunctionTok{names}\NormalTok{(means) }\OtherTok{\textless{}{-}}\NormalTok{ covariates}

\CommentTok{\# Correlation and Covariance Matrix}
\NormalTok{cor\_fournier\_M }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Fournier\_M[covariates, covariates]}
\NormalTok{cov\_matrix\_M }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_fournier\_M }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_M)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4.214669e+03 3.869754e+02 5.248102e+00 2.300536e-02
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_fournier\_F }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Fournier\_F[covariates, covariates]}
\NormalTok{cov\_matrix\_F }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_fournier\_F }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_F)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 4.248590e+03 3.531696e+02 5.131612e+00 2.397672e-02
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Simulate}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{476}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_M)}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_M) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{0}\NormalTok{)}

\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{149}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_F)}
\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_F) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{1}\NormalTok{)}

\NormalTok{sim\_data }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sim\_data\_M, sim\_data\_F)}

\CommentTok{\# Put the covariates together}
\NormalTok{sim\_cov\_fournier }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{Paper =} \StringTok{"Fournier\_2018"}\NormalTok{,}
  \AttributeTok{ID\_within\_paper =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_patient,}
  \AttributeTok{ICU =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{BURN =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{OBESE =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{CRCL =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{CRCL\_CG,}
  \AttributeTok{WT\_log   =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{WT\_log,}
  \AttributeTok{AGE  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{AGE,}
  \AttributeTok{HT\_log  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{HT\_log,}
  \AttributeTok{SEX =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{SEX)}

\NormalTok{sim\_cov\_fournier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_fournier }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{WT =} \FunctionTok{exp}\NormalTok{(WT\_log),}
         \AttributeTok{HT =} \FunctionTok{exp}\NormalTok{(HT\_log))}

\NormalTok{summary\_sim\_cov\_fournier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_fournier }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(ICU,BURN,OBESE,CRCL,WT,AGE),}
               \AttributeTok{names\_to =} \StringTok{"Covariate"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{.by =} \FunctionTok{c}\NormalTok{(Covariate,Paper),}
            \AttributeTok{Min =} \FunctionTok{min}\NormalTok{(value),}
            \AttributeTok{Q1 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.25}\NormalTok{),}
            \AttributeTok{Median =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{Q3 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.75}\NormalTok{),}
            \AttributeTok{Max =} \FunctionTok{max}\NormalTok{(value))}

\FunctionTok{paste0}\NormalTok{(}\StringTok{"The proportion of males is "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{), }\DecValTok{3}\NormalTok{), }\StringTok{" compared to the original 0.762."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "The proportion of males is 0.762 compared to the original 0.762."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_fournier\_compare }\OtherTok{\textless{}{-}}\NormalTok{ summary\_sim\_cov\_fournier }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{rename\_with}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_sim"}\NormalTok{), }\SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{rename\_with}\NormalTok{(}
\NormalTok{    cov\_data\_fournier,}
    \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_true"}\NormalTok{),}
    \SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{, }\StringTok{"Unit"}\NormalTok{)}
\NormalTok{  )) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Covariate, }\AttributeTok{.after =}\NormalTok{ Paper) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Unit, }\AttributeTok{.after =}\NormalTok{ Covariate)}

\NormalTok{cov\_fournier\_compare }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{gt}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{fmt\_scientific}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Min"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Min"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q1"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q1"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Median"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Median"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q3"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q3"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Max"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Max"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\fontsize{12.0pt}{14.4pt}\selectfont
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lllrrrrrrrrrr}
\toprule
 &  &  & \multicolumn{2}{c}{Min} & \multicolumn{2}{c}{Q1} & \multicolumn{2}{c}{Median} & \multicolumn{2}{c}{Q3} & \multicolumn{2}{c}{Max} \\ 
\cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9} \cmidrule(lr){10-11} \cmidrule(lr){12-13}
Paper & Covariate & Unit & Min\_sim & Min\_true & Q1\_sim & Q1\_true & Median\_sim & Median\_true & Q3\_sim & Q3\_true & Max\_sim & Max\_true \\ 
\midrule\addlinespace[2.5pt]
Fournier\_2018 & ICU & Unitless & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\ 
Fournier\_2018 & BURN & Unitless & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\ 
Fournier\_2018 & OBESE & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Fournier\_2018 & CRCL & mL/min & 1.04 $\times$ 10\textsuperscript{1} & 1.00 $\times$ 10\textsuperscript{1} & 7.33 $\times$ 10\textsuperscript{1} & 6.50 $\times$ 10\textsuperscript{1} & 1.17 $\times$ 10\textsuperscript{2} & 1.28 $\times$ 10\textsuperscript{2} & 1.55 $\times$ 10\textsuperscript{2} & 1.50 $\times$ 10\textsuperscript{2} & 2.87 $\times$ 10\textsuperscript{2} & NA \\ 
Fournier\_2018 & WT & kg & 4.53 $\times$ 10\textsuperscript{1} & NA & 6.65 $\times$ 10\textsuperscript{1} & 6.70 $\times$ 10\textsuperscript{1} & 7.44 $\times$ 10\textsuperscript{1} & 7.24 $\times$ 10\textsuperscript{1} & 8.38 $\times$ 10\textsuperscript{1} & 8.36 $\times$ 10\textsuperscript{1} & 1.18 $\times$ 10\textsuperscript{2} & NA \\ 
Fournier\_2018 & AGE & year & 1.82 $\times$ 10\textsuperscript{1} & NA & 3.49 $\times$ 10\textsuperscript{1} & NA & 5.06 $\times$ 10\textsuperscript{1} & 5.01 $\times$ 10\textsuperscript{1} & 6.72 $\times$ 10\textsuperscript{1} & NA & 1.30 $\times$ 10\textsuperscript{2} & NA \\ 
\bottomrule
\end{tabular*}
\end{table}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_fournier,}\StringTok{"CRCL"}\NormalTok{,sim\_cov\_fournier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-fournier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_fournier,}\StringTok{"WT"}\NormalTok{,sim\_cov\_fournier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-fournier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_fournier,}\StringTok{"AGE"}\NormalTok{,sim\_cov\_fournier)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-fournier-3.pdf}}

Then, based on the BMI and WT, the height (HT) is calculated to be able
to calculate the body surface area (BSA). CRCL is reconverted to serum
creatinine (CREAT) based on the Cockroft and Gault equation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reconvert\_CG }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(AGE, CRCL, SEX, WT) \{}
    \CommentTok{\# Mutliply by 0.85 for females}
\NormalTok{    sex\_factor }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.85}\NormalTok{)}
    
    \CommentTok{\# Calculate DFG}
\NormalTok{    CREAT }\OtherTok{=}\NormalTok{ ((}\DecValTok{140} \SpecialCharTok{{-}}\NormalTok{ AGE) }\SpecialCharTok{*}\NormalTok{ WT }\SpecialCharTok{*}\NormalTok{ sex\_factor) }\SpecialCharTok{/}\NormalTok{ (CRCL }\SpecialCharTok{*} \DecValTok{72}\NormalTok{)}
  
  \FunctionTok{return}\NormalTok{(CREAT)}
\NormalTok{\}}

\NormalTok{sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{CREAT }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(reconvert\_CG, sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{AGE, sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{CRCL, sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{SEX, sim\_cov\_fournier}\SpecialCharTok{$}\NormalTok{WT)}
\NormalTok{sim\_cov\_fournier }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_fournier }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
     \AttributeTok{BSA =}\NormalTok{ (WT}\SpecialCharTok{\^{}}\FloatTok{0.425} \SpecialCharTok{*}\NormalTok{ (HT}\SpecialCharTok{\^{}}\FloatTok{0.725}\NormalTok{) }\SpecialCharTok{*} \FloatTok{0.007184}\NormalTok{),}
     \AttributeTok{BMI =}\NormalTok{ WT }\SpecialCharTok{/}\NormalTok{ (HT}\SpecialCharTok{/}\DecValTok{100}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
     \AttributeTok{OBESE =} \FunctionTok{ifelse}\NormalTok{(BMI }\SpecialCharTok{\textgreater{}} \DecValTok{30}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Paper, ID\_within\_paper, ICU, BURN, OBESE, CREAT, WT, BSA, BMI, AGE, SEX, HT)}
\CommentTok{\# Calculate the simulated correlation matrices separately for the two sexes to compare with the original}
\NormalTok{sim\_cov\_fournier\_M }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_fournier }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{sim\_cov\_fournier\_F }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_fournier }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}

\NormalTok{cor\_sim\_M }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_fournier\_M }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
\NormalTok{cor\_sim\_F }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_fournier\_F }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}

\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Fournier\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Fournier original (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_fournier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Fournier simulated (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_fournier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Fournier\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Fournier original (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_fournier-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Fournier simulated (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_fournier-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_codistribution\_cov}\NormalTok{(sim\_cov\_fournier,}\AttributeTok{covariate\_x =} \StringTok{"WT"}\NormalTok{,}\AttributeTok{covariate\_y =} \StringTok{"CREAT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-codistribution-cov-fournier-1.pdf}}

\section{Mellon et al. (2020)}\label{mellon2020}

\subsection{Covariate distribution}\label{covariate-distribution-2}

Patients are obese, but otherwise healthy, meaning that they are not in
intensive care and not burn victims. They are all obese (BMI
\textgreater{} 30 kg/m\^{}2). Creatinine clearance is calculated based
on the MDRD equation. Thus for all patients ICU = 0, BURN = 0, OBESE=1.

For WT, BMI and CRCL here are the data from the paper :

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_data\_mellon }\OtherTok{\textless{}{-}}\NormalTok{ cov\_data }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Paper }\SpecialCharTok{==} \StringTok{"Mellon\_2020"}\NormalTok{)}

\NormalTok{cov\_data\_mellon }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Covariate }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{,}\StringTok{"CRCL"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"BMI"}\NormalTok{, }\StringTok{"BMI\_log"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{kable}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1846}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1538}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.2615}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1077}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0462}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0462}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.0923}}
  >{\raggedleft\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1077}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Paper
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Covariate
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Unit
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
Median
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
Q1
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
Q3
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
Min
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
Max
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Mellon\_2020 & WT & kg & 109.3 & NA & NA & 88.00 & 151.50 \\
Mellon\_2020 & CRCL & mL/min/1.73m\^{}\{2\} & 94.0 & NA & NA & 62.00 &
133.00 \\
Mellon\_2020 & BMI & kg/m\^{}\{2\} & 40.6 & NA & NA & 35.20 & 67.30 \\
Mellon\_2020 & BMI\_log & kg/m\^{}\{2\} & 3.7 & NA & NA & 3.56 & 4.21 \\
Mellon\_2020 & CRCL & ml/min & NA & NA & NA & NA & NA \\
Mellon\_2020 & AGE & year & 51.7 & NA & NA & 22.90 & 62.90 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Mellon\_F }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Mellon\_F.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Mellon\_F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                      CREAT          AGE          WT       WT_log          HT
CREAT           1.000000000  0.022643469  0.03125540  0.031968067  0.05795702
AGE             0.022643469  1.000000000 -0.07488881 -0.077065515 -0.11168121
WT              0.031255400 -0.074888809  1.00000000  0.997431167  0.43988528
WT_log          0.031968067 -0.077065515  0.99743117  1.000000000  0.45364368
HT              0.057957020 -0.111681207  0.43988528  0.453643683  1.00000000
HT_log          0.057716460 -0.110775924  0.43501172  0.448949779  0.99935506
BMI            -0.006435320 -0.004011043  0.76869713  0.758978914 -0.23142245
BMI_log        -0.006781559 -0.004085614  0.77244329  0.765197692 -0.22615779
CRCL_MDRD_norm -0.936664533 -0.319596180 -0.00640208 -0.006556334 -0.02317188
                    HT_log          BMI      BMI_log CRCL_MDRD_norm
CREAT           0.05771646 -0.006435320 -0.006781559   -0.936664533
AGE            -0.11077592 -0.004011043 -0.004085614   -0.319596180
WT              0.43501172  0.768697132  0.772443287   -0.006402080
WT_log          0.44894978  0.758978914  0.765197692   -0.006556334
HT              0.99935506 -0.231422452 -0.226157792   -0.023171879
HT_log          1.00000000 -0.237225021 -0.231732528   -0.023241184
BMI            -0.23722502  1.000000000  0.997187131    0.009471973
BMI_log        -0.23173253  0.997187131  1.000000000    0.009607333
CRCL_MDRD_norm -0.02324118  0.009471973  0.009607333    1.000000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Mellon\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: female"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Mellon-cor-matrix-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Mellon\_M }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Mellon\_M.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Mellon\_M)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                      CREAT          AGE           WT       WT_log           HT
CREAT           1.000000000 -0.079420098 -0.005155970 -0.002021643  0.062039693
AGE            -0.079420098  1.000000000 -0.020403922 -0.018224696 -0.002835067
WT             -0.005155970 -0.020403922  1.000000000  0.997694029  0.617330996
WT_log         -0.002021643 -0.018224696  0.997694029  1.000000000  0.634363996
HT              0.062039693 -0.002835067  0.617330996  0.634363996  1.000000000
HT_log          0.061429587 -0.001756480  0.613093576  0.631018266  0.999227265
BMI            -0.070072797 -0.019345942  0.535836189  0.518641232 -0.328796339
BMI_log        -0.069673338 -0.020297428  0.545596150  0.528796578 -0.319827206
CRCL_MDRD_norm -0.940158336 -0.215895006  0.007018922  0.003387753 -0.059982333
                    HT_log         BMI     BMI_log CRCL_MDRD_norm
CREAT           0.06142959 -0.07007280 -0.06967334   -0.940158336
AGE            -0.00175648 -0.01934594 -0.02029743   -0.215895006
WT              0.61309358  0.53583619  0.54559615    0.007018922
WT_log          0.63101827  0.51864123  0.52879658    0.003387753
HT              0.99922726 -0.32879634 -0.31982721   -0.059982333
HT_log          1.00000000 -0.33401211 -0.32475168   -0.059647213
BMI            -0.33401211  1.00000000  0.99775044    0.069173500
BMI_log        -0.32475168  0.99775044  1.00000000    0.069388818
CRCL_MDRD_norm -0.05964721  0.06917350  0.06938882    1.000000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Mellon\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: male"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Mellon-cor-matrix-2.pdf}}

Mellon is different from the other papers as CRCL is given as
ml/min/1.73m\^{}\{2\} based on the MDRD equation, and instead of Q1 and
Q3, the minimum and maxiumum of the covariates is given (apart from
BMI). Another particularity is that due to the particularity of the
subjects (obesity), the distribution of body weight is positively
(right) skewed. Positively skewed distribution is relatively rare, so it
is not easy to find a distribution function to describe it. Beta
distribution needs scaling the data between 0 and 1. and 4 parameter
stable distribution et gamma distribution have several parameters that
need to be defined, and in the absence of the original data, it is not
possible to estimate these parameters.

The proportion of males is 0.148.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mellon\_crcl }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_mellon,}
  \AttributeTok{cov\_name =} \StringTok{"CRCL"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{250}
\NormalTok{)}

\NormalTok{mellon\_crcl}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-mellon-crcl-1.pdf}}

Similar fits; normal distribution is selected.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mellon\_wt }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_mellon,}
  \AttributeTok{cov\_name =} \StringTok{"WT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{170}
\NormalTok{)}

\NormalTok{mellon\_wt}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-mellon-wt-1.pdf}}

Log-normal distribution fits slightly better than normal.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mellon\_age }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_mellon,}
  \AttributeTok{cov\_name =} \StringTok{"AGE"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{mellon\_age}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-mellon-age-1.pdf}}

Normal distribution fits a bit better.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mellon\_bmi }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_mellon,}
  \AttributeTok{cov\_name =} \StringTok{"BMI"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{100}\NormalTok{, }
  \AttributeTok{tol =} \FloatTok{0.001}
\NormalTok{)}

\NormalTok{mellon\_bmi}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-mellon-bmi-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mellon\_bmi\_log }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_mellon,}
  \AttributeTok{cov\_name =} \StringTok{"BMI\_log"}\NormalTok{,}
  \AttributeTok{min\_plot =} \FloatTok{2.5}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{5}\NormalTok{, }
  \AttributeTok{tol =} \FloatTok{0.001}
\NormalTok{)}

\NormalTok{mellon\_bmi\_log}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-mellon-bmi-log-1.pdf}}

Log-normal distribution fits a bit better.

\subsection{Simulation of covariates}\label{simulation-of-covariates-2}

Covariates will be sampled from the following distributions :

\begin{itemize}
\tightlist
\item
  CRCL : Normal distribution from which negative values have been
  resampled, with mean 94 mL/min and standard deviation 14.3 mL/min
\item
  WT : Lognormal distribution with mean 109 kg, and coefficient of
  variation 9.41 \%
\item
  AGE : Normal distribution with mean \ensuremath{2.84\times 10^{22}}
  years, and standard deviation 4.81 \%
\item
  BMI : Lognormal distribution with mean 40.6 \(kg/m^{2}\), and
  coefficient of variation 6.14 \%
\end{itemize}

The proportion of males is 0.148 in the original article, so the number
of males is 93 and the number of females is 532 to add up to 625.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{correlated\_simulation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, means, cov\_matrix) \{}
  \FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\NormalTok{  collected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(means))}
  \FunctionTok{colnames}\NormalTok{(collected) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

  \ControlFlowTok{while}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(collected) }\SpecialCharTok{\textless{}}\NormalTok{ n) \{}
\NormalTok{    batch }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{mvrnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{mu =}\NormalTok{ means, }\AttributeTok{Sigma =}\NormalTok{ cov\_matrix)}
    \FunctionTok{colnames}\NormalTok{(batch) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

\NormalTok{    valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[, }\StringTok{"AGE"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{18} \SpecialCharTok{\&}
\NormalTok{             batch[, }\StringTok{"CRCL\_MDRD\_norm"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{10} \SpecialCharTok{\&}
\NormalTok{             batch[, }\StringTok{"BMI\_log"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \FloatTok{3.401197} \CommentTok{\# log(30)}

\NormalTok{    batch\_valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[valid, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{    collected }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(collected, batch\_valid)}
\NormalTok{  \}}

\NormalTok{  collected[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{\}}

\NormalTok{means }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_MDRD\_norm =}\NormalTok{ mellon\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ mellon\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{],}
  \AttributeTok{AGE     =}\NormalTok{ mellon\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{BMI\_log     =}\NormalTok{ mellon\_bmi}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{]}
\NormalTok{)}

\NormalTok{sds }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CRCL\_MDRD\_norm =}\NormalTok{ mellon\_crcl}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ mellon\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{], }
  \AttributeTok{AGE =}\NormalTok{ mellon\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{BMI\_log     =}\NormalTok{ mellon\_bmi}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{]}
\NormalTok{)}

\NormalTok{covariates }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CRCL\_MDRD\_norm"}\NormalTok{, }\StringTok{"WT\_log"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"BMI\_log"}\NormalTok{)}

\FunctionTok{names}\NormalTok{(means) }\OtherTok{\textless{}{-}}\NormalTok{ covariates}

\CommentTok{\# Correlation and Covariance Matrix}
\NormalTok{cor\_mellon\_M }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Mellon\_M[covariates, covariates]}
\NormalTok{cov\_matrix\_M }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_mellon\_M }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_M)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2.050769e+02 2.197051e+01 1.024041e-02 2.320348e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_mellon\_F }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Mellon\_F[covariates, covariates]}
\NormalTok{cov\_matrix\_F }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_mellon\_F }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_F)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 2.064991e+02 2.054837e+01 1.132511e-02 1.194553e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Simulate}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{93}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_M)}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_M) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{0}\NormalTok{)}

\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{532}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_F)}
\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_F) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{1}\NormalTok{)}

\NormalTok{sim\_data }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sim\_data\_M, sim\_data\_F)}

\CommentTok{\# Put the covariates together}
\NormalTok{sim\_cov\_mellon }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{Paper =} \StringTok{"Mellon\_2020"}\NormalTok{,}
  \AttributeTok{ID\_within\_paper =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_patient,}
  \AttributeTok{ICU =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{BURN =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{OBESE =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{CRCL =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{CRCL\_MDRD\_norm,}
  \AttributeTok{WT\_log   =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{WT\_log,}
  \AttributeTok{AGE  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{AGE,}
  \AttributeTok{BMI\_log  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{BMI\_log,}
  \AttributeTok{SEX =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{SEX)}

\NormalTok{sim\_cov\_mellon }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{WT =} \FunctionTok{exp}\NormalTok{(WT\_log),}
         \AttributeTok{BMI =} \FunctionTok{exp}\NormalTok{(BMI\_log))}

\NormalTok{summary\_sim\_cov\_mellon }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(ICU,BURN,OBESE,CRCL,WT,AGE),}
               \AttributeTok{names\_to =} \StringTok{"Covariate"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{.by =} \FunctionTok{c}\NormalTok{(Covariate,Paper),}
            \AttributeTok{Min =} \FunctionTok{min}\NormalTok{(value),}
            \AttributeTok{Q1 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.25}\NormalTok{),}
            \AttributeTok{Median =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{Q3 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.75}\NormalTok{),}
            \AttributeTok{Max =} \FunctionTok{max}\NormalTok{(value))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sim\_cov\_mellon }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Paper, ID\_within\_paper, ICU, BURN, OBESE, CRCL, WT, AGE, BMI, SEX)}

\NormalTok{cov\_mellon\_compare }\OtherTok{\textless{}{-}}\NormalTok{ summary\_sim\_cov\_mellon }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{rename\_with}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_sim"}\NormalTok{), }\SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{rename\_with}\NormalTok{(}
\NormalTok{    cov\_data\_mellon,}
    \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_true"}\NormalTok{),}
    \SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{, }\StringTok{"Unit"}\NormalTok{)}
\NormalTok{  )) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Covariate, }\AttributeTok{.after =}\NormalTok{ Paper) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Unit, }\AttributeTok{.after =}\NormalTok{ Covariate)}

\NormalTok{cov\_mellon\_compare }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{gt}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{fmt\_scientific}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Min"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Min"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q1"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q1"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Median"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Median"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q3"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q3"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Max"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Max"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\fontsize{12.0pt}{14.4pt}\selectfont
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lllrrrrrrrrrr}
\toprule
 &  &  & \multicolumn{2}{c}{Min} & \multicolumn{2}{c}{Q1} & \multicolumn{2}{c}{Median} & \multicolumn{2}{c}{Q3} & \multicolumn{2}{c}{Max} \\ 
\cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9} \cmidrule(lr){10-11} \cmidrule(lr){12-13}
Paper & Covariate & Unit & Min\_sim & Min\_true & Q1\_sim & Q1\_true & Median\_sim & Median\_true & Q3\_sim & Q3\_true & Max\_sim & Max\_true \\ 
\midrule\addlinespace[2.5pt]
Mellon\_2020 & ICU & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Mellon\_2020 & BURN & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Mellon\_2020 & OBESE & Unitless & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\ 
Mellon\_2020 & CRCL & mL/min/1.73m\textasciicircum{}\{2\} & 5.18 $\times$ 10\textsuperscript{1} & 6.20 $\times$ 10\textsuperscript{1} & 8.24 $\times$ 10\textsuperscript{1} & NA & 9.39 $\times$ 10\textsuperscript{1} & 9.40 $\times$ 10\textsuperscript{1} & 1.05 $\times$ 10\textsuperscript{2} & NA & 1.48 $\times$ 10\textsuperscript{2} & 1.33 $\times$ 10\textsuperscript{2} \\ 
Mellon\_2020 & CRCL & ml/min & 5.18 $\times$ 10\textsuperscript{1} & NA & 8.24 $\times$ 10\textsuperscript{1} & NA & 9.39 $\times$ 10\textsuperscript{1} & NA & 1.05 $\times$ 10\textsuperscript{2} & NA & 1.48 $\times$ 10\textsuperscript{2} & NA \\ 
Mellon\_2020 & WT & kg & 8.10 $\times$ 10\textsuperscript{1} & 8.80 $\times$ 10\textsuperscript{1} & 1.02 $\times$ 10\textsuperscript{2} & NA & 1.09 $\times$ 10\textsuperscript{2} & 1.09 $\times$ 10\textsuperscript{2} & 1.16 $\times$ 10\textsuperscript{2} & NA & 1.41 $\times$ 10\textsuperscript{2} & 1.51 $\times$ 10\textsuperscript{2} \\ 
Mellon\_2020 & AGE & year & 3.51 $\times$ 10\textsuperscript{1} & 2.29 $\times$ 10\textsuperscript{1} & 4.87 $\times$ 10\textsuperscript{1} & NA & 5.22 $\times$ 10\textsuperscript{1} & 5.17 $\times$ 10\textsuperscript{1} & 5.57 $\times$ 10\textsuperscript{1} & NA & 7.07 $\times$ 10\textsuperscript{1} & 6.29 $\times$ 10\textsuperscript{1} \\ 
\bottomrule
\end{tabular*}
\end{table}

Then, based on the BMI and WT, the height (HT) is calculated to be able
to calculate the body surface area (BSA). CRCL is reconverted to serum
creatinine (CREAT) based on the MDRD equation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reconvert\_MDRD }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(AGE, CRCL, SEX) \{}
    \CommentTok{\# Mutliply by 0.85 for females}
\NormalTok{    sex\_factor }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.742}\NormalTok{)}
    
    \CommentTok{\# Calculate DFG}
\NormalTok{   CREAT }\OtherTok{\textless{}{-}}\NormalTok{ (CRCL }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{175} \SpecialCharTok{*}\NormalTok{ (AGE}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.203}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ sex\_factor))}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1} \SpecialCharTok{/} \FloatTok{1.154}\NormalTok{)}
  
  \FunctionTok{return}\NormalTok{(CREAT)}
\NormalTok{\}}

\NormalTok{sim\_cov\_mellon}\SpecialCharTok{$}\NormalTok{CREAT }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(reconvert\_MDRD, sim\_cov\_mellon}\SpecialCharTok{$}\NormalTok{AGE, sim\_cov\_mellon}\SpecialCharTok{$}\NormalTok{CRCL, sim\_cov\_mellon}\SpecialCharTok{$}\NormalTok{SEX)}
\NormalTok{sim\_cov\_mellon }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
   \AttributeTok{HT =} \FunctionTok{sqrt}\NormalTok{(WT}\SpecialCharTok{/}\NormalTok{BMI) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\CommentTok{\# mutliplied by 100 to convert m to cm}
    \AttributeTok{BSA =}\NormalTok{ (WT}\SpecialCharTok{\^{}}\FloatTok{0.425} \SpecialCharTok{*}\NormalTok{ (HT}\SpecialCharTok{\^{}}\FloatTok{0.725}\NormalTok{) }\SpecialCharTok{*} \FloatTok{0.007184}\NormalTok{),}
    \AttributeTok{OBESE =} \FunctionTok{ifelse}\NormalTok{(BMI }\SpecialCharTok{\textgreater{}} \DecValTok{30}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Paper, ID\_within\_paper, ICU, BURN, OBESE, CREAT, WT, BSA, BMI, AGE, SEX, HT)}

\CommentTok{\# Calculate the simulated correlation matrices separately for the two sexes to compare with the original}
\NormalTok{sim\_cov\_mellon\_M }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{sim\_cov\_mellon\_F }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_mellon }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}

\NormalTok{cor\_sim\_M }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_mellon\_M }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
\NormalTok{cor\_sim\_F }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_mellon\_F }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}

\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Mellon\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Mellon original (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_mellon-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Mellon simulated (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_mellon-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Mellon\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Mellon original (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_mellon-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Mellon simulated (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_mellon-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_codistribution\_cov}\NormalTok{(sim\_cov\_mellon,}\AttributeTok{covariate\_x =} \StringTok{"WT"}\NormalTok{,}\AttributeTok{covariate\_y =} \StringTok{"CREAT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-codistribution-cov-mellon-1.pdf}}

\section{Rambaud et al. (2020)}\label{rambaud2020}

\subsection{Covariate distribution}\label{covariate-distribution-3}

All patients are ICU patients with endocarditis. They are not considered
to be burn victims or obese. Creatinine clearance was calculated using
the CKD-EPI equation. Thus for all patients ICU = 1, BURN = 0 and
OBESE=0. In this paper, the distribution of serum creatinine is given
(in micromol/L), so it can be directly simulated instead of reconverting
CRCL. The proportion of males is 0.794.

For WT and CRCL here are the data from the paper :

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_data\_rambaud }\OtherTok{\textless{}{-}}\NormalTok{ cov\_data }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Paper }\SpecialCharTok{==} \StringTok{"Rambaud\_2020"}\NormalTok{)}

\NormalTok{cov\_data\_rambaud }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(Covariate }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{,}\StringTok{"CREAT"}\NormalTok{,}\StringTok{"AGE"}\NormalTok{,}\StringTok{"HT"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{kable}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllrrrrr@{}}
\toprule\noalign{}
Paper & Covariate & Unit & Median & Q1 & Q3 & Min & Max \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Rambaud\_2020 & WT & kg & 76 & 69 & 87.0 & NA & NA \\
Rambaud\_2020 & HT & cm & 170 & 166 & 175.0 & NA & NA \\
Rambaud\_2020 & AGE & year & 72 & 62 & 80.5 & NA & NA \\
Rambaud\_2020 & CREAT & micromol/L & 87 & 73 & 115.5 & NA & NA \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Rambaud\_F }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Rambaud\_F.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Rambaud\_F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                     CREAT   CREAT_log        AGE         WT     WT_log
CREAT           1.00000000  0.96241769  0.2320510  0.1329905  0.1360852
CREAT_log       0.96241769  1.00000000  0.2429180  0.1521950  0.1565402
AGE             0.23205099  0.24291801  1.0000000 -0.1726236 -0.1683232
WT              0.13299046  0.15219495 -0.1726236  1.0000000  0.9894565
WT_log          0.13608520  0.15654017 -0.1683232  0.9894565  1.0000000
HT             -0.04892509 -0.04044581 -0.1889338  0.2517176  0.2592944
HT_log         -0.04916482 -0.04082750 -0.1894298  0.2520660  0.2599500
BMI             0.15464517  0.17128168 -0.1162404  0.9435277  0.9336719
CRCL_MDRD_norm -0.78792478 -0.91391033 -0.2872002 -0.1410118 -0.1466372
                        HT      HT_log        BMI CRCL_MDRD_norm
CREAT          -0.04892509 -0.04916482  0.1546452    -0.78792478
CREAT_log      -0.04044581 -0.04082750  0.1712817    -0.91391033
AGE            -0.18893375 -0.18942976 -0.1162404    -0.28720016
WT              0.25171756  0.25206601  0.9435277    -0.14101184
WT_log          0.25929441  0.25994996  0.9336719    -0.14663719
HT              1.00000000  0.99970438 -0.0747791     0.04109155
HT_log          0.99970438  1.00000000 -0.0742787     0.04153856
BMI            -0.07477910 -0.07427870  1.0000000    -0.15925725
CRCL_MDRD_norm  0.04109155  0.04153856 -0.1592572     1.00000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Rambaud\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: female"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Rambaud-cor-matrix-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_matrix\_Rambaud\_M }\OtherTok{\textless{}{-}} \FunctionTok{readRDS}\NormalTok{(}\StringTok{"cor\_matrix\_Rambaud\_M.rds"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(cor\_matrix\_Rambaud\_M)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                      CREAT     CREAT_log        AGE          WT      WT_log
CREAT           1.000000000  0.9686820232  0.1909639  0.09370644  0.09181062
CREAT_log       0.968682023  1.0000000000  0.1982311  0.12356685  0.12378068
AGE             0.190963871  0.1982311079  1.0000000 -0.18051719 -0.17233815
WT              0.093706437  0.1235668470 -0.1805172  1.00000000  0.99225399
WT_log          0.091810623  0.1237806818 -0.1723382  0.99225399  1.00000000
HT             -0.005710820  0.0007327162 -0.1229902  0.37551772  0.37978066
HT_log         -0.005537361  0.0010029509 -0.1228308  0.37500256  0.37967684
BMI             0.103837382  0.1331126943 -0.1347419  0.89436959  0.88815355
CRCL_MDRD_norm -0.769174641 -0.8857730397 -0.2449519 -0.12508733 -0.12881176
                          HT       HT_log         BMI CRCL_MDRD_norm
CREAT          -0.0057108200 -0.005537361  0.10383738   -0.769174641
CREAT_log       0.0007327162  0.001002951  0.13311269   -0.885773040
AGE            -0.1229902101 -0.122830828 -0.13474194   -0.244951935
WT              0.3755177211  0.375002564  0.89436959   -0.125087326
WT_log          0.3797806561  0.379676845  0.88815355   -0.128811758
HT              1.0000000000  0.999598212 -0.07118055   -0.003915605
HT_log          0.9995982117  1.000000000 -0.07162513   -0.004244813
BMI            -0.0711805452 -0.071625134  1.00000000   -0.133475436
CRCL_MDRD_norm -0.0039156049 -0.004244813 -0.13347544    1.000000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Rambaud\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Sex: male"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/Rambaud-cor-matrix-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rambaud\_creat }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_rambaud,}
  \AttributeTok{cov\_name =} \StringTok{"CREAT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{250}
\NormalTok{)}

\NormalTok{rambaud\_creat}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-rambaud-creat-1.pdf}}

Log-normal distribution fits the best the data, so it is selected.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rambaud\_wt }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_rambaud,}
  \AttributeTok{cov\_name =} \StringTok{"WT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{40}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{rambaud\_wt}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-rambaud-wt-1.pdf}}

No discernable difference between the two fits. The log-normal
distribution is selected.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rambaud\_age }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_rambaud,}
  \AttributeTok{cov\_name =} \StringTok{"AGE"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{120}
\NormalTok{)}

\NormalTok{rambaud\_age}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-rambaud-age-1.pdf}}

No discernable difference, so normal distribution is selected, as age
usually follows a normal distribution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rambaud\_ht }\OtherTok{\textless{}{-}} \FunctionTok{fit\_cov\_wrapper}\NormalTok{(}
  \AttributeTok{cov\_data =}\NormalTok{ cov\_data\_rambaud,}
  \AttributeTok{cov\_name =} \StringTok{"HT"}\NormalTok{,}
  \AttributeTok{min\_plot =} \DecValTok{140}\NormalTok{,}
  \AttributeTok{max\_plot =} \DecValTok{200}
\NormalTok{)}

\NormalTok{rambaud\_ht}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/fit-rambaud-ht-1.pdf}}

No discernable difference. Log-normal distribution is selected.

\subsection{Simulation of covariates}\label{simulation-of-covariates-3}

Covariates will be sampled from the following distributions :

\begin{itemize}
\tightlist
\item
  CREAT : Log-normal distribution with a minimum 10 micromol/L with mean
  89.7 micromol/L and standard deviation 0.346 micromol/L
\item
  WT : Normal distribution with resampling of negative values with mean
  76.8 kg, and standard deviation 17.3 \%
\item
  AGE : Normal distribution with resampling of negative values with mean
  \ensuremath{1.22\times 10^{31}} years, and coefficient of variation
  1370 \%
\item
  HT : Normal distribution with resampling of negative values with mean
  170 cm, and standard deviation 3.93 \%
\end{itemize}

The proportion of males is 0.794 in the original article, so the number
of males is 496 and the number of females is 129 to add up to 625.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{correlated\_simulation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, means, cov\_matrix) \{}
  \FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\NormalTok{  collected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(means))}
  \FunctionTok{colnames}\NormalTok{(collected) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

  \ControlFlowTok{while}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(collected) }\SpecialCharTok{\textless{}}\NormalTok{ n) \{}
\NormalTok{    batch }\OtherTok{\textless{}{-}}\NormalTok{ MASS}\SpecialCharTok{::}\FunctionTok{mvrnorm}\NormalTok{(}\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{mu =}\NormalTok{ means, }\AttributeTok{Sigma =}\NormalTok{ cov\_matrix)}
    \FunctionTok{colnames}\NormalTok{(batch) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(means)}

\NormalTok{    valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[, }\StringTok{"AGE"}\NormalTok{] }\SpecialCharTok{\textgreater{}=} \DecValTok{18} \SpecialCharTok{\&}
\NormalTok{             batch[, }\StringTok{"CREAT\_log"}\NormalTok{] }\SpecialCharTok{\textless{}} \FloatTok{5.991465} \CommentTok{\# log(400) corresponding to CRCL of 10 mL/min for a patient of 24 kg and 116 years}

\NormalTok{    batch\_valid }\OtherTok{\textless{}{-}}\NormalTok{ batch[valid, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{    collected }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(collected, batch\_valid)}
\NormalTok{  \}}

\NormalTok{  collected[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, , drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{\}}

\NormalTok{means }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CREAT\_log =}\NormalTok{ rambaud\_creat}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{],}
  \AttributeTok{WT\_log      =}\NormalTok{ rambaud\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{], }
  \AttributeTok{AGE     =}\NormalTok{ rambaud\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"mean"}\NormalTok{],}
  \AttributeTok{HT\_log      =}\NormalTok{ rambaud\_ht}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"meanlog"}\NormalTok{]}
\NormalTok{)}

\NormalTok{sds }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \AttributeTok{CREAT\_log =}\NormalTok{ rambaud\_creat}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{],}
  \AttributeTok{WT\_log     =}\NormalTok{ rambaud\_wt}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{],}
  \AttributeTok{AGE =}\NormalTok{ rambaud\_age}\SpecialCharTok{$}\NormalTok{norm\_par[}\StringTok{"sd"}\NormalTok{],}
  \AttributeTok{HT\_log     =}\NormalTok{ rambaud\_ht}\SpecialCharTok{$}\NormalTok{lnorm\_par[}\StringTok{"sdlog"}\NormalTok{]}
\NormalTok{)}

\NormalTok{covariates }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT\_log"}\NormalTok{, }\StringTok{"WT\_log"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"HT\_log"}\NormalTok{)}

\FunctionTok{names}\NormalTok{(means) }\OtherTok{\textless{}{-}}\NormalTok{ covariates}

\CommentTok{\# Correlation and Covariance Matrix}
\NormalTok{cor\_rambaud\_M }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Rambaud\_M[covariates, covariates]}
\NormalTok{cov\_matrix\_M }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_rambaud\_M }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_M)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.888441e+02 1.160604e-01 2.831560e-02 1.302147e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cor\_rambaud\_F }\OtherTok{\textless{}{-}}\NormalTok{ cor\_matrix\_Rambaud\_F[covariates, covariates]}
\NormalTok{cov\_matrix\_F }\OtherTok{\textless{}{-}} \FunctionTok{diag}\NormalTok{(sds) }\SpecialCharTok{\%*\%}\NormalTok{ cor\_rambaud\_F }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(sds)}
\FunctionTok{eigen}\NormalTok{(cov\_matrix\_F)}\SpecialCharTok{$}\NormalTok{values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] 1.888465e+02 1.143105e-01 2.761902e-02 1.396003e-03
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Simulate}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{496}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_M)}
\NormalTok{sim\_data\_M }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_M) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{0}\NormalTok{)}

\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{correlated\_simulation}\NormalTok{(}\AttributeTok{n =} \DecValTok{129}\NormalTok{, }\AttributeTok{means =}\NormalTok{ means, }\AttributeTok{cov\_matrix =}\NormalTok{ cov\_matrix\_F)}
\NormalTok{sim\_data\_F }\OtherTok{\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(sim\_data\_F) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{SEX =} \DecValTok{1}\NormalTok{)}

\NormalTok{sim\_data }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sim\_data\_M, sim\_data\_F)}

\CommentTok{\# Put the covariates together}
\NormalTok{sim\_cov\_rambaud }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
  \AttributeTok{Paper =} \StringTok{"Rambaud\_2020"}\NormalTok{,}
  \AttributeTok{ID\_within\_paper =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_patient,}
  \AttributeTok{ICU =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{BURN =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{OBESE =} \DecValTok{0}\NormalTok{,}
  \AttributeTok{CREAT\_log =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{CREAT\_log,}
  \AttributeTok{WT\_log   =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{WT\_log,}
  \AttributeTok{AGE  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{AGE,}
  \AttributeTok{HT\_log  =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{HT\_log,}
  \AttributeTok{SEX =}\NormalTok{ sim\_data}\SpecialCharTok{$}\NormalTok{SEX)}

\NormalTok{sim\_cov\_rambaud }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_rambaud }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CREAT =} \FunctionTok{exp}\NormalTok{(CREAT\_log),}
         \AttributeTok{HT =} \FunctionTok{exp}\NormalTok{(HT\_log),}
         \AttributeTok{WT =} \FunctionTok{exp}\NormalTok{(WT\_log))}

\NormalTok{summary\_sim\_cov\_rambaud }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_rambaud }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(ICU,BURN,OBESE,CREAT,WT,AGE,HT),}
               \AttributeTok{names\_to =} \StringTok{"Covariate"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{.by =} \FunctionTok{c}\NormalTok{(Covariate,Paper),}
            \AttributeTok{Min =} \FunctionTok{min}\NormalTok{(value),}
            \AttributeTok{Q1 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.25}\NormalTok{),}
            \AttributeTok{Median =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{Q3 =} \FunctionTok{quantile}\NormalTok{(value, }\FloatTok{0.75}\NormalTok{),}
            \AttributeTok{Max =} \FunctionTok{max}\NormalTok{(value))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_rambaud\_compare }\OtherTok{\textless{}{-}}\NormalTok{ summary\_sim\_cov\_rambaud }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{rename\_with}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_sim"}\NormalTok{), }\SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{rename\_with}\NormalTok{(}
\NormalTok{    cov\_data\_rambaud,}
    \SpecialCharTok{\textasciitilde{}} \FunctionTok{paste0}\NormalTok{(.x, }\StringTok{"\_true"}\NormalTok{),}
    \SpecialCharTok{{-}}\FunctionTok{one\_of}\NormalTok{(}\StringTok{"Covariate"}\NormalTok{, }\StringTok{"Paper"}\NormalTok{, }\StringTok{"Unit"}\NormalTok{)}
\NormalTok{  )) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Covariate, }\AttributeTok{.after =}\NormalTok{ Paper) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{relocate}\NormalTok{(Unit, }\AttributeTok{.after =}\NormalTok{ Covariate)}

\NormalTok{cov\_rambaud\_compare }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{gt}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{fmt\_scientific}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Min"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Min"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q1"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q1"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Median"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Median"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Q3"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Q3"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{tab\_spanner}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Max"}\NormalTok{),}
              \AttributeTok{label =} \StringTok{"Max"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\fontsize{12.0pt}{14.4pt}\selectfont
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}lllrrrrrrrrrr}
\toprule
 &  &  & \multicolumn{2}{c}{Min} & \multicolumn{2}{c}{Q1} & \multicolumn{2}{c}{Median} & \multicolumn{2}{c}{Q3} & \multicolumn{2}{c}{Max} \\ 
\cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9} \cmidrule(lr){10-11} \cmidrule(lr){12-13}
Paper & Covariate & Unit & Min\_sim & Min\_true & Q1\_sim & Q1\_true & Median\_sim & Median\_true & Q3\_sim & Q3\_true & Max\_sim & Max\_true \\ 
\midrule\addlinespace[2.5pt]
Rambaud\_2020 & ICU & Unitless & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\ 
Rambaud\_2020 & BURN & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Rambaud\_2020 & OBESE & Unitless & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 & 0.00 \\ 
Rambaud\_2020 & CREAT & micromol/L & 2.08 $\times$ 10\textsuperscript{1} & NA & 6.79 $\times$ 10\textsuperscript{1} & 7.30 $\times$ 10\textsuperscript{1} & 8.67 $\times$ 10\textsuperscript{1} & 8.70 $\times$ 10\textsuperscript{1} & 1.12 $\times$ 10\textsuperscript{2} & 1.15 $\times$ 10\textsuperscript{2} & 3.08 $\times$ 10\textsuperscript{2} & NA \\ 
Rambaud\_2020 & WT & kg & 4.13 $\times$ 10\textsuperscript{1} & NA & 6.75 $\times$ 10\textsuperscript{1} & 6.90 $\times$ 10\textsuperscript{1} & 7.65 $\times$ 10\textsuperscript{1} & 7.60 $\times$ 10\textsuperscript{1} & 8.64 $\times$ 10\textsuperscript{1} & 8.70 $\times$ 10\textsuperscript{1} & 1.21 $\times$ 10\textsuperscript{2} & NA \\ 
Rambaud\_2020 & AGE & year & 1.97 $\times$ 10\textsuperscript{1} & NA & 6.04 $\times$ 10\textsuperscript{1} & 6.20 $\times$ 10\textsuperscript{1} & 7.08 $\times$ 10\textsuperscript{1} & 7.20 $\times$ 10\textsuperscript{1} & 8.20 $\times$ 10\textsuperscript{1} & 8.05 $\times$ 10\textsuperscript{1} & 1.12 $\times$ 10\textsuperscript{2} & NA \\ 
Rambaud\_2020 & HT & cm & 1.50 $\times$ 10\textsuperscript{2} & NA & 1.64 $\times$ 10\textsuperscript{2} & 1.66 $\times$ 10\textsuperscript{2} & 1.69 $\times$ 10\textsuperscript{2} & 1.70 $\times$ 10\textsuperscript{2} & 1.75 $\times$ 10\textsuperscript{2} & 1.75 $\times$ 10\textsuperscript{2} & 1.96 $\times$ 10\textsuperscript{2} & NA \\ 
\bottomrule
\end{tabular*}
\end{table}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_rambaud,}\StringTok{"CREAT"}\NormalTok{,sim\_cov\_rambaud)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-rambaud-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_rambaud,}\StringTok{"WT"}\NormalTok{,sim\_cov\_rambaud)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-rambaud-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_rambaud,}\StringTok{"AGE"}\NormalTok{,sim\_cov\_rambaud)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-rambaud-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot\_sim\_cov\_wrapper}\NormalTok{(cov\_data\_rambaud,}\StringTok{"HT"}\NormalTok{,sim\_cov\_rambaud)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/plot-cov-rambaud-4.pdf}}

CREAT is converted from micromol/L to mg/dL.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sim\_cov\_rambaud }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_rambaud }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{BSA =}\NormalTok{ (WT}\SpecialCharTok{\^{}}\FloatTok{0.425} \SpecialCharTok{*}\NormalTok{ (HT}\SpecialCharTok{\^{}}\FloatTok{0.725}\NormalTok{) }\SpecialCharTok{*} \FloatTok{0.007184}\NormalTok{),}
    \AttributeTok{CREAT =}\NormalTok{ CREAT}\SpecialCharTok{/}\FloatTok{88.4}\NormalTok{,}
    \AttributeTok{BMI =}\NormalTok{ WT }\SpecialCharTok{/}\NormalTok{ (HT}\SpecialCharTok{/}\DecValTok{100}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{,}
    \AttributeTok{OBESE =} \FunctionTok{ifelse}\NormalTok{(BMI }\SpecialCharTok{\textgreater{}} \DecValTok{30}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Paper, ID\_within\_paper, ICU, BURN, OBESE, CREAT, WT, BSA, BMI, AGE, SEX, HT)}

\CommentTok{\# Calculate the simulated correlation matrices separately for the two sexes to compare with the original}
\NormalTok{sim\_cov\_rambaud\_M }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_rambaud }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{sim\_cov\_rambaud\_F }\OtherTok{\textless{}{-}}\NormalTok{ sim\_cov\_rambaud }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}

\NormalTok{cor\_sim\_M }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_rambaud\_M }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
\NormalTok{cor\_sim\_F }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(sim\_cov\_rambaud\_F }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, AGE, HT, BMI), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}

\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Rambaud\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Rambaud original (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_rambaud-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_F, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Rambaud simulated (females)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_rambaud-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_matrix\_Rambaud\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Rambaud original (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_rambaud-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim\_M, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{title =} \StringTok{"Rambaud simulated (males)"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/reconvert_creat_rambaud-4.pdf}}

\section{Final covariate table}\label{final-covariate-table}

Make the final covariate dataset with 2500 sets of covariates in a way
that in each 100 sets, we have 25-25 from each covariate's cohorte, as
later, each dosing regimen will be simulated for 100 sets of covariates,
and it is important that the 4 cohorts are equally represented.

Also, for the concentration simulation part, we have to know before
applying the models, if a patient needs a different regiment due to his
renal failure or not. That is why an additional IR column is added where
1 indicates a renal failure patient who needs a dose adjustement. For
Carlier, the MDRD equation is used, and for Fournier, the Cockroft and
Gault. For Mellon and Rambaud, all patients have 0 in the IR column, as
it is not explicited in the articles that a dose adjustement was applied
to renal failure patients.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Row{-}bind the datasets to have 25 subjects from each in a sample of 100}
\NormalTok{datasets }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(sim\_cov\_carlier, sim\_cov\_fournier, sim\_cov\_mellon, sim\_cov\_rambaud)}

\NormalTok{interleave\_rows }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(datasets, chunk\_size) \{}
\NormalTok{  n\_chunks }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(datasets[[}\DecValTok{1}\NormalTok{]]) }\SpecialCharTok{/}\NormalTok{ chunk\_size}
\NormalTok{  interleaved }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_chunks, }\ControlFlowTok{function}\NormalTok{(i) \{}
    \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(datasets, }\ControlFlowTok{function}\NormalTok{(dataset) \{}
\NormalTok{      dataset[((i }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ chunk\_size }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\NormalTok{(i }\SpecialCharTok{*}\NormalTok{ chunk\_size), ]}
\NormalTok{    \}))}
\NormalTok{  \}))}
  \FunctionTok{return}\NormalTok{(interleaved)}
\NormalTok{\}}

\NormalTok{COV }\OtherTok{\textless{}{-}} \FunctionTok{interleave\_rows}\NormalTok{(datasets, }\AttributeTok{chunk\_size =} \DecValTok{25}\NormalTok{)}

\CommentTok{\# Convert Paper column to MODEL\_COHORT column which indicates the model that is used to simulated the covariates}
\NormalTok{COV }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{MODEL\_COHORT =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Paper }\SpecialCharTok{==} \StringTok{"Carlier\_2013"} \SpecialCharTok{\textasciitilde{}} \StringTok{"CARLIER"}\NormalTok{,}
\NormalTok{    Paper }\SpecialCharTok{==} \StringTok{"Fournier\_2018"} \SpecialCharTok{\textasciitilde{}} \StringTok{"FOURNIER"}\NormalTok{,}
\NormalTok{    Paper }\SpecialCharTok{==} \StringTok{"Mellon\_2020"} \SpecialCharTok{\textasciitilde{}} \StringTok{"MELLON"}\NormalTok{,}
\NormalTok{    Paper }\SpecialCharTok{==} \StringTok{"Rambaud\_2020"} \SpecialCharTok{\textasciitilde{}} \StringTok{"RAMBAUD"}\NormalTok{)}
\NormalTok{  )}

\CommentTok{\# Adding ID}
\NormalTok{COV}\SpecialCharTok{$}\NormalTok{ID }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2500}\NormalTok{)}

\CommentTok{\# CRCL calculation functions}
\NormalTok{calculate\_MDRD }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(AGE, CREAT, SEX) \{}
  \CommentTok{\# Mutliply by 0.742 for females}
\NormalTok{    sex\_factor }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.742}\NormalTok{)}
\NormalTok{    eGFR }\OtherTok{\textless{}{-}} \DecValTok{175} \SpecialCharTok{*}\NormalTok{ (CREAT}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.154}\NormalTok{)) }\SpecialCharTok{*}\NormalTok{ AGE}\SpecialCharTok{\^{}}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.203}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ sex\_factor}
    \FunctionTok{return}\NormalTok{(eGFR)}
\NormalTok{\}}

\NormalTok{calculate\_CG }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(AGE, CREAT, SEX, WT) \{}
\NormalTok{  sex\_factor }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(SEX }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.85}\NormalTok{)}
\NormalTok{  eGFR }\OtherTok{\textless{}{-}}\NormalTok{ ((}\DecValTok{140} \SpecialCharTok{{-}}\NormalTok{ AGE) }\SpecialCharTok{*}\NormalTok{ WT }\SpecialCharTok{*}\NormalTok{ sex\_factor) }\SpecialCharTok{/}\NormalTok{ (CREAT }\SpecialCharTok{*} \DecValTok{72}\NormalTok{)}
  \FunctionTok{return}\NormalTok{(eGFR)}
\NormalTok{\}}

\CommentTok{\# Add 1 for dose adjustement for CRCL \textless{} 30 mL/min for Carlier and Fournier}
\NormalTok{COV }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rowwise}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CRCL =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      MODEL\_COHORT }\SpecialCharTok{==} \StringTok{"CARLIER"} \SpecialCharTok{\textasciitilde{}} \FunctionTok{calculate\_MDRD}\NormalTok{(AGE, CREAT, SEX) }\SpecialCharTok{*}\NormalTok{ (BSA }\SpecialCharTok{/} \FloatTok{1.73}\NormalTok{),}
\NormalTok{      MODEL\_COHORT }\SpecialCharTok{==} \StringTok{"FOURNIER"} \SpecialCharTok{\textasciitilde{}} \FunctionTok{calculate\_CG}\NormalTok{(AGE, CREAT, SEX, WT),}
      \ConstantTok{TRUE} \SpecialCharTok{\textasciitilde{}} \ConstantTok{NA\_real\_}
\NormalTok{    ),}
    \AttributeTok{IR =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      MODEL\_COHORT }\SpecialCharTok{==} \StringTok{"CARLIER"} \SpecialCharTok{\&}\NormalTok{ CRCL }\SpecialCharTok{\textless{}} \DecValTok{30} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
\NormalTok{      MODEL\_COHORT }\SpecialCharTok{==} \StringTok{"FOURNIER"} \SpecialCharTok{\&}\NormalTok{ CRCL }\SpecialCharTok{\textless{}} \DecValTok{30} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{,}
\NormalTok{      MODEL\_COHORT }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"MELLON"}\NormalTok{, }\StringTok{"RAMBAUD"}\NormalTok{) }\SpecialCharTok{\textasciitilde{}} \DecValTok{0}\NormalTok{,}
      \ConstantTok{TRUE} \SpecialCharTok{\textasciitilde{}} \DecValTok{0}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\NormalTok{COV }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(ID, MODEL\_COHORT, WT, CREAT, BURN, ICU, OBESE, BSA, AGE, SEX, HT, IR)}

\CommentTok{\# Export to csv}
\FunctionTok{write.csv}\NormalTok{(COV, }\StringTok{"COV.csv"}\NormalTok{, }\AttributeTok{quote =}\NormalTok{ F, }\AttributeTok{row.names =}\NormalTok{ F)}

\CommentTok{\# Check correlation (Pearson)}
\NormalTok{cor\_sim }\OtherTok{\textless{}{-}} \FunctionTok{cor}\NormalTok{(COV }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(WT, CREAT, BURN, ICU, OBESE, AGE, SEX, HT), }\AttributeTok{use =} \StringTok{"complete.obs"}\NormalTok{)}
\FunctionTok{ggcorrplot}\NormalTok{(cor\_sim, }\AttributeTok{lab =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{covariate_simulation_files/figure-pdf/final_table-1.pdf}}

\bookmarksetup{startatroot}

\chapter{Simulation of concentrations and secondary PK
parameters}\label{simulation-of-concentrations-and-secondary-pk-parameters}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(mrgsolve)}
\FunctionTok{library}\NormalTok{(here)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(mapbayr)}
\FunctionTok{library}\NormalTok{(MESS)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(patchwork) }\CommentTok{\# To put different plots on the same grid}
\FunctionTok{library}\NormalTok{(tableone)}
\FunctionTok{library}\NormalTok{(knitr)}
\end{Highlighting}
\end{Shaded}

The objective is to simulate concentrations and secondary PK parameters
(Cmax, Cmin \& AUC) using the 3 validated PopPK models for amoxicilline.
The 4 papers are:

\begin{itemize}
\item
  Carlier et al. (2013)
\item
  Fournier et al. (2018)
\item
  Mellon et al. (2020)
\item
  Rambaud et al. (2020)
\end{itemize}

The original Rambaud model was non-parametric which was approximated
using a parametric model (details in
``quarto/Rambaud\_validation.html'').

The only route of administration is intraveinous infusion.

Three types of infusion are simulated:

\begin{itemize}
\item
  intermittent (duration = 0.5 h),
\item
  extended (1-2 hours),
\item
  continuous .
\end{itemize}

There are 8 different dosing schemes. For each model cohort the
corresponding dosing scheme is used for simulation that was in the
original article. For patients with renal failure (CRCL \textless{} 30
mL/min), a different dosing shceme is applied if it is explicited in the
articles (i. e. Carlier, Fournier). For Mellon, there was a single
administration in the original model, so administration frequency is set
to 24 h. ID means a set of covariate, not a subject (to make data
manipulation easier later).

144 observations are simulated for each subject to have a sufficient
number of observations after the first dose, as well as during a
steady-state interdose interval. Observations are simulated for the
period between the first and second doses and for the same duration for
the first interdose intervale that is entirely in steady-state. The
number of observations has been determined to have at least three
observations during the first interdose interval for all dosing schemes.
For example, in the case of an intermittent infusion of 0.5 g q6h, there
is an observation in each 5 minutes between 0 and 6 h \& between 24 h
and 30 h (if steady-state is reached at 22 h). This means, that not only
the dosing grid changes for each dosing scheme, but the observation grid
as well.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Import or generate the file with the covariates (COV)}
\NormalTok{COV }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"COV.csv"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

First, the dataset needs to be created with all the information that
mrgsolve needs for the simulation. In the function create\_dosing\_data,
the input data is created for all the lines that contain an administered
dose.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Function to create dosing grid (lines where there is an administered dose)}
\NormalTok{create\_dosing\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id\_range, amt, ii, rate, cmt, time\_seq) \{}
\NormalTok{  COV1 }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(ID }\SpecialCharTok{\%in\%}\NormalTok{ id\_range)}
  
\NormalTok{  ID }\OtherTok{\textless{}{-}}\NormalTok{ id\_range            }\CommentTok{\# ID range for the regimen}
  
  \CommentTok{\# Create base dosing data}
\NormalTok{  dosing\_data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{ID =}\NormalTok{ ID,}
    \AttributeTok{amt =} \FunctionTok{rep}\NormalTok{(amt, }\FunctionTok{length}\NormalTok{(ID)),   }\CommentTok{\# Dose amount in mg}
    \AttributeTok{ii =} \FunctionTok{rep}\NormalTok{(ii, }\FunctionTok{length}\NormalTok{(ID)),     }\CommentTok{\# Interdose interval in h}
    \AttributeTok{rate =} \FunctionTok{rep}\NormalTok{(rate, }\FunctionTok{length}\NormalTok{(ID)), }\CommentTok{\# Infusion rate}
    \AttributeTok{evid =} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(ID)),    }\CommentTok{\# EVID}
    \AttributeTok{cmt =}\NormalTok{ cmt                     }\CommentTok{\# Compartment}
\NormalTok{  )}
  
  \CommentTok{\# Add covariates from COV.csv}
\NormalTok{  dosing\_data }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(dosing\_data, COV1[, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(COV1), }\StringTok{"ID"}\NormalTok{)])}
  
  \CommentTok{\# Repeat dosing data for all time points}
\NormalTok{  dosing\_repeated }\OtherTok{\textless{}{-}}\NormalTok{ dosing\_data[}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dosing\_data), }\AttributeTok{each =} \FunctionTok{length}\NormalTok{(time\_seq)), ]}
\NormalTok{  time }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(time\_seq, }\AttributeTok{times =} \FunctionTok{length}\NormalTok{(ID))}
  
  \CommentTok{\# Combine with time}
\NormalTok{  final\_dosing\_data }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(dosing\_repeated, time)}
  \FunctionTok{return}\NormalTok{(final\_dosing\_data)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Then, the information is created for all the lines, that do not contain
a dose, but an observation. The latest possible time is 72 h, as
amoxicillin has a short half life and all subjects have had a complete
steady-state dosing interval by then.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Function to create observation grid (lines with concentration measurement)}
\NormalTok{create\_observation\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id\_range, obs\_length) \{}
\NormalTok{  COV1 }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(ID }\SpecialCharTok{\%in\%}\NormalTok{ id\_range)}
 \CommentTok{\# Extract covariates for the specified range}
\NormalTok{  ID }\OtherTok{\textless{}{-}}\NormalTok{ id\_range            }\CommentTok{\# ID range for the regimen}
  
  \CommentTok{\# Create base observation data (as these are lines with concentrations, AMT, II, RATE and EVID are always 0)}
\NormalTok{  obs\_data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{ID =}\NormalTok{ ID,                     }\CommentTok{\# ID meaning a set of covariates}
    \AttributeTok{amt =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(ID)),    }\CommentTok{\# Dose amount in mg}
    \AttributeTok{ii =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(ID)),     }\CommentTok{\# Interdose interval in h}
    \AttributeTok{rate =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(ID)),   }\CommentTok{\# Infusion rate}
    \AttributeTok{evid =} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(ID)),   }\CommentTok{\# EVID}
    \AttributeTok{cmt =} \StringTok{"CENTRAL"}              \CommentTok{\# Central compartment}
\NormalTok{  )}
  
  \CommentTok{\# Add covariates}
\NormalTok{  obs\_data }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(obs\_data, COV1[, }\FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(COV1), }\StringTok{"ID"}\NormalTok{)])}
  
  \CommentTok{\# Repeat observation data for all observation times}
\NormalTok{  obs\_repeated }\OtherTok{\textless{}{-}}\NormalTok{ obs\_data[}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(obs\_data), }\AttributeTok{each =}\NormalTok{ obs\_length), ]}
\NormalTok{  time }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\AttributeTok{from =} \DecValTok{0}\NormalTok{, }\AttributeTok{to =} \DecValTok{72}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ obs\_length), }\AttributeTok{times =} \FunctionTok{length}\NormalTok{(ID))   }\CommentTok{\# Latest possible time is 72 h as amoxicillin has a short half life}
  
  \CommentTok{\# Combine with time}
\NormalTok{  final\_obs\_data }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(obs\_repeated, time)}
  \FunctionTok{return}\NormalTok{(final\_obs\_data)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

To remove outliers, the non-physiological PK parameter values are
resimulated (at the most 100 times per value) using the \emph{simeta}
function of mrgsolve. A central volume of distribution smaller than 3 L
(the volume of plasma) and a clearance higher than 180 L/h (normal blood
flow) is considered non-physiological. (However, the maximum simulated
clearance is around 100 L/h, so its resimulation is unnecessary.)\\

Simulations are done using the mrgsolve models in .cpp format. To find
the interdose interval which is entirely in steady-state, first, the
time to reach steady state (TSS) has to be calculated. \[
t_{1/2} = \frac{\ln(2) \cdot V}{CL}
\] We can consider that steady state is reached when the concentration
is 90 \% of the steady state concentration, which corresponds to a time
of 3.3 times the half life ( as \(1 - e^{(-k_e \cdot t)} = 0.9\) ).

First, concentrations are simulated for all data points between 0 and 72
h, then the results are filtered to choose the first interdose interval
and the first interdose interval entirely in steady-state.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Function to simulate based on mrgsolve models}
\NormalTok{simulate\_mrgsim }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(sim\_final, Mellon, interval) \{ }\CommentTok{\# Mellon is used here as a synonyme for model}
\NormalTok{  sim\_results }\OtherTok{\textless{}{-}} \FunctionTok{mrgsim}\NormalTok{(Mellon, sim\_final) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.data.frame}\NormalTok{()}
  
  \FunctionTok{return}\NormalTok{(sim\_results)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Then, the filtered dataset, and the covariates will be put together, and
the observation and dosing grids will be simulated based on the
functions defined earlier. The dosing scheme is added as three columns
(DOSE, FREQuence, DURation). Each model control stream is used two times
for each simulation. Once, to simulate IPRED and Y (and
\(Cmax_{\text{ind}}\), \(Cmin_{\text{ind}}\) and \(AUC_{\text{ind}}\)
which are base on IPRED), then a second time, the omega matrice is set
to to simulate PRED (and CMAX\_PRED and AUC\_PRED based on PRED). PRED
are typical concentrations which do not contain inter-individual
variability. IPRED has inter-individual variability incorporated, and Y
has both inter-and intra-individual variability.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Function to merge covariates and finalize}
\NormalTok{finalize\_results }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(sim\_results, id\_range, model, dose, freq, dur) \{}
\NormalTok{  COV1 }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(ID }\SpecialCharTok{\%in\%}\NormalTok{ id\_range)}
  
  \CommentTok{\# Merge with simulation results}
\NormalTok{  result }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(sim\_results, COV1, }\AttributeTok{by =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{)}
  
\NormalTok{  result }\OtherTok{\textless{}{-}}\NormalTok{ result }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{MODEL =}\NormalTok{ model, }\AttributeTok{DOSE\_ADM =}\NormalTok{ dose, }\AttributeTok{FREQ =}\NormalTok{ freq, }\AttributeTok{DUR =}\NormalTok{ dur) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{distinct}\NormalTok{(ID, }\AttributeTok{TIME =}\NormalTok{ time, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
  
  \FunctionTok{return}\NormalTok{(result)}
\NormalTok{\}}

\NormalTok{generate\_model\_regimen }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(model\_name, cpp\_file, cpp\_file\_zero, regimens, sim\_dur) \{}
\NormalTok{  model }\OtherTok{\textless{}{-}} \FunctionTok{mread}\NormalTok{(}\AttributeTok{model =}\NormalTok{ cpp\_file)}
\NormalTok{  model\_zero }\OtherTok{\textless{}{-}} \FunctionTok{zero\_re}\NormalTok{(model)}
\NormalTok{  COV }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"COV.csv"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}

\NormalTok{  regimen\_assignments }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}

  \ControlFlowTok{for}\NormalTok{ (cohort\_name }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(COV}\SpecialCharTok{$}\NormalTok{MODEL\_COHORT)) \{}
\NormalTok{    cohort\_cov }\OtherTok{\textless{}{-}}\NormalTok{ COV }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(MODEL\_COHORT }\SpecialCharTok{==}\NormalTok{ cohort\_name)}
\NormalTok{    cohort\_regimens }\OtherTok{\textless{}{-}}\NormalTok{ regimens[}\FunctionTok{sapply}\NormalTok{(regimens, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{model\_cohort }\SpecialCharTok{==}\NormalTok{ cohort\_name)]}

    \ControlFlowTok{for}\NormalTok{ (ir\_value }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(cohort\_cov}\SpecialCharTok{$}\NormalTok{IR)) \{}
\NormalTok{      eligible\_ids }\OtherTok{\textless{}{-}}\NormalTok{ cohort\_cov }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{filter}\NormalTok{(IR }\SpecialCharTok{==}\NormalTok{ ir\_value) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(ID)}

\NormalTok{      matched\_regimens }\OtherTok{\textless{}{-}}\NormalTok{ cohort\_regimens[}\FunctionTok{seq\_along}\NormalTok{(cohort\_regimens) }\SpecialCharTok{\%\%} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(cohort\_cov}\SpecialCharTok{$}\NormalTok{IR)) }\SpecialCharTok{==}\NormalTok{ ir\_value]}

      \CommentTok{\# Distribute eligible subjects evenly across relevant dosing regimens}
\NormalTok{      id\_splits }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(eligible\_ids, }\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(matched\_regimens), }\AttributeTok{length.out =} \FunctionTok{length}\NormalTok{(eligible\_ids)))}

      \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq\_along}\NormalTok{(matched\_regimens)) \{}
\NormalTok{        matched\_regimens[[i]]}\SpecialCharTok{$}\NormalTok{assigned\_ids }\OtherTok{\textless{}{-}}\NormalTok{ id\_splits[[i]]}
\NormalTok{        regimen\_assignments }\OtherTok{\textless{}{-}} \FunctionTok{append}\NormalTok{(regimen\_assignments, }\FunctionTok{list}\NormalTok{(matched\_regimens[[i]]))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}

  \CommentTok{\# Simulate for the assigned regimens}
\NormalTok{  regimen\_results }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{ (regimen }\ControlFlowTok{in}\NormalTok{ regimen\_assignments) \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(regimen}\SpecialCharTok{$}\NormalTok{assigned\_ids) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\ControlFlowTok{next}

\NormalTok{    dose }\OtherTok{\textless{}{-}}\NormalTok{ regimen}\SpecialCharTok{$}\NormalTok{dose}
\NormalTok{    interval }\OtherTok{\textless{}{-}}\NormalTok{ regimen}\SpecialCharTok{$}\NormalTok{interval}
\NormalTok{    duration }\OtherTok{\textless{}{-}}\NormalTok{ regimen}\SpecialCharTok{$}\NormalTok{duration}
\NormalTok{    id\_range }\OtherTok{\textless{}{-}}\NormalTok{ regimen}\SpecialCharTok{$}\NormalTok{assigned\_ids}

\NormalTok{    dosing\_times }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, sim\_dur }\SpecialCharTok{{-}}\NormalTok{ interval, }\AttributeTok{by =}\NormalTok{ interval)}
\NormalTok{    obs\_length }\OtherTok{\textless{}{-}}\NormalTok{ (sim\_dur }\SpecialCharTok{/}\NormalTok{ interval) }\SpecialCharTok{*}\NormalTok{ sim\_dur }\SpecialCharTok{+} \DecValTok{1}

\NormalTok{    dose\_data }\OtherTok{\textless{}{-}} \FunctionTok{create\_dosing\_data}\NormalTok{(}
      \AttributeTok{id\_range =}\NormalTok{ id\_range,}
      \AttributeTok{amt =}\NormalTok{ dose,}
      \AttributeTok{ii =}\NormalTok{ interval,}
      \AttributeTok{rate =}\NormalTok{ dose }\SpecialCharTok{/}\NormalTok{ duration,}
      \AttributeTok{cmt =} \StringTok{"CENTRAL"}\NormalTok{,}
      \AttributeTok{time\_seq =}\NormalTok{ dosing\_times}
\NormalTok{    )}

\NormalTok{    obs\_data }\OtherTok{\textless{}{-}} \FunctionTok{create\_observation\_data}\NormalTok{(}\AttributeTok{id\_range =}\NormalTok{ id\_range, }\AttributeTok{obs\_length =}\NormalTok{ obs\_length)}
\NormalTok{    sim\_data }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(dose\_data, obs\_data) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{arrange}\NormalTok{(ID, time, }\FunctionTok{desc}\NormalTok{(evid))}

\NormalTok{    processed\_data }\OtherTok{\textless{}{-}} \FunctionTok{simulate\_mrgsim}\NormalTok{(sim\_data, model, interval)}
\NormalTok{    processed\_data\_zero }\OtherTok{\textless{}{-}} \FunctionTok{simulate\_mrgsim}\NormalTok{(sim\_data, model\_zero, interval)}

\NormalTok{    finalized\_data }\OtherTok{\textless{}{-}} \FunctionTok{finalize\_results}\NormalTok{(}
      \AttributeTok{sim\_results =}\NormalTok{ processed\_data,}
      \AttributeTok{id\_range =}\NormalTok{ id\_range,}
      \AttributeTok{model =}\NormalTok{ model\_name,}
      \AttributeTok{dose =}\NormalTok{ dose,}
      \AttributeTok{freq =}\NormalTok{ interval,}
      \AttributeTok{dur =}\NormalTok{ duration}
\NormalTok{    )}

\NormalTok{    pred\_data }\OtherTok{\textless{}{-}}\NormalTok{ processed\_data\_zero }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{select}\NormalTok{(ID, time, }\AttributeTok{PRED =}\NormalTok{ IPRED, }\AttributeTok{AUC\_PRED =}\NormalTok{ AUC, }\AttributeTok{Cmax\_PRED =}\NormalTok{ Cmax)}

\NormalTok{    merged\_data }\OtherTok{\textless{}{-}}\NormalTok{ finalized\_data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{left\_join}\NormalTok{(pred\_data, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"time"}\NormalTok{))}
\NormalTok{    regimen\_results }\OtherTok{\textless{}{-}} \FunctionTok{append}\NormalTok{(regimen\_results, }\FunctionTok{list}\NormalTok{(merged\_data))}
\NormalTok{  \}}

\NormalTok{  combined\_results }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, regimen\_results)}
  \FunctionTok{return}\NormalTok{(combined\_results)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

8 different dosing schemes are used depending on the model cohort.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define regimen parameters for all models. For each regimen, we take a different batch of 100 sets of covariates (defined by starting ID)}
\NormalTok{regimens }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"CARLIER"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{1000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{6}\NormalTok{, }\AttributeTok{duration =} \FloatTok{0.5}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"CARLIER"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{1}\NormalTok{, }\AttributeTok{dose =} \DecValTok{1000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{8}\NormalTok{, }\AttributeTok{duration =} \FloatTok{0.5}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"FOURNIER"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{1000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{6}\NormalTok{, }\AttributeTok{duration =} \DecValTok{2}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"FOURNIER"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{2000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{8}\NormalTok{, }\AttributeTok{duration =} \DecValTok{1}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"FOURNIER"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{1}\NormalTok{, }\AttributeTok{dose =} \DecValTok{500}\NormalTok{, }\AttributeTok{interval =} \DecValTok{8}\NormalTok{, }\AttributeTok{duration =} \DecValTok{2}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"MELLON"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{1000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{24}\NormalTok{, }\AttributeTok{duration =} \FloatTok{0.5}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"RAMBAUD"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{12000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{24}\NormalTok{, }\AttributeTok{duration =} \DecValTok{24}\NormalTok{),}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{model\_cohort =} \StringTok{"RAMBAUD"}\NormalTok{, }\AttributeTok{ir\_group =} \DecValTok{0}\NormalTok{, }\AttributeTok{dose =} \DecValTok{14000}\NormalTok{, }\AttributeTok{interval =} \DecValTok{24}\NormalTok{, }\AttributeTok{duration =} \DecValTok{24}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Total simulation time}
\NormalTok{sim\_dur }\OtherTok{\textless{}{-}} \DecValTok{72}
\end{Highlighting}
\end{Shaded}

Finally, the simulations are done with each respective model, the
results are merged and a MODEL column is added to identify the model
used for the simulation of each concentration.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results\_Carlier }\OtherTok{\textless{}{-}} \FunctionTok{generate\_model\_regimen}\NormalTok{(}\StringTok{"amox\_Carlier"}\NormalTok{, (}\StringTok{"amox\_Carlier"}\NormalTok{), }\StringTok{"amox\_Carlier\_zero"}\NormalTok{, regimens, sim\_dur)}
\NormalTok{results\_Fournier }\OtherTok{\textless{}{-}} \FunctionTok{generate\_model\_regimen}\NormalTok{(}\StringTok{"amox\_Fournier"}\NormalTok{, (}\StringTok{"amox\_Fournier"}\NormalTok{), }\StringTok{"amox\_Fournier\_zero"}\NormalTok{, regimens, sim\_dur)}
\NormalTok{results\_Mellon }\OtherTok{\textless{}{-}} \FunctionTok{generate\_model\_regimen}\NormalTok{(}\StringTok{"amox\_Mellon"}\NormalTok{, (}\StringTok{"amox\_Mellon"}\NormalTok{), }\StringTok{"amox\_Mellon\_zero"}\NormalTok{, regimens, sim\_dur)}
\NormalTok{results\_Rambaud }\OtherTok{\textless{}{-}} \FunctionTok{generate\_model\_regimen}\NormalTok{(}\StringTok{"amox\_Rambaud"}\NormalTok{, (}\StringTok{"amox\_Rambaud"}\NormalTok{), }\StringTok{"amox\_Rambaud\_zero"}\NormalTok{, regimens, sim\_dur)}

\CommentTok{\# Combine results from the simulation}
\NormalTok{all\_results }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(}
\NormalTok{  results\_Carlier,}
\NormalTok{  results\_Fournier,}
\NormalTok{  results\_Mellon,}
\NormalTok{  results\_Rambaud}
\NormalTok{)}

\CommentTok{\# Add MODEL column indicating the model which is used for the simulation}
\NormalTok{all\_results }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{MODEL =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    MODEL }\SpecialCharTok{==} \StringTok{"amox\_Carlier"} \SpecialCharTok{\textasciitilde{}} \StringTok{"CARLIER"}\NormalTok{,}
\NormalTok{    MODEL }\SpecialCharTok{==} \StringTok{"amox\_Fournier"} \SpecialCharTok{\textasciitilde{}} \StringTok{"FOURNIER"}\NormalTok{,}
\NormalTok{     MODEL }\SpecialCharTok{==} \StringTok{"amox\_Mellon"} \SpecialCharTok{\textasciitilde{}} \StringTok{"MELLON"}\NormalTok{,}
\NormalTok{    MODEL }\SpecialCharTok{==} \StringTok{"amox\_Rambaud"} \SpecialCharTok{\textasciitilde{}} \StringTok{"RAMBAUD"}\NormalTok{)}
\NormalTok{  )}

\NormalTok{all\_results }\OtherTok{\textless{}{-}} \FunctionTok{distinct}\NormalTok{(all\_results)}
\CommentTok{\# Filter based on steady{-}state based on the reference (true) clearance and volume}
\NormalTok{ref\_values }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{filter}\NormalTok{(MODEL }\SpecialCharTok{==}\NormalTok{ MODEL\_COHORT) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice}\NormalTok{(}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{select}\NormalTok{(ID, Vc, CL)}
\NormalTok{all\_results }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(ref\_values, }\AttributeTok{by =} \StringTok{"ID"}\NormalTok{, }\AttributeTok{suffix =} \FunctionTok{c}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"\_ref"}\NormalTok{))}
\NormalTok{all\_results }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{TSS =} \FunctionTok{ceiling}\NormalTok{(}\FloatTok{3.3} \SpecialCharTok{*}\NormalTok{ (}\FloatTok{0.693} \SpecialCharTok{*}\NormalTok{ Vc\_ref) }\SpecialCharTok{/}\NormalTok{ CL\_ref }\SpecialCharTok{/}\NormalTok{ FREQ) }\SpecialCharTok{*}\NormalTok{ FREQ)}
\NormalTok{all\_results }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{((TIME }\SpecialCharTok{\textgreater{}=} \DecValTok{0} \SpecialCharTok{\&}\NormalTok{ TIME }\SpecialCharTok{\textless{}=}\NormalTok{ (}\DecValTok{0} \SpecialCharTok{+}\NormalTok{ FREQ)) }\SpecialCharTok{|}\NormalTok{ (TIME }\SpecialCharTok{\textgreater{}=}\NormalTok{ TSS }\SpecialCharTok{\&}\NormalTok{ TIME }\SpecialCharTok{\textless{}=}\NormalTok{ (TSS }\SpecialCharTok{+}\NormalTok{ FREQ)))}
\end{Highlighting}
\end{Shaded}

\subsection{Concentrations (PRED, IPRED,
Y)}\label{concentrations-pred-ipred-y}

Below quantification limit observations are removed (M1 method). LLOQ
concentrations for each model can be found in ``mrgsolve/LLOQ.txt''.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{AMOX\_SIM }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{select}\NormalTok{(ID, TIME, PRED, IPRED, Y, WT, CREAT, BURN, ICU, OBESE, AGE, SEX, HT, BSA, MODEL, MODEL\_COHORT, DOSE\_ADM, FREQ, DUR, Vc, CL, TSS) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{()}

\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0) and take only observed values}
\NormalTok{AMOX\_SIM }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{REFERENCE =} \FunctionTok{if\_else}\NormalTok{(MODEL }\SpecialCharTok{==}\NormalTok{ MODEL\_COHORT, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}

\CommentTok{\# Dataset to plot CL}
\NormalTok{summarized\_SIM }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{filter}\NormalTok{(REFERENCE}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(ID, MODEL, CL, Vc)}

\CommentTok{\# Box plot for CL}
\NormalTok{plot\_CL }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(summarized\_SIM, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ CL, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Clearance distribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Model"}\NormalTok{, }\AttributeTok{y =} \StringTok{"CL (L/h)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{30}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{plot\_CL}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/concentrations-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Box plot for Vc}
\NormalTok{plot\_V }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(summarized\_SIM, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ Vc, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Central volume distribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Model"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Vc (L)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{30}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{plot\_V}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/concentrations-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# M1 BLOQ handling}
\CommentTok{\# Replace BLOQ with NA}
\NormalTok{AMOX\_SIM\_QL }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM }

\NormalTok{AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"CARLIER"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)] }\OtherTok{\textless{}{-}} 
  \FunctionTok{lapply}\NormalTok{(AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"CARLIER"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)], }
         \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textless{}} \FloatTok{0.5}\NormalTok{, }\ConstantTok{NA}\NormalTok{, x))}

\NormalTok{AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"FOURNIER"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)] }\OtherTok{\textless{}{-}} 
  \FunctionTok{lapply}\NormalTok{(AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"FOURNIER"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)], }
         \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textless{}} \FloatTok{0.1}\NormalTok{, }\ConstantTok{NA}\NormalTok{, x))}

\NormalTok{AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"MELLON"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)] }\OtherTok{\textless{}{-}} 
  \FunctionTok{lapply}\NormalTok{(AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"MELLON"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)], }
         \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textless{}} \FloatTok{0.5}\NormalTok{, }\ConstantTok{NA}\NormalTok{, x))}

\NormalTok{AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"RAMBAUD"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)] }\OtherTok{\textless{}{-}} 
  \FunctionTok{lapply}\NormalTok{(AMOX\_SIM\_QL[AMOX\_SIM\_QL}\SpecialCharTok{$}\NormalTok{MODEL }\SpecialCharTok{==} \StringTok{"RAMBAUD"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"PRED"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{)], }
         \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textless{}} \DecValTok{2}\NormalTok{, }\ConstantTok{NA}\NormalTok{, x))}

\CommentTok{\# Remove IDs with NAs (to always have 3 predictions (4 by each model) for a group of ID and time)}
\NormalTok{AMOX\_SIM\_QL2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{complete.cases}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, TIME) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{filter}\NormalTok{(}\FunctionTok{n}\NormalTok{() }\SpecialCharTok{==} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\NormalTok{AMOX\_SIM\_QL2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, TIME) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{IPRED =}\NormalTok{ IPRED[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}


\CommentTok{\# Create test data by taking 2400 subjects (24 from each dosing scheme and 6{-}6 for each model covariate cohort per dosing scheme)}
\NormalTok{SIM\_test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL2 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{6} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{26} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{31} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{51} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{56} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{76} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{81}
\NormalTok{  )}

\CommentTok{\# Create training data by taking 7600 subjects (76 from each dosing scheme and 19{-}19 for each model covariate cohorte per dosing scheme)}
\NormalTok{SIM\_train }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL2 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{7} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{25} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{32} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{50} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{57} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{75} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{82} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{100}
\NormalTok{  )}

\CommentTok{\# Dataset identifyer}
\NormalTok{IPRED\_train\_compare }\OtherTok{\textless{}{-}}\NormalTok{ SIM\_train }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Train"}\NormalTok{)}
\NormalTok{IPRED\_test\_compare }\OtherTok{\textless{}{-}}\NormalTok{ SIM\_test }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Test"}\NormalTok{)}

\CommentTok{\# Combine the three datasets}
\NormalTok{combined\_IPRED }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(IPRED\_train\_compare, IPRED\_test\_compare)}

\CommentTok{\# Compare the train and test sets}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{)}
\NormalTok{tableOne7 }\OtherTok{\textless{}{-}} \FunctionTok{CreateTableOne}\NormalTok{(}\AttributeTok{vars =}\NormalTok{ vars, }\AttributeTok{strata =} \StringTok{"Dataset"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ combined\_IPRED)}
\NormalTok{tableOne8}\OtherTok{\textless{}{-}}\FunctionTok{print}\NormalTok{(tableOne7, }\AttributeTok{nonnormal =} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"IPRED"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{), }\AttributeTok{printToggle=}\NormalTok{F, }\AttributeTok{minMax=}\NormalTok{T)}

\FunctionTok{kableone}\NormalTok{(tableOne7)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Test & Train & p & test \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
n & 153180 & 461296 & & \\
CREAT (mean (SD)) & 1.16 (0.72) & 1.14 (0.74) & \textless0.001 & \\
WT (mean (SD)) & 77.61 (14.71) & 77.70 (13.83) & 0.023 & \\
IPRED (mean (SD)) & 46.39 (28.17) & 45.92 (28.80) & \textless0.001 & \\
CL (mean (SD)) & 13.16 (18.97) & 13.69 (26.69) & \textless0.001 & \\
Vc (mean (SD)) & 10.81 (5.59) & 10.99 (5.93) & \textless0.001 & \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{kableone}\NormalTok{(tableOne8)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2805}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2683}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2683}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0854}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0976}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Train
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
p
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
test
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
n & 153180 & 461296 & & \\
CREAT (median {[}range{]}) & 0.94 {[}0.24, 5.32{]} & 0.95 {[}0.13,
8.07{]} & \textless0.001 & nonnorm \\
WT (median {[}range{]}) & 75.96 {[}41.33, 139.60{]} & 76.04 {[}47.36,
141.17{]} & \textless0.001 & nonnorm \\
IPRED (median {[}range{]}) & 40.27 {[}0.41, 181.09{]} & 40.49 {[}0.72,
274.18{]} & \textless0.001 & nonnorm \\
CL (median {[}range{]}) & 11.74 {[}0.07, 1271.20{]} & 11.94 {[}0.02,
2560.70{]} & \textless0.001 & nonnorm \\
Vc (median {[}range{]}) & 9.90 {[}3.19, 51.11{]} & 9.97 {[}3.02,
57.86{]} & \textless0.001 & nonnorm \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Export to csv}
\CommentTok{\#write.csv(SIM\_train, "AMOX\_SIM\_TRAIN.csv", row.names = FALSE, quote = FALSE)}
\CommentTok{\#write.csv(SIM\_test, "AMOX\_SIM\_TEST.csv", row.names = FALSE, quote = FALSE)}
\end{Highlighting}
\end{Shaded}

\subsection{Exposure (AUC)}\label{exposure-auc}

AUC is calculated based on the sum of the integrals of IPRED values and
cumulated for both the steady-state and non stead-state inter-dose
interval.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{AMOX\_AUC1 }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}
    \AttributeTok{ID =} \FunctionTok{first}\NormalTok{(ID),}
    \AttributeTok{MODEL =} \FunctionTok{first}\NormalTok{(MODEL),}
    \AttributeTok{MODEL\_COHORT =} \FunctionTok{first}\NormalTok{(MODEL\_COHORT),}
    \AttributeTok{AUC\_IND =} \FunctionTok{sum}\NormalTok{(AUC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\CommentTok{\#total AUC (based on IPRED)}
    \AttributeTok{AUC\_PRED =} \FunctionTok{sum}\NormalTok{(AUC\_PRED, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\CommentTok{\#total AUC (based on PRED)}
    \AttributeTok{WT =} \FunctionTok{first}\NormalTok{(WT),    }
    \AttributeTok{WT =} \FunctionTok{first}\NormalTok{(CREAT), }
    \AttributeTok{BURN =} \FunctionTok{first}\NormalTok{(BURN),}
    \AttributeTok{ICU =} \FunctionTok{first}\NormalTok{(ICU),}
    \AttributeTok{OBESE =} \FunctionTok{first}\NormalTok{(OBESE),}
    \AttributeTok{AGE =} \FunctionTok{first}\NormalTok{(AGE),}
    \AttributeTok{SEX =} \FunctionTok{first}\NormalTok{(SEX),}
    \AttributeTok{HT =} \FunctionTok{first}\NormalTok{(HT),}
    \AttributeTok{DUR =} \FunctionTok{first}\NormalTok{(DUR),}
    \AttributeTok{FREQ =} \FunctionTok{first}\NormalTok{(FREQ),}
    \AttributeTok{DOSE\_ADM =} \FunctionTok{first}\NormalTok{(DOSE\_ADM),}
    \AttributeTok{TSS =} \FunctionTok{first}\NormalTok{(TSS),}
    \AttributeTok{Vc =} \FunctionTok{first}\NormalTok{(Vc),}
    \AttributeTok{CL =} \FunctionTok{first}\NormalTok{(CL)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{REFERENCE =} \FunctionTok{if\_else}\NormalTok{(MODEL }\SpecialCharTok{==}\NormalTok{ MODEL\_COHORT, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0)}

\NormalTok{summarized\_AUC }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(ID, MODEL, AUC\_IND) }

\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0) and take only observed values}
\NormalTok{  AMOX\_AUC1 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{AUC\_IND =}\NormalTok{ AUC\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Box plot for AUC}
\NormalTok{plot\_AUC }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(summarized\_AUC, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ AUC\_IND, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"AUC distribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Model"}\NormalTok{, }\AttributeTok{y =} \StringTok{"AUC (mg.h/L)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{30}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{plot\_AUC}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/AUC-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create test data by taking 2400 subjects (24 from each dosing scheme and 6{-}6 for each model covariate cohorte per dosing scheme)}
\NormalTok{AUC\_test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{6} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{26} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{31} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{51} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{56} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{76} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{81}
\NormalTok{  )}

\CommentTok{\# Create training data by taking 7600 subjects (76 from each dosing scheme and 19{-}19 for each model covariate cohorte per dosing scheme)}
\NormalTok{AUC\_train }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{7} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{25} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{32} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{50} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{57} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{75} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{82} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{100}
\NormalTok{  )}

\CommentTok{\# Dataset identifyer}
\NormalTok{AUC\_train\_compare }\OtherTok{\textless{}{-}}\NormalTok{ AUC\_train }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Train"}\NormalTok{)}
\NormalTok{AUC\_test\_compare }\OtherTok{\textless{}{-}}\NormalTok{ AUC\_test }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Test"}\NormalTok{)}

\CommentTok{\# Combine the three datasets}
\NormalTok{combined\_AUC }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(AUC\_train\_compare, AUC\_test\_compare)}

\CommentTok{\# Compare the train and test sets}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"AUC\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{)}
\NormalTok{tableOne }\OtherTok{\textless{}{-}} \FunctionTok{CreateTableOne}\NormalTok{(}\AttributeTok{vars =}\NormalTok{ vars, }\AttributeTok{strata =} \StringTok{"Dataset"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ combined\_AUC)}
\NormalTok{tableOne2 }\OtherTok{\textless{}{-}} \FunctionTok{print}\NormalTok{(tableOne, }\AttributeTok{nonnormal =} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"AUC\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{), }\AttributeTok{printToggle=}\NormalTok{F, }\AttributeTok{minMax=}\NormalTok{T)}

\FunctionTok{kableone}\NormalTok{(tableOne2)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2525}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.3030}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.3030}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0606}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0808}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Train
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
p
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
test
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
n & 2400 & 7500 & & \\
WT (median {[}range{]}) & 0.76 {[}0.24, 5.32{]} & 0.77 {[}0.13, 8.07{]}
& 0.101 & nonnorm \\
AUC\_IND (median {[}range{]}) & 21268.70 {[}3936.66, 583537.49{]} &
20213.75 {[}3819.30, 861775.02{]} & 0.221 & nonnorm \\
CL (median {[}range{]}) & 13.30 {[}0.07, 1271.20{]} & 13.41 {[}0.02,
7583.93{]} & 0.244 & nonnorm \\
Vc (median {[}range{]}) & 10.10 {[}3.19, 51.11{]} & 10.16 {[}3.02,
57.86{]} & 0.966 & nonnorm \\
\end{longtable}

\subsection{Maximal concentration
(Cmax)}\label{maximal-concentration-cmax}

Cmax is the true Cmax, not the highest observed concentration.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{AMOX\_CMAX1 }\OtherTok{\textless{}{-}}\NormalTok{ all\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarize}\NormalTok{(}
    \AttributeTok{ID =} \FunctionTok{first}\NormalTok{(ID),}
    \AttributeTok{MODEL =} \FunctionTok{first}\NormalTok{(MODEL),}
    \AttributeTok{MODEL\_COHORT =} \FunctionTok{first}\NormalTok{(MODEL\_COHORT),}
    \AttributeTok{CMAX\_IND =} \FunctionTok{max}\NormalTok{(Cmax, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),  }\CommentTok{\# Cmax based on IPRED}
    \AttributeTok{CMAX\_PRED =} \FunctionTok{max}\NormalTok{(Cmax\_PRED, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\CommentTok{\# Cmax based on PRED}
    \AttributeTok{WT =} \FunctionTok{first}\NormalTok{(WT), }
    \AttributeTok{CREAT =} \FunctionTok{first}\NormalTok{(CREAT), }
    \AttributeTok{BURN =} \FunctionTok{first}\NormalTok{(BURN),}
    \AttributeTok{ICU =} \FunctionTok{first}\NormalTok{(ICU),}
    \AttributeTok{OBESE =} \FunctionTok{first}\NormalTok{(OBESE),}
    \AttributeTok{AGE =} \FunctionTok{first}\NormalTok{(AGE),}
    \AttributeTok{SEX =} \FunctionTok{first}\NormalTok{(SEX),}
    \AttributeTok{HT =} \FunctionTok{first}\NormalTok{(HT),}
    \AttributeTok{DUR =} \FunctionTok{first}\NormalTok{(DUR),}
    \AttributeTok{FREQ =} \FunctionTok{first}\NormalTok{(FREQ),}
    \AttributeTok{DOSE\_ADM =} \FunctionTok{first}\NormalTok{(DOSE\_ADM),}
    \AttributeTok{TSS =} \FunctionTok{first}\NormalTok{(TSS),}
    \AttributeTok{Vc =} \FunctionTok{first}\NormalTok{(Vc),}
    \AttributeTok{CL =} \FunctionTok{first}\NormalTok{(CL)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{REFERENCE =} \FunctionTok{if\_else}\NormalTok{(MODEL }\SpecialCharTok{==}\NormalTok{ MODEL\_COHORT, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0)}

\NormalTok{summarized\_CMAX }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE}\SpecialCharTok{==}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(ID, MODEL, CMAX\_IND)}

\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0) and take only observed values}
\NormalTok{  AMOX\_CMAX1 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CMAX\_IND =}\NormalTok{ CMAX\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Box plot for Cmax}
\NormalTok{plot\_CMAX }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(summarized\_CMAX, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ CMAX\_IND, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Cmax distribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Model"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Cmax (mg/L)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{30}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{plot\_CMAX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/CMAX-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create test data by taking 2400 subjects (24 from each dosing scheme and 6{-}6 for each model covariate cohorte per dosing scheme)}
\NormalTok{CMAX\_test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{6} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{26} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{31} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{51} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{56} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{76} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{81}
\NormalTok{  )}

\CommentTok{\# Create training data by taking 7600 subjects (76 from each dosing scheme and 19{-}19 for each model covariate cohorte per dosing scheme)}
\NormalTok{CMAX\_train }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{7} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{25} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{32} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{50} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{57} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{75} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{82} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{100}
\NormalTok{  )}

\CommentTok{\# Dataset identifyer}
\NormalTok{CMAX\_train\_compare }\OtherTok{\textless{}{-}}\NormalTok{ CMAX\_train }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Train"}\NormalTok{)}
\NormalTok{CMAX\_test\_compare }\OtherTok{\textless{}{-}}\NormalTok{ CMAX\_test }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Test"}\NormalTok{)}

\CommentTok{\# Combine the three datasets}
\NormalTok{combined\_CMAX }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(CMAX\_train\_compare, CMAX\_test\_compare)}

\CommentTok{\# Compare the train and test sets}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CMAX\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{)}
\NormalTok{tableOne3 }\OtherTok{\textless{}{-}} \FunctionTok{CreateTableOne}\NormalTok{(}\AttributeTok{vars =}\NormalTok{ vars, }\AttributeTok{strata =} \StringTok{"Dataset"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ combined\_CMAX)}
\NormalTok{tableOne4}\OtherTok{\textless{}{-}}\FunctionTok{print}\NormalTok{(tableOne3, }\AttributeTok{nonnormal =} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CMAX\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{), }\AttributeTok{printToggle=}\NormalTok{F, }\AttributeTok{minMax=}\NormalTok{T)}

\FunctionTok{kableone}\NormalTok{(tableOne4)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.3095}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2619}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2619}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0714}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0952}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Train
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
p
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
test
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
n & 2400 & 7500 & & \\
CREAT (median {[}range{]}) & 0.76 {[}0.24, 5.32{]} & 0.77 {[}0.13,
8.07{]} & 0.101 & nonnorm \\
WT (median {[}range{]}) & 80.12 {[}41.33, 139.60{]} & 79.95 {[}47.36,
141.17{]} & 0.856 & nonnorm \\
CMAX\_IND (median {[}range{]}) & 58.04 {[}8.87, 181.09{]} & 58.13
{[}9.93, 274.18{]} & 0.574 & nonnorm \\
CL (median {[}range{]}) & 13.30 {[}0.07, 1271.20{]} & 13.41 {[}0.02,
7583.93{]} & 0.244 & nonnorm \\
Vc (median {[}range{]}) & 10.10 {[}3.19, 51.11{]} & 10.16 {[}3.02,
57.86{]} & 0.966 & nonnorm \\
\end{longtable}

\subsection{Trough concentration
(Cmin)}\label{trough-concentration-cmin}

The trough concentration is the last concentration for the steady-state
interdose interval

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Add CMIN column by taking the last steady{-}state concentration}
\NormalTok{AMOX\_CMIN1 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{arrange}\NormalTok{(TIME) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CMIN\_IND =} \FunctionTok{last}\NormalTok{(IPRED[TIME }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(TIME)])) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CMIN\_PRED =} \FunctionTok{last}\NormalTok{(PRED[TIME }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(TIME)])) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice\_max}\NormalTok{(TIME, }\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{with\_ties =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(ID, MODEL, CMIN\_IND, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{) }

\NormalTok{summarized\_CMIN }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)}

\CommentTok{\# Add a variable called REFERENCE which is 1 for the the line where the model used for simulation is the same as the model cohort (otherwise 0) and take only observed values}
\NormalTok{  AMOX\_CMIN1 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CMIN\_IND =}\NormalTok{ CMIN\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}
  
\CommentTok{\# Box plot for CL before removing the outliers}
\NormalTok{plot\_CMIN }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(summarized\_CMIN, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ CMIN\_IND, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Cmin distribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Model"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Cmin (mg/L)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{30}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{plot\_CMIN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/CMIN-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create test data by taking 2400 subjects (24 from each dosing scheme and 6{-}6 for each model covariate cohorte per dosing scheme)}
\NormalTok{CMIN\_test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{6} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{26} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{31} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{51} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{56} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{76} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{81}
\NormalTok{  )}

\CommentTok{\# Create training data by taking 7600 subjects (76 from each dosing scheme and 19{-}19 for each model covariate cohorte per dosing scheme)}
\NormalTok{CMIN\_train }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{    ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{7} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{25} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{32} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{50} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{57} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{75} \SpecialCharTok{|}
\NormalTok{      ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textgreater{}=} \DecValTok{82} \SpecialCharTok{\&}\NormalTok{ ID }\SpecialCharTok{\%\%} \DecValTok{100} \SpecialCharTok{\textless{}=} \DecValTok{100}
\NormalTok{  )}

\CommentTok{\# Dataset identifyer}
\NormalTok{CMIN\_train\_compare }\OtherTok{\textless{}{-}}\NormalTok{ CMIN\_train }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Train"}\NormalTok{)}
\NormalTok{CMIN\_test\_compare }\OtherTok{\textless{}{-}}\NormalTok{ CMIN\_test }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dataset =} \StringTok{"Test"}\NormalTok{)}

\CommentTok{\# Combine the three datasets}
\NormalTok{combined\_CMIN }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(CMIN\_train\_compare, CMIN\_test\_compare)}

\CommentTok{\# Compare the train and test sets}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{)}
\NormalTok{tableOne5 }\OtherTok{\textless{}{-}} \FunctionTok{CreateTableOne}\NormalTok{(}\AttributeTok{vars =}\NormalTok{ vars, }\AttributeTok{strata =} \StringTok{"Dataset"}\NormalTok{, }\AttributeTok{data =}\NormalTok{ combined\_CMIN)}
\NormalTok{tableOne6 }\OtherTok{\textless{}{-}} \FunctionTok{print}\NormalTok{(tableOne5, }\AttributeTok{nonnormal =} \FunctionTok{c}\NormalTok{(}\StringTok{"CREAT"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"CL"}\NormalTok{, }\StringTok{"Vc"}\NormalTok{), }\AttributeTok{printToggle=}\NormalTok{F, }\AttributeTok{minMax=}\NormalTok{T)}

\FunctionTok{kableone}\NormalTok{(tableOne6)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.3095}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2619}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2619}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0714}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.0952}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Train
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
p
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
test
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
n & 2400 & 7496 & & \\
CREAT (median {[}range{]}) & 0.76 {[}0.24, 5.32{]} & 0.77 {[}0.13,
8.07{]} & 0.097 & nonnorm \\
WT (median {[}range{]}) & 80.12 {[}41.33, 139.60{]} & 79.94 {[}47.36,
141.17{]} & 0.843 & nonnorm \\
CMIN\_IND (median {[}range{]}) & 18.37 {[}0.41, 181.09{]} & 17.75
{[}0.72, 274.18{]} & 0.063 & nonnorm \\
CL (median {[}range{]}) & 13.30 {[}0.07, 1271.20{]} & 13.40 {[}0.02,
2560.70{]} & 0.252 & nonnorm \\
Vc (median {[}range{]}) & 10.10 {[}3.19, 51.11{]} & 10.16 {[}3.02,
57.86{]} & 0.971 & nonnorm \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Export to csv}
\FunctionTok{write.csv}\NormalTok{(CMIN\_train, }\StringTok{"AMOX\_CMIN\_TRAIN.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(CMIN\_test, }\StringTok{"AMOX\_CMIN\_TEST.csv"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Data visualization stratified by dosing
schemes}\label{data-visualization-stratified-by-dosing-schemes}

The following graphs show the individual observed concentration-time
curves for the data stratified by model. One graph shows the
concentration-time curves for the first interdose interval and the other
graph for the interdose interval after the dose which permits to reach
steady state.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Add dosing scheme as a categorical variable (to separate dosing schemes)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSING\_SCHEME =} \FunctionTok{paste}\NormalTok{(}\StringTok{"FREQ:"}\NormalTok{, FREQ, }\StringTok{"DOSE:"}\NormalTok{, DOSE\_ADM, }\StringTok{"DUR:"}\NormalTok{, DUR, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{))}

\NormalTok{data\_ref }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}

\NormalTok{dosing\_schemes }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{DOSING\_SCHEME)}

\CommentTok{\# Lists to store plots}
\NormalTok{plot\_list\_before }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{plot\_list\_after }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}

\CommentTok{\# Loop through each dosing scheme}
\NormalTok{plot\_dosing\_schemes }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_ref, dosing\_schemes) \{}
\NormalTok{  plot\_list\_before }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  plot\_list\_after }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq\_along}\NormalTok{(dosing\_schemes)) \{}
\NormalTok{    scheme }\OtherTok{\textless{}{-}}\NormalTok{ dosing\_schemes[i]}
    
    \CommentTok{\# Extract FREQ (=interdose interval)}
\NormalTok{    scheme\_data }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(data\_ref, DOSING\_SCHEME }\SpecialCharTok{==}\NormalTok{ scheme)}
\NormalTok{    freq\_value }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(scheme\_data}\SpecialCharTok{$}\NormalTok{FREQ)}
    
    \CommentTok{\# Split data before and after SS}
\NormalTok{    data\_before }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(scheme\_data, TIME }\SpecialCharTok{\textless{}=}\NormalTok{ freq\_value)}
\NormalTok{    data\_after }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(scheme\_data, TIME }\SpecialCharTok{\textgreater{}}\NormalTok{ freq\_value) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{mutate}\NormalTok{(}\AttributeTok{TIME =}\NormalTok{ TIME }\SpecialCharTok{{-}}\NormalTok{ freq\_value)  }\CommentTok{\# Adjust time so that it means time after SS dose}
    
    \CommentTok{\# Plot for before SS}
\NormalTok{    plot\_list\_before[[i]] }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data\_before, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ TIME, }\AttributeTok{y =}\NormalTok{ IPRED, }\AttributeTok{color =}\NormalTok{ MODEL, }\AttributeTok{group =}\NormalTok{ ID)) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{MODEL) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
      \FunctionTok{labs}\NormalTok{(}
        \AttributeTok{title =} \FunctionTok{paste}\NormalTok{(}\StringTok{"First interdose interval"}\NormalTok{, freq\_value, scheme),}
        \AttributeTok{x =} \StringTok{"Time (h)"}\NormalTok{,}
        \AttributeTok{y =} \StringTok{"IPRED (mg/L)"}\NormalTok{,}
        \AttributeTok{color =} \StringTok{"MODEL"}
\NormalTok{      ) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{10}\NormalTok{),}
        \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{), }
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
    
    \CommentTok{\# Plot for after SS is reached}
\NormalTok{    plot\_list\_after[[i]] }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data\_after, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ TIME, }\AttributeTok{y =}\NormalTok{ IPRED, }\AttributeTok{color =}\NormalTok{ MODEL, }\AttributeTok{group =}\NormalTok{ ID)) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+} 
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{MODEL) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
      \FunctionTok{labs}\NormalTok{(}
        \AttributeTok{title =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Steady{-}state"}\NormalTok{, freq\_value, scheme),}
        \AttributeTok{x =} \StringTok{"Time after steady{-}state dose (h)"}\NormalTok{,}
        \AttributeTok{y =} \StringTok{"IPRED (mg/L)"}\NormalTok{,}
        \AttributeTok{color =} \StringTok{"MODEL"}
\NormalTok{      ) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{10}\NormalTok{),}
        \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{), }
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
\NormalTok{  \}}
  
  \FunctionTok{list}\NormalTok{(}\AttributeTok{before =}\NormalTok{ plot\_list\_before, }\AttributeTok{after =}\NormalTok{ plot\_list\_after)}
\NormalTok{\}}

\NormalTok{conc\_profile\_plots }\OtherTok{\textless{}{-}} \FunctionTok{plot\_dosing\_schemes}\NormalTok{(data\_ref, dosing\_schemes)}
\NormalTok{conc\_profile\_plots}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$before
$before[[1]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-1.pdf}}

\begin{verbatim}

$before[[2]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-2.pdf}}

\begin{verbatim}

$before[[3]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-3.pdf}}

\begin{verbatim}

$before[[4]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-4.pdf}}

\begin{verbatim}

$before[[5]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-5.pdf}}

\begin{verbatim}

$before[[6]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-6.pdf}}

\begin{verbatim}

$before[[7]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-7.pdf}}

\begin{verbatim}

$before[[8]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-8.pdf}}

\begin{verbatim}


$after
$after[[1]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-9.pdf}}

\begin{verbatim}

$after[[2]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-10.pdf}}

\begin{verbatim}

$after[[3]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-11.pdf}}

\begin{verbatim}

$after[[4]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-12.pdf}}

\begin{verbatim}

$after[[5]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-13.pdf}}

\begin{verbatim}

$after[[6]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-14.pdf}}

\begin{verbatim}

$after[[7]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-15.pdf}}

\begin{verbatim}

$after[[8]]
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Data-visualization-16.pdf}}

Visualization of 5th, 50th and 95th percentiles (5th and 95th
percentiles in dashed)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# The data is binned to 40 bins to make it smoother}
\NormalTok{data\_percentiles\_ref }\OtherTok{\textless{}{-}}\NormalTok{ data\_ref }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{TIME\_bin =} \FunctionTok{ntile}\NormalTok{(TIME, }\DecValTok{40}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(DOSING\_SCHEME, MODEL, TIME\_bin) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{P5 =} \FunctionTok{quantile}\NormalTok{(IPRED, }\FloatTok{0.05}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{P50 =} \FunctionTok{quantile}\NormalTok{(IPRED, }\FloatTok{0.50}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{P95 =} \FunctionTok{quantile}\NormalTok{(IPRED, }\FloatTok{0.95}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{TIME =} \FunctionTok{median}\NormalTok{(TIME, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{.groups =} \StringTok{\textquotesingle{}drop\textquotesingle{}}
\NormalTok{  )}


\NormalTok{plot\_list\_ref }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}

\CommentTok{\# Loop through each dosing scheme}
\NormalTok{plot\_percentiles }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_percentiles\_ref, dosing\_schemes) \{}
  \FunctionTok{library}\NormalTok{(ggplot2)}
  \FunctionTok{library}\NormalTok{(patchwork)}
  
\NormalTok{  plot\_list\_ref }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq\_along}\NormalTok{(dosing\_schemes)) \{}
\NormalTok{    plot\_list\_ref[[i]] }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}
      \FunctionTok{subset}\NormalTok{(data\_percentiles\_ref, DOSING\_SCHEME }\SpecialCharTok{==}\NormalTok{ dosing\_schemes[i]),}
      \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ TIME)}
\NormalTok{    ) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ P5, }\AttributeTok{color =}\NormalTok{ MODEL), }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ P50, }\AttributeTok{color =}\NormalTok{ MODEL), }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =}\NormalTok{ P95, }\AttributeTok{color =}\NormalTok{ MODEL), }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}
        \AttributeTok{title =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Reference model {-}"}\NormalTok{, dosing\_schemes[i]),}
        \AttributeTok{x =} \StringTok{"Time (binned)"}\NormalTok{,}
        \AttributeTok{y =} \StringTok{"IPRED (mg/L)"}\NormalTok{,}
        \AttributeTok{color =} \StringTok{"MODEL"}
\NormalTok{      ) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{),}
        \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{8}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"below"}
\NormalTok{      )}
\NormalTok{  \}}
  
  \FunctionTok{return}\NormalTok{(plot\_list\_ref)}
\NormalTok{\}}


\NormalTok{percentile\_plots }\OtherTok{\textless{}{-}} \FunctionTok{plot\_percentiles}\NormalTok{(data\_percentiles\_ref, dosing\_schemes)}
\end{Highlighting}
\end{Shaded}

Visualization of the inter-individual variability of models by dividing
PRED (predicted) values by IPRED (observed) both generated by the same
model.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# IPRED}

\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{ AMOX\_SIM\_QL3 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, TIME, MODEL) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ratio =}\NormalTok{ (PRED }\SpecialCharTok{/}\NormalTok{ IPRED) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{stratified\_ratios\_SIM }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{( AMOX\_SIM\_QL3, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Predicted/observed ratios for the same model"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{stratified\_ratios\_SIM}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-var-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CMAX}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_CMAX2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ratio =}\NormalTok{ (CMAX\_PRED }\SpecialCharTok{/}\NormalTok{ CMAX\_IND) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{stratified\_ratios\_CMAX }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_CMAX2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Predicted/observed ratios for the same model (Cmax)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{stratified\_ratios\_CMAX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-var-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# AUC}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_AUC2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ratio =}\NormalTok{ (AUC\_PRED }\SpecialCharTok{/}\NormalTok{ AUC\_IND) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{stratified\_ratios\_AUC }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_AUC2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Predicted/observed ratios for the same model (AUC)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{stratified\_ratios\_AUC}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-var-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CMIN}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_CMIN2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN1 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, MODEL) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ratio =}\NormalTok{ (CMIN\_PRED }\SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{stratified\_ratios\_CMIN }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_CMIN2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Predicted/observed ratios for the same model (Cmax)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{stratified\_ratios\_CMIN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-var-4.pdf}}

\section{Model performance}\label{model-performance}

In this section, the focus is no longer solely on observed
concentrations (IPRED), but the performance of the models is explored by
illustrating how the predicted concentrations (PRED) for \textbf{all}
the cohorts (not just for covariates on which the model was developed)
compare the the observed concentration. Visualization of PRED/IPRED
ratios. In all cases we compare PRED (predicted) values to a reference
IPRED (observed), which is the IPRED of the model whose cohort was used
to simulate a particular set of covariates. Red lines indicate the
bioequivalence range of 80-125 \%.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# IPRED}

\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_SIM\_QL3 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID, TIME) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ref\_IPRED =} \FunctionTok{first}\NormalTok{(IPRED[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{], }\AttributeTok{default =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{ratio =}\NormalTok{ (PRED }\SpecialCharTok{/}\NormalTok{ ref\_IPRED) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{perf\_SIM }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Boxplots of predicted/observed ratios"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{perf\_SIM }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CMAX}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_CMAX3 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMAX2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ref\_CMAX =} \FunctionTok{first}\NormalTok{(CMAX\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{], }\AttributeTok{default =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{ratio =}\NormalTok{ (CMAX\_PRED }\SpecialCharTok{/}\NormalTok{ ref\_CMAX) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{perf\_CMAX }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_CMAX3, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Boxplots of predicted/observed ratios (Cmax)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{perf\_CMAX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# AUC}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_AUC3 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_AUC2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ref\_AUC =} \FunctionTok{first}\NormalTok{(AUC\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{], }\AttributeTok{default =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{ratio =}\NormalTok{ (AUC\_PRED }\SpecialCharTok{/}\NormalTok{ ref\_AUC) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{perf\_AUC }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_AUC3, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Boxplots of predicted/observed ratios (AUC)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{perf\_AUC}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CMIN}
\CommentTok{\# Divide each PRED by the IPRED reference }
\NormalTok{AMOX\_CMIN3 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{ref\_CMIN =} \FunctionTok{first}\NormalTok{(CMIN\_IND[REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{], }\AttributeTok{default =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{ratio =}\NormalTok{ (CMIN\_PRED }\SpecialCharTok{/}\NormalTok{ ref\_CMIN) }\SpecialCharTok{*} \DecValTok{100}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Boxplot of ratios stratified by model}
\NormalTok{perf\_CMIN }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(AMOX\_CMIN3, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ MODEL, }\AttributeTok{y =}\NormalTok{ ratio, }\AttributeTok{fill =}\NormalTok{ MODEL)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_log10}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{80}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{125}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Boxplots of predicted/observed ratios (CMIN)"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"MODEL"}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Ratio (\%)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
\NormalTok{  )}

\NormalTok{perf\_CMIN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Simulation_Carlier_Fournier_Mellon_Rambaud_files/figure-pdf/Ratios-4.pdf}}

\bookmarksetup{startatroot}

\chapter{Precision dosing approaches}\label{precision-dosing-approaches}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load stpbrioche package from tar.gz file}
\FunctionTok{install.packages}\NormalTok{(}\StringTok{"stp{-}brioche{-}R{-}package/stpbrioche\_0.0.0.9000.tar.gz"}\NormalTok{, }\AttributeTok{repos =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{type =} \StringTok{"source"}\NormalTok{)}

\FunctionTok{library}\NormalTok{(stpbrioche)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(here)}
\FunctionTok{library}\NormalTok{(tidyr)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Single model approach}\label{single-model-approach}

\section{CARLIER}\label{carlier}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Import the data}
\NormalTok{AMOX\_CMIN\_TEST }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"AMOX\_CMIN\_TEST.csv"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}

\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(MODEL}\SpecialCharTok{==}\StringTok{"CARLIER"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{CMIN\_PRED) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{explore\_predictions }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{conc\_inf =} \DecValTok{40}\NormalTok{, }\AttributeTok{conc\_sup =} \DecValTok{80}\NormalTok{, }\AttributeTok{max\_dose\_g =} \DecValTok{20}\NormalTok{, }\AttributeTok{freq\_column =} \StringTok{"FREQ"}\NormalTok{) \{}
  \FunctionTok{library}\NormalTok{(dplyr)}
  \FunctionTok{library}\NormalTok{(ggplot2)}
  \FunctionTok{library}\NormalTok{(tidyr)}

  \CommentTok{\# Calculate true dose range and prediction correctness}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}
      \AttributeTok{DOSE\_inf =}\NormalTok{ (conc\_inf }\SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM,}
      \AttributeTok{DOSE\_sup =}\NormalTok{ (conc\_sup }\SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}
      \AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{(}
\NormalTok{        (DOSE\_PRED }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ DOSE\_PRED }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|}
\NormalTok{          (DOSE\_PRED }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{24} \SpecialCharTok{/} \SpecialCharTok{!!}\FunctionTok{sym}\NormalTok{(freq\_column)) }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_dose\_g }\SpecialCharTok{*} \DecValTok{1000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{24} \SpecialCharTok{/} \SpecialCharTok{!!}\FunctionTok{sym}\NormalTok{(freq\_column)) }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_dose\_g }\SpecialCharTok{*} \DecValTok{1000}\NormalTok{),}
        \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}
\NormalTok{      )}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}
      \AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{        Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{        DOSE\_PRED }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{        DOSE\_PRED }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{      )}
\NormalTok{    )}

  \CommentTok{\# Proportions of under{-} and overdosing}
\NormalTok{  dosing }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}
      \AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
      \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
      \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{)}
\NormalTok{    )}

  \CommentTok{\# Over/underdosed graph}
\NormalTok{  p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(dosing, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =}\NormalTok{ Proportion, }\AttributeTok{fill =}\NormalTok{ Dosing)) }\SpecialCharTok{+}
    \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{width =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ Label), }\AttributeTok{position =} \FunctionTok{position\_stack}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.5}\NormalTok{), }\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Underdosed"} \OtherTok{=} \StringTok{"darkorange"}\NormalTok{, }\StringTok{"On target"} \OtherTok{=} \StringTok{"chartreuse4"}\NormalTok{, }\StringTok{"Overdosed"} \OtherTok{=} \StringTok{"\#A91A27"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =} \StringTok{"\%"}\NormalTok{, }\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{title =} \StringTok{"Target attainment"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Dosing Category"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
      \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.ticks.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
      \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
      \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
      \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{    ) }\SpecialCharTok{+}
    \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{10}\NormalTok{))}

  \CommentTok{\# CREAT binning (based on the American Kidney Fund\textquotesingle{}s categories)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

  \CommentTok{\# Binning stats}
\NormalTok{  bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

  \CommentTok{\# Binning graph}
\NormalTok{  p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
    \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }\AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Target attainement by serum creatinine level"}\NormalTok{, }\AttributeTok{x =} \StringTok{"Serum creatinine"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Correct predictions (\%)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
      \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{24}\NormalTok{),}
      \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
      \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)}
\NormalTok{    ) }\SpecialCharTok{+}
    \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

  \CommentTok{\# Summary statistics}
\NormalTok{  summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{summarise}\NormalTok{(}
      \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{mean\_AGE =} \FunctionTok{mean}\NormalTok{(AGE, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{sd\_AGE =} \FunctionTok{sd}\NormalTok{(AGE, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
      \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{  correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{pull}\NormalTok{(Proportion)}

  \FunctionTok{message}\NormalTok{(}\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions: \%.2f\%\%"}\NormalTok{, correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{))}

  \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
    \AttributeTok{target\_attainment =}\NormalTok{ p1,}
    \AttributeTok{crcl\_plot =}\NormalTok{ p2,}
    \AttributeTok{summary\_stats =}\NormalTok{ summary\_stats}
\NormalTok{  ))}
\NormalTok{\}}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-carlier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-carlier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/Carlier.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.974    0.662    84.5  18.3     61.2   15.0   292
2 Incorrect                   0.927    0.485    84.6  19.1     58.4   17.7   308
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\section{FOURNIER}\label{fournier}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(MODEL}\SpecialCharTok{==}\StringTok{"FOURNIER"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{CMIN\_PRED) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-fournier-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-fournier-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/Fournier.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.807    0.345    86.0  18.8     59.7   16.3   293
2 Incorrect                   1.09     0.709    83.1  18.4     59.9   16.7   307
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\section{MELLON}\label{mellon}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(MODEL}\SpecialCharTok{==}\StringTok{"MELLON"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{CMIN\_PRED) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-mellon-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-mellon-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/Mellon.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.754    0.323    89.1  20.0     57.2   15.1   273
2 Incorrect                   1.11     0.684    80.7  16.5     61.9   17.3   327
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\section{RAMBAUD}\label{rambaud}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(MODEL}\SpecialCharTok{==}\StringTok{"RAMBAUD"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{CMIN\_PRED) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-rambaud-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-rambaud-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/Rambaud.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.969    0.518    80.0  15.6     65.1   18.8   182
2 Incorrect                   0.941    0.602    86.5  19.5     57.5   14.9   418
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\bookmarksetup{startatroot}

\chapter{Standard dose}\label{standard-dose}

Based on the The
\href{https://www.infectiologie.com/UserFiles/File/spilf/recos/doses-spilf-sfpt-casfm-2023.pdf}{SPILF}
recommendation and our standard dose screening 200 mg/kg/day is given to
each patient.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{200} \SpecialCharTok{*}\NormalTok{ WT) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{24}\SpecialCharTok{/}\NormalTok{FREQ)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(ID, CREAT, WT, BURN, SEX, AGE, HT, FREQ, DOSE\_ADM, DOSE\_PRED, CMIN\_IND, SEX, BSA) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{()}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-standard-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/dose-simulation-standard-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.851    0.367    77.9  13.1     61.5   16.7   179
2 Incorrect                   0.992    0.643    87.3  19.9     59.1   16.4   421
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\bookmarksetup{startatroot}

\chapter{Uninformed model ensembling}\label{uninformed-model-ensembling}

All the models are given the same weight (one quarter in this case). The
performance of the models or the development cohort characteristics are
not taken into account.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST}

\NormalTok{test\_data2}\SpecialCharTok{$}\NormalTok{WEIGHT }\OtherTok{\textless{}{-}} \FloatTok{0.25}

\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ test\_data2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{WEIGHTED\_PRED =}\NormalTok{ CMIN\_PRED }\SpecialCharTok{*}\NormalTok{ WEIGHT) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(ID) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{WEIGHTED\_PREDICTION =} \FunctionTok{sum}\NormalTok{(WEIGHTED\_PRED)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(ID, CREAT, WT, BURN, SEX, AGE, HT, FREQ, DOSE\_ADM, WEIGHTED\_PREDICTION, CMIN\_IND, SEX) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{WEIGHTED\_PREDICTION) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/uninformed-dose-simulation-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/uninformed-dose-simulation-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.847    0.407    86.5  19.3     60.6   17.0   324
2 Incorrect                   1.07     0.711    82.2  17.7     58.8   15.9   276
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\bookmarksetup{startatroot}

\chapter{Nomogram}\label{nomogram}

The nomogram developed by Rambaud et al. (2020) in Nantes which predicts
the dose in endocarditis patients based solely on absolute glomerular
filtration rate.

The dose in g to reach 20 mg/L is predicted by the nomogram based on
CREAT (x) \[
\text{Dose} = 0.0001x^2 + 0.0613x + 1.157
\] and then extrapolated to attain 60 mg/L.

The nomogram was originally validated only between 30 and 120 mL/min,
however in this case it is used partly outside of this interval.

CRCL is calculated based on the CKD-EPI equation used in the original
article.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{SEX =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \StringTok{"M"}\NormalTok{,}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \StringTok{"F"}
\NormalTok{    )}
\NormalTok{  )}

\NormalTok{test\_data2}\SpecialCharTok{$}\NormalTok{CRCL }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(estimate\_GFR, test\_data2}\SpecialCharTok{$}\NormalTok{AGE, test\_data2}\SpecialCharTok{$}\NormalTok{CREAT, test\_data2}\SpecialCharTok{$}\NormalTok{SEX)}

\CommentTok{\# Convert ml/min/1.73 m2 to ml/min}
\NormalTok{test\_data2 }\OtherTok{\textless{}{-}}\NormalTok{ test\_data2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CRCL =}\NormalTok{ CRCL }\SpecialCharTok{*}\NormalTok{ (BSA}\SpecialCharTok{/}\FloatTok{1.73}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ ((}\FloatTok{0.0001} \SpecialCharTok{*}\NormalTok{ CRCL}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+} \FloatTok{0.0613} \SpecialCharTok{*}\NormalTok{ CRCL }\SpecialCharTok{+} \FloatTok{1.157}\NormalTok{) }\SpecialCharTok{*} \DecValTok{3000}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{24}\SpecialCharTok{/}\NormalTok{FREQ)) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Multiplied by 3000 to convert g to mg and to extrapolate 20 mg/L to 60 mg/L and divided by the interdose interval}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(ID, CREAT, WT, BURN, SEX, AGE, HT, FREQ, DOSE\_ADM, DOSE\_PRED, CMIN\_IND, SEX) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{()}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data2)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/nomogram-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/nomogram-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.978    0.594    75.3  13.0     64.9   19.6   140
2 Incorrect                   0.941    0.573    87.3  19.2     58.3   15.1   460
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\bookmarksetup{startatroot}

\chapter{Classification tree informed
ensembling}\label{classification-tree-informed-ensembling}

This method is used to attribute weights to models based on their
probability to give correct predictions for a set of covariates.

The method is based on Agema et al. (2024).

In the original method, model predicted concentrations are compared to
true concentrations. In this adaptation. Bioequivalence ratios between
\(Cmin_{\text{pred}}\) and \(Cmin_{\text{ind}}\) are calculated and
transformed to a binary variable based on if the ratio is in the
bioequivalence range {[}0.80-1.25{]} or not. This categorical variable
is called CORRECT.

First, for each set of covariates, the ratios between the predicted
values of the 4 models are compared to the observed value. Then, we add
the variable CORRECT which takes the value of YES if the ratio is in the
bioequivalence range, and the value of NO, if not.

Then, decision tree is developed where the predictors are the covariates
and the target variable is the categorical variable named CORRECT. A
decision tree is fitted separately for each MODEL where the following
parameters need to be defined

- \textbf{Complexity} -- a penalty that the information gain has to
overcome to add a split. A higher complexity value leads to a smaller
tree meaning that subjects are divided into smaller number of
categories, so their scores will be less diverse. Comlexity is found by
automatic hyperparameter tuning based on cross-validation error.\\
\textbf{Minsplit} -- minimum number of samples to split a node (smaller
value, deeper tree).\\
\textbf{Minbucket} -- minimum number of samples in the terminal node
(smaller value, deeper tree). Minsplit and minbucket in the range of
2-30 range does not affect the results , so 4 is fixed as a value to
have deeper trees.\\
- \textbf{xval} -- number of cross validations. 5-fold cross validation
is used (the same number as for the ML methods).\\
- \textbf{splitting criterion} - entropy or Gini impurity. Gini
meausures the frequency (f) with which an element is misclassified:

\[ 
  Gini\ impurity = 2 \cdot f \cdot \left(1 - f \right) \
\] Entropy (called information in rpart) measures the disorder of the
predictors as a function of the target:

\[ 
  Entropy = f \cdot log_2(f)
\]

Normally, the two splitting criteria give similar results. Entropy is
more computationally complex as it uses logarithms.

For certain models, the root node is not split any further (same model
score for all subjects).\\
In the obtained leaf\_results table, only the leaf nodes are included
with the following columns

\begin{itemize}
\item
  \textbf{node} - node number
\item
  \textbf{var} - splitting variable (it always says leaf, as only leaves
  are included in the table)
\item
  \textbf{n}- number of subjects per node
\item
  \textbf{wt} - subject weight (all the subject have the same weight)
\item
  \textbf{dev} - Gini index
\item
  \textbf{yval} - the predicted class
\item
  \textbf{ncompete} - Alternative splitting variables that were not
  selected for a node but give slightly worse performance than the
  selected variable. As only leaves are included, there are no competing
  splitting variables.
\item
  \textbf{nsurrogate} - Used for missing values. Not applicable to
  leaves.
\item
  \textbf{yval2{[}, 2{]}} - number of YES for the CORRECT variable
\item
  \textbf{yval2{[}, 3{]}} - number of NO
\item
  \textbf{yval2{[}, 4{]}} - proportion of YES
\item
  \textbf{yval2{[}, 5{]}} - proportion of NO
\item
  \textbf{prob\_yes} - same as yval2{[}, 4{]}, this column is used later
  to attribute model weights
\item
  \textbf{n\_obs} - number of observations
\end{itemize}

To this table, in the path column is added containing all the decisions
that led to that particular leaf. Then, this string is transformed to
lower and upper limits for continuous and categories for categorical
covariates. If there are no upper or lower limits or selected
categories, NA is added.

In the original method ( Agema et al. (2024)), the leaves are selected
with at least a YES proportion of 0.5 and then the selected models are
taken into account with equal weight. Here, all models are used with
their respective YES proportions. This way, no subject will end up
without a model, and the weights will be more nuancedly calculated.
Then, for each subjects the 4 corresponding nodes are found based on its
covariates (1 for each model). The probabilites (proportions) of having
YES (=prob\_yes or score) are normalized by their sum for each subject,
so that the scores of the models for a subject will always add up to 1.
These normalized scores (=weights) are used to ensemble the model
predictions.

Finally, the method is tested by ensembling the predictions of the test
data using the weights calibrated base on the training data. The
administered dose is extrapolated by dividing the weighted concentration
prediction by the target concentration (= 60 mg/L).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Import or generate training and test data}
\NormalTok{AMOX\_CMIN\_TRAIN }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"AMOX\_CMIN\_TRAIN.csv"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}

\NormalTok{AMOX\_CMIN\_TEST }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"AMOX\_CMIN\_TEST.csv"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{leaf\_results }\OtherTok{\textless{}{-}} \FunctionTok{classification\_tree\_model\_ensembling\_train}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN, }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{, }
  \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-1.pdf}}

\begin{verbatim}

 node number: 1 
   root
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-2.pdf}}

\begin{verbatim}

 node number: 1 
   root
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-3.pdf}}

\begin{verbatim}

 node number: 2 
   root
   ICU=1

 node number: 48 
   root
   ICU=0
   WT< 110.3
   WT>=99.06
   AGE< 60.94
   CREAT>=0.8672

 node number: 98 
   root
   ICU=0
   WT< 110.3
   WT>=99.06
   AGE< 60.94
   CREAT< 0.8672
   SEX=1

 node number: 99 
   root
   ICU=0
   WT< 110.3
   WT>=99.06
   AGE< 60.94
   CREAT< 0.8672
   SEX=0

 node number: 25 
   root
   ICU=0
   WT< 110.3
   WT>=99.06
   AGE>=60.94

 node number: 26 
   root
   ICU=0
   WT< 110.3
   WT< 99.06
   CREAT>=0.8146

 node number: 27 
   root
   ICU=0
   WT< 110.3
   WT< 99.06
   CREAT< 0.8146

 node number: 56 
   root
   ICU=0
   WT>=110.3
   CREAT< 1.017
   CREAT>=0.7228
   AGE< 57.18

 node number: 57 
   root
   ICU=0
   WT>=110.3
   CREAT< 1.017
   CREAT>=0.7228
   AGE>=57.18

 node number: 29 
   root
   ICU=0
   WT>=110.3
   CREAT< 1.017
   CREAT< 0.7228

 node number: 15 
   root
   ICU=0
   WT>=110.3
   CREAT>=1.017
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-4.pdf}}

\begin{verbatim}

 node number: 2 
   root
   BURN=1

 node number: 6 
   root
   BURN=0
   ICU=0

 node number: 112 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT>=71.19
   WT< 77.38

 node number: 226 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT>=71.19
   WT>=77.38
   WT>=77.67

 node number: 227 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT>=71.19
   WT>=77.38
   WT< 77.67

 node number: 114 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT< 71.19
   AGE< 48.11

 node number: 460 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT< 71.19
   AGE>=48.11
   WT< 70.97
   AGE>=50.13

 node number: 461 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT< 71.19
   AGE>=48.11
   WT< 70.97
   AGE< 50.13

 node number: 231 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE< 76.52
   WT< 71.19
   AGE>=48.11
   WT>=70.97

 node number: 58 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT>=1.577

 node number: 236 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT>=0.9737

 node number: 1896 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT< 0.4149

 node number: 7588 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE< 80.18

 node number: 15178 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT>=0.8007

 node number: 30358 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT< 0.8007
   WT>=72.39

 node number: 242872 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT< 0.8007
   WT< 72.39
   AGE>=83.96
   CREAT>=0.5592
   AGE>=88.03

 node number: 242873 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT< 0.8007
   WT< 72.39
   AGE>=83.96
   CREAT>=0.5592
   AGE< 88.03

 node number: 121437 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT< 0.8007
   WT< 72.39
   AGE>=83.96
   CREAT< 0.5592

 node number: 60719 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT< 76.64
   AGE>=80.18
   CREAT< 0.8007
   WT< 72.39
   AGE< 83.96

 node number: 3795 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE>=77.75
   CREAT>=0.4149
   WT>=76.64

 node number: 949 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT< 0.9304
   AGE< 77.75

 node number: 475 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT< 1.011
   CREAT< 0.9737
   CREAT>=0.9304

 node number: 952 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT>=65.15
   AGE< 89.46
   AGE>=87.03

 node number: 3812 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT>=65.15
   AGE< 89.46
   AGE< 87.03
   WT>=77.08
   WT< 83.4

 node number: 3813 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT>=65.15
   AGE< 89.46
   AGE< 87.03
   WT>=77.08
   WT>=83.4

 node number: 1907 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT>=65.15
   AGE< 89.46
   AGE< 87.03
   WT< 77.08

 node number: 477 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT>=65.15
   AGE>=89.46

 node number: 239 
   root
   BURN=0
   ICU=1
   OBESE=0
   AGE>=76.52
   CREAT< 1.577
   CREAT>=1.011
   WT< 65.15

 node number: 60 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT>=1.934

 node number: 244 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT< 80.79

 node number: 490 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT>=103.8

 node number: 1964 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT>=99.57

 node number: 15720 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT< 98.61
   CREAT>=0.9715
   AGE< 65.87

 node number: 31442 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT< 98.61
   CREAT>=0.9715
   AGE>=65.87
   WT< 85.18

 node number: 62886 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT< 98.61
   CREAT>=0.9715
   AGE>=65.87
   WT>=85.18
   WT>=91.93

 node number: 62887 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT< 98.61
   CREAT>=0.9715
   AGE>=65.87
   WT>=85.18
   WT< 91.93

 node number: 7861 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT< 98.61
   CREAT< 0.9715

 node number: 3931 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT< 100.7
   WT< 99.57
   WT>=98.61

 node number: 983 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT< 1.302
   WT>=80.79
   WT< 103.8
   WT>=100.7

 node number: 123 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT>=0.6667
   CREAT< 1.934
   CREAT>=1.302

 node number: 31 
   root
   BURN=0
   ICU=1
   OBESE=1
   CREAT< 0.6667
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{leaf\_results}\SpecialCharTok{$}\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$obj
n= 1874 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

     1) root 1874 316 NO (0.83137673 0.16862327)  
       2) BURN=1 474  19 NO (0.95991561 0.04008439) *
       3) BURN=0 1400 297 NO (0.78785714 0.21214286)  
         6) ICU=0 475  35 NO (0.92631579 0.07368421) *
         7) ICU=1 925 262 NO (0.71675676 0.28324324)  
          14) OBESE=0 818 200 NO (0.75550122 0.24449878)  
            28) AGE< 76.51867 645 125 NO (0.80620155 0.19379845)  
              56) WT>=71.18937 424  68 NO (0.83962264 0.16037736)  
               112) WT< 77.3848 189  21 NO (0.88888889 0.11111111) *
               113) WT>=77.3848 235  47 NO (0.80000000 0.20000000)  
                 226) WT>=77.67003 225  40 NO (0.82222222 0.17777778) *
                 227) WT< 77.67003 10   3 YES (0.30000000 0.70000000) *
              57) WT< 71.18937 221  57 NO (0.74208145 0.25791855)  
               114) AGE< 48.10625 20   1 NO (0.95000000 0.05000000) *
               115) AGE>=48.10625 201  56 NO (0.72139303 0.27860697)  
                 230) WT< 70.96832 196  52 NO (0.73469388 0.26530612)  
                   460) AGE>=50.12609 192  49 NO (0.74479167 0.25520833) *
                   461) AGE< 50.12609 4   1 YES (0.25000000 0.75000000) *
                 231) WT>=70.96832 5   1 YES (0.20000000 0.80000000) *
            29) AGE>=76.51867 173  75 NO (0.56647399 0.43352601)  
              58) CREAT>=1.576588 30   7 NO (0.76666667 0.23333333) *
              59) CREAT< 1.576588 143  68 NO (0.52447552 0.47552448)  
               118) CREAT< 1.010967 83  34 NO (0.59036145 0.40963855)  
                 236) CREAT>=0.9737384 5   0 NO (1.00000000 0.00000000) *
                 237) CREAT< 0.9737384 78  34 NO (0.56410256 0.43589744)  
                   474) CREAT< 0.930365 74  30 NO (0.59459459 0.40540541)  
                     948) AGE>=77.75346 69  26 NO (0.62318841 0.37681159)  
                      1896) CREAT< 0.4149334 5   0 NO (1.00000000 0.00000000) *
                      1897) CREAT>=0.4149334 64  26 NO (0.59375000 0.40625000)  
                        3794) WT< 76.63611 55  20 NO (0.63636364 0.36363636)  
                          7588) AGE< 80.18479 9   1 NO (0.88888889 0.11111111) *
                          7589) AGE>=80.18479 46  19 NO (0.58695652 0.41304348)  
                           15178) CREAT>=0.8007288 17   4 NO (0.76470588 0.23529412) *
                           15179) CREAT< 0.8007288 29  14 YES (0.48275862 0.51724138)  
                             30358) WT>=72.38778 6   1 NO (0.83333333 0.16666667) *
                             30359) WT< 72.38778 23   9 YES (0.39130435 0.60869565)  
                               60718) AGE>=83.95843 18   9 NO (0.50000000 0.50000000)  
                                121436) CREAT>=0.559171 14   6 NO (0.57142857 0.42857143)  
                                  242872) AGE>=88.03227 8   2 NO (0.75000000 0.25000000) *
                                  242873) AGE< 88.03227 6   2 YES (0.33333333 0.66666667) *
                                121437) CREAT< 0.559171 4   1 YES (0.25000000 0.75000000) *
                               60719) AGE< 83.95843 5   0 YES (0.00000000 1.00000000) *
                        3795) WT>=76.63611 9   3 YES (0.33333333 0.66666667) *
                     949) AGE< 77.75346 5   1 YES (0.20000000 0.80000000) *
                   475) CREAT>=0.930365 4   0 YES (0.00000000 1.00000000) *
               119) CREAT>=1.010967 60  26 YES (0.43333333 0.56666667)  
                 238) WT>=65.14759 47  23 YES (0.48936170 0.51063830)  
                   476) AGE< 89.46364 37  17 NO (0.54054054 0.45945946)  
                     952) AGE>=87.02657 5   0 NO (1.00000000 0.00000000) *
                     953) AGE< 87.02657 32  15 YES (0.46875000 0.53125000)  
                      1906) WT>=77.07967 20   8 NO (0.60000000 0.40000000)  
                        3812) WT< 83.40094 11   2 NO (0.81818182 0.18181818) *
                        3813) WT>=83.40094 9   3 YES (0.33333333 0.66666667) *
                      1907) WT< 77.07967 12   3 YES (0.25000000 0.75000000) *
                   477) AGE>=89.46364 10   3 YES (0.30000000 0.70000000) *
                 239) WT< 65.14759 13   3 YES (0.23076923 0.76923077) *
          15) OBESE=1 107  45 YES (0.42056075 0.57943925)  
            30) CREAT>=0.6666848 101  45 YES (0.44554455 0.55445545)  
              60) CREAT>=1.934351 5   1 NO (0.80000000 0.20000000) *
              61) CREAT< 1.934351 96  41 YES (0.42708333 0.57291667)  
               122) CREAT< 1.302084 63  31 NO (0.50793651 0.49206349)  
                 244) WT< 80.78733 4   0 NO (1.00000000 0.00000000) *
                 245) WT>=80.78733 59  28 YES (0.47457627 0.52542373)  
                   490) WT>=103.7747 8   2 NO (0.75000000 0.25000000) *
                   491) WT< 103.7747 51  22 YES (0.43137255 0.56862745)  
                     982) WT< 100.656 47  22 YES (0.46808511 0.53191489)  
                      1964) WT>=99.56741 5   1 NO (0.80000000 0.20000000) *
                      1965) WT< 99.56741 42  18 YES (0.42857143 0.57142857)  
                        3930) WT< 98.61215 38  18 YES (0.47368421 0.52631579)  
                          7860) CREAT>=0.9715392 22   9 NO (0.59090909 0.40909091)  
                           15720) AGE< 65.86802 4   0 NO (1.00000000 0.00000000) *
                           15721) AGE>=65.86802 18   9 NO (0.50000000 0.50000000)  
                             31442) WT< 85.17611 5   1 NO (0.80000000 0.20000000) *
                             31443) WT>=85.17611 13   5 YES (0.38461538 0.61538462)  
                               62886) WT>=91.93177 6   2 NO (0.66666667 0.33333333) *
                               62887) WT< 91.93177 7   1 YES (0.14285714 0.85714286) *
                          7861) CREAT< 0.9715392 16   5 YES (0.31250000 0.68750000) *
                        3931) WT>=98.61215 4   0 YES (0.00000000 1.00000000) *
                     983) WT>=100.656 4   0 YES (0.00000000 1.00000000) *
               123) CREAT>=1.302084 33   9 YES (0.27272727 0.72727273) *
            31) CREAT< 0.6666848 6   0 YES (0.00000000 1.00000000) *

$snipped.nodes
NULL

$xlim
[1] 0 1

$ylim
[1] 0 1

$x
 [1] 0.153809757 0.008790483 0.298829031 0.033350959 0.564307103 0.242032556
 [7] 0.117777595 0.076331792 0.057911435 0.094752149 0.082471911 0.107032387
[13] 0.159223398 0.131592862 0.186853933 0.168433576 0.156153338 0.180713814
[19] 0.205274290 0.366287517 0.229834766 0.502740268 0.363490285 0.254395242
[25] 0.472585328 0.420610181 0.341220361 0.278955717 0.403485005 0.331530486
[31] 0.303516193 0.359544779 0.328076669 0.391012888 0.352637145 0.429388632
[37] 0.407898216 0.389477859 0.377197621 0.401758097 0.426318572 0.450879048
[43] 0.475439524 0.500000000 0.524560476 0.641990251 0.612057171 0.576751487
[49] 0.549120952 0.604382022 0.585961665 0.573681428 0.598241903 0.622802379
[55] 0.647362855 0.671923331 0.886581650 0.781953783 0.696483807 0.867423759
[61] 0.768198477 0.721044283 0.815352672 0.745604758 0.885100586 0.828112607
[67] 0.770165234 0.886059980 0.854591870 0.816216126 0.794725710 0.837706543
[73] 0.819286186 0.856126900 0.843846662 0.868407138 0.892967613 0.917528089
[79] 0.942088565 0.966649041 0.991209517

$y
 [1] 0.97297037 0.01664697 0.92183008 0.01664697 0.87068979 0.81954950
 [7] 0.76840921 0.71726892 0.01664697 0.66612864 0.01664697 0.01664697
[13] 0.71726892 0.01664697 0.66612864 0.61498835 0.01664697 0.01664697
[19] 0.01664697 0.76840921 0.01664697 0.71726892 0.66612864 0.01664697
[25] 0.61498835 0.56384806 0.51270777 0.01664697 0.46156748 0.41042719
[31] 0.01664697 0.35928690 0.01664697 0.30814661 0.01664697 0.25700633
[37] 0.20586604 0.15472575 0.01664697 0.01664697 0.01664697 0.01664697
[43] 0.01664697 0.01664697 0.01664697 0.66612864 0.61498835 0.56384806
[49] 0.01664697 0.51270777 0.46156748 0.01664697 0.01664697 0.01664697
[55] 0.01664697 0.01664697 0.81954950 0.76840921 0.01664697 0.71726892
[61] 0.66612864 0.01664697 0.61498835 0.01664697 0.56384806 0.51270777
[67] 0.01664697 0.46156748 0.41042719 0.35928690 0.01664697 0.30814661
[73] 0.01664697 0.25700633 0.01664697 0.01664697 0.01664697 0.01664697
[79] 0.01664697 0.01664697 0.01664697

$branch.x
       [,1]        [,2]      [,3]       [,4]      [,5]      [,6]      [,7]
x 0.1538098 0.008790483 0.2988290 0.03335096 0.5643071 0.2420326 0.1177776
         NA 0.008790483 0.2988290 0.03335096 0.5643071 0.2420326 0.1177776
         NA 0.153809757 0.1538098 0.29882903 0.2988290 0.5643071 0.2420326
        [,8]       [,9]      [,10]      [,11]      [,12]     [,13]     [,14]
x 0.07633179 0.05791143 0.09475215 0.08247191 0.10703239 0.1592234 0.1315929
  0.07633179 0.05791143 0.09475215 0.08247191 0.10703239 0.1592234 0.1315929
  0.11777759 0.07633179 0.07633179 0.09475215 0.09475215 0.1177776 0.1592234
      [,15]     [,16]     [,17]     [,18]     [,19]     [,20]     [,21]
x 0.1868539 0.1684336 0.1561533 0.1807138 0.2052743 0.3662875 0.2298348
  0.1868539 0.1684336 0.1561533 0.1807138 0.2052743 0.3662875 0.2298348
  0.1592234 0.1868539 0.1684336 0.1684336 0.1868539 0.2420326 0.3662875
      [,22]     [,23]     [,24]     [,25]     [,26]     [,27]     [,28]
x 0.5027403 0.3634903 0.2543952 0.4725853 0.4206102 0.3412204 0.2789557
  0.5027403 0.3634903 0.2543952 0.4725853 0.4206102 0.3412204 0.2789557
  0.3662875 0.5027403 0.3634903 0.3634903 0.4725853 0.4206102 0.3412204
      [,29]     [,30]     [,31]     [,32]     [,33]     [,34]     [,35]
x 0.4034850 0.3315305 0.3035162 0.3595448 0.3280767 0.3910129 0.3526371
  0.4034850 0.3315305 0.3035162 0.3595448 0.3280767 0.3910129 0.3526371
  0.3412204 0.4034850 0.3315305 0.3315305 0.3595448 0.3595448 0.3910129
      [,36]     [,37]     [,38]     [,39]     [,40]     [,41]     [,42]
x 0.4293886 0.4078982 0.3894779 0.3771976 0.4017581 0.4263186 0.4508790
  0.4293886 0.4078982 0.3894779 0.3771976 0.4017581 0.4263186 0.4508790
  0.3910129 0.4293886 0.4078982 0.3894779 0.3894779 0.4078982 0.4293886
      [,43]     [,44]     [,45]     [,46]     [,47]     [,48]     [,49]
x 0.4754395 0.5000000 0.5245605 0.6419903 0.6120572 0.5767515 0.5491210
  0.4754395 0.5000000 0.5245605 0.6419903 0.6120572 0.5767515 0.5491210
  0.4034850 0.4206102 0.4725853 0.5027403 0.6419903 0.6120572 0.5767515
      [,50]     [,51]     [,52]     [,53]     [,54]     [,55]     [,56]
x 0.6043820 0.5859617 0.5736814 0.5982419 0.6228024 0.6473629 0.6719233
  0.6043820 0.5859617 0.5736814 0.5982419 0.6228024 0.6473629 0.6719233
  0.5767515 0.6043820 0.5859617 0.5859617 0.6043820 0.6120572 0.6419903
      [,57]     [,58]     [,59]     [,60]     [,61]     [,62]     [,63]
x 0.8865816 0.7819538 0.6964838 0.8674238 0.7681985 0.7210443 0.8153527
  0.8865816 0.7819538 0.6964838 0.8674238 0.7681985 0.7210443 0.8153527
  0.5643071 0.8865816 0.7819538 0.7819538 0.8674238 0.7681985 0.7681985
      [,64]     [,65]     [,66]     [,67]     [,68]     [,69]     [,70]
x 0.7456048 0.8851006 0.8281126 0.7701652 0.8860600 0.8545919 0.8162161
  0.7456048 0.8851006 0.8281126 0.7701652 0.8860600 0.8545919 0.8162161
  0.8153527 0.8153527 0.8851006 0.8281126 0.8281126 0.8860600 0.8545919
      [,71]     [,72]     [,73]     [,74]     [,75]     [,76]     [,77]
x 0.7947257 0.8377065 0.8192862 0.8561269 0.8438467 0.8684071 0.8929676
  0.7947257 0.8377065 0.8192862 0.8561269 0.8438467 0.8684071 0.8929676
  0.8162161 0.8162161 0.8377065 0.8377065 0.8561269 0.8561269 0.8545919
      [,78]     [,79]     [,80]     [,81]
x 0.9175281 0.9420886 0.9666490 0.9912095
  0.9175281 0.9420886 0.9666490 0.9912095
  0.8860600 0.8851006 0.8674238 0.8865816

$branch.y
       [,1]       [,2]      [,3]       [,4]      [,5]      [,6]      [,7]
y 0.9990631 0.04273971 0.9425712 0.04273971 0.8914309 0.8402906 0.7891503
         NA 0.94257117 0.9425712 0.89143089 0.8914309 0.8402906 0.7891503
         NA 0.94257117 0.9425712 0.89143089 0.8914309 0.8402906 0.7891503
     [,8]       [,9]     [,10]      [,11]      [,12]   [,13]      [,14]
y 0.73801 0.04273971 0.6868697 0.04273971 0.04273971 0.73801 0.04273971
  0.73801 0.68686973 0.6868697 0.63572944 0.63572944 0.73801 0.68686973
  0.73801 0.68686973 0.6868697 0.63572944 0.63572944 0.73801 0.68686973
      [,15]     [,16]      [,17]      [,18]      [,19]     [,20]      [,21]
y 0.6868697 0.6357294 0.04273971 0.04273971 0.04273971 0.7891503 0.04273971
  0.6868697 0.6357294 0.58458915 0.58458915 0.63572944 0.7891503 0.73801002
  0.6868697 0.6357294 0.58458915 0.58458915 0.63572944 0.7891503 0.73801002
    [,22]     [,23]      [,24]     [,25]     [,26]     [,27]      [,28]
y 0.73801 0.6868697 0.04273971 0.6357294 0.5845892 0.5334489 0.04273971
  0.73801 0.6868697 0.63572944 0.6357294 0.5845892 0.5334489 0.48230858
  0.73801 0.6868697 0.63572944 0.6357294 0.5845892 0.5334489 0.48230858
      [,29]     [,30]      [,31]    [,32]      [,33]     [,34]      [,35]
y 0.4823086 0.4311683 0.04273971 0.380028 0.04273971 0.3288877 0.04273971
  0.4823086 0.4311683 0.38002800 0.380028 0.32888771 0.3288877 0.27774742
  0.4823086 0.4311683 0.38002800 0.380028 0.32888771 0.3288877 0.27774742
      [,36]     [,37]     [,38]      [,39]      [,40]      [,41]      [,42]
y 0.2777474 0.2266071 0.1754668 0.04273971 0.04273971 0.04273971 0.04273971
  0.2777474 0.2266071 0.1754668 0.12432655 0.12432655 0.17546684 0.22660713
  0.2777474 0.2266071 0.1754668 0.12432655 0.12432655 0.17546684 0.22660713
       [,43]      [,44]      [,45]     [,46]     [,47]     [,48]      [,49]
y 0.04273971 0.04273971 0.04273971 0.6868697 0.6357294 0.5845892 0.04273971
  0.43116829 0.53344886 0.58458915 0.6868697 0.6357294 0.5845892 0.53344886
  0.43116829 0.53344886 0.58458915 0.6868697 0.6357294 0.5845892 0.53344886
      [,50]     [,51]      [,52]      [,53]      [,54]      [,55]      [,56]
y 0.5334489 0.4823086 0.04273971 0.04273971 0.04273971 0.04273971 0.04273971
  0.5334489 0.4823086 0.43116829 0.43116829 0.48230858 0.58458915 0.63572944
  0.5334489 0.4823086 0.43116829 0.43116829 0.48230858 0.58458915 0.63572944
      [,57]     [,58]      [,59]   [,60]     [,61]      [,62]     [,63]
y 0.8402906 0.7891503 0.04273971 0.73801 0.6868697 0.04273971 0.6357294
  0.8402906 0.7891503 0.73801002 0.73801 0.6868697 0.63572944 0.6357294
  0.8402906 0.7891503 0.73801002 0.73801 0.6868697 0.63572944 0.6357294
       [,64]     [,65]     [,66]      [,67]     [,68]     [,69]    [,70]
y 0.04273971 0.5845892 0.5334489 0.04273971 0.4823086 0.4311683 0.380028
  0.58458915 0.5845892 0.5334489 0.48230858 0.4823086 0.4311683 0.380028
  0.58458915 0.5845892 0.5334489 0.48230858 0.4823086 0.4311683 0.380028
       [,71]     [,72]      [,73]     [,74]      [,75]      [,76]      [,77]
y 0.04273971 0.3288877 0.04273971 0.2777474 0.04273971 0.04273971 0.04273971
  0.32888771 0.3288877 0.27774742 0.2777474 0.22660713 0.22660713 0.38002800
  0.32888771 0.3288877 0.27774742 0.2777474 0.22660713 0.22660713 0.38002800
       [,78]      [,79]      [,80]      [,81]
y 0.04273971 0.04273971 0.04273971 0.04273971
  0.43116829 0.53344886 0.68686973 0.78915031
  0.43116829 0.53344886 0.68686973 0.78915031

$labs
 [1] "NO\n0.17\n100%" "NO\n0.04\n25%"  "NO\n0.21\n75%"  "NO\n0.07\n25%" 
 [5] "NO\n0.28\n49%"  "NO\n0.24\n44%"  "NO\n0.19\n34%"  "NO\n0.16\n23%" 
 [9] "NO\n0.11\n10%"  "NO\n0.20\n13%"  "NO\n0.18\n12%"  "YES\n0.70\n1%" 
[13] "NO\n0.26\n12%"  "NO\n0.05\n1%"   "NO\n0.28\n11%"  "NO\n0.27\n10%" 
[17] "NO\n0.26\n10%"  "YES\n0.75\n0%"  "YES\n0.80\n0%"  "NO\n0.43\n9%"  
[21] "NO\n0.23\n2%"   "NO\n0.48\n8%"   "NO\n0.41\n4%"   "NO\n0.00\n0%"  
[25] "NO\n0.44\n4%"   "NO\n0.41\n4%"   "NO\n0.38\n4%"   "NO\n0.00\n0%"  
[29] "NO\n0.41\n3%"   "NO\n0.36\n3%"   "NO\n0.11\n0%"   "NO\n0.41\n2%"  
[33] "NO\n0.24\n1%"   "YES\n0.52\n2%"  "NO\n0.17\n0%"   "YES\n0.61\n1%" 
[37] "NO\n0.50\n1%"   "NO\n0.43\n1%"   "NO\n0.25\n0%"   "YES\n0.67\n0%" 
[41] "YES\n0.75\n0%"  "YES\n1.00\n0%"  "YES\n0.67\n0%"  "YES\n0.80\n0%" 
[45] "YES\n1.00\n0%"  "YES\n0.57\n3%"  "YES\n0.51\n3%"  "NO\n0.46\n2%"  
[49] "NO\n0.00\n0%"   "YES\n0.53\n2%"  "NO\n0.40\n1%"   "NO\n0.18\n1%"  
[53] "YES\n0.67\n0%"  "YES\n0.75\n1%"  "YES\n0.70\n1%"  "YES\n0.77\n1%" 
[57] "YES\n0.58\n6%"  "YES\n0.55\n5%"  "NO\n0.20\n0%"   "YES\n0.57\n5%" 
[61] "NO\n0.49\n3%"   "NO\n0.00\n0%"   "YES\n0.53\n3%"  "NO\n0.25\n0%"  
[65] "YES\n0.57\n3%"  "YES\n0.53\n3%"  "NO\n0.20\n0%"   "YES\n0.57\n2%" 
[69] "YES\n0.53\n2%"  "NO\n0.41\n1%"   "NO\n0.00\n0%"   "NO\n0.50\n1%"  
[73] "NO\n0.20\n0%"   "YES\n0.62\n1%"  "NO\n0.33\n0%"   "YES\n0.86\n0%" 
[77] "YES\n0.69\n1%"  "YES\n1.00\n0%"  "YES\n1.00\n0%"  "YES\n0.73\n2%" 
[81] "YES\n1.00\n0%" 

$cex
[1] 0.15

$boxes
$boxes$x1
 [1] 0.1438391689 0.0004551891 0.2904937368 0.0250156650 0.5559718087
 [6] 0.2336972617 0.1094423007 0.0679964977 0.0495761408 0.0864168546
[11] 0.0741366166 0.0986970925 0.1508881036 0.1234193330 0.1785186390
[16] 0.1600982821 0.1478180442 0.1723785200 0.1969389958 0.3581139874
[21] 0.2216612364 0.4945667385 0.3553167555 0.2462217122 0.4644117988
[26] 0.4124366512 0.3330468319 0.2707821881 0.3953114757 0.3233569566
[31] 0.2953426639 0.3513712494 0.3199031397 0.3826775944 0.3444636156
[36] 0.4210533378 0.3997246862 0.3813043293 0.3690240914 0.3934228025
[41] 0.4179832784 0.4425437542 0.4671042300 0.4916647059 0.5162251817
[46] 0.6336549568 0.6037218769 0.5685779576 0.5409474223 0.5960467282
[51] 0.5777881360 0.5655078981 0.5899066092 0.6144670851 0.6390275609
[56] 0.6635880367 0.8782463557 0.7736184888 0.6883102773 0.8590884650
[61] 0.7600249479 0.7128707531 0.8070173781 0.7374312290 0.8767652919
[66] 0.8197773128 0.7619917048 0.8777246855 0.8462565758 0.8080425970
[71] 0.7865521806 0.8295330134 0.8111126565 0.8477916055 0.8356731323
[76] 0.8600718434 0.8846323193 0.9091927951 0.9337532710 0.9583137468
[81] 0.9828742226

$boxes$y1
 [1]  0.9555631094 -0.0007602899  0.9044228207 -0.0007602899  0.8532825319
 [6]  0.8021422432  0.7510019545  0.6998616658 -0.0007602899  0.6487213770
[11] -0.0007602899 -0.0007602899  0.6998616658 -0.0007602899  0.6487213770
[16]  0.5975810883 -0.0007602899 -0.0007602899 -0.0007602899  0.7510019545
[21] -0.0007602899  0.6998616658  0.6487213770 -0.0007602899  0.5975810883
[26]  0.5464407996  0.4953005108 -0.0007602899  0.4441602221  0.3930199334
[31] -0.0007602899  0.3418796446 -0.0007602899  0.2907393559 -0.0007602899
[36]  0.2395990672  0.1884587784  0.1373184897 -0.0007602899 -0.0007602899
[41] -0.0007602899 -0.0007602899 -0.0007602899 -0.0007602899 -0.0007602899
[46]  0.6487213770  0.5975810883  0.5464407996 -0.0007602899  0.4953005108
[51]  0.4441602221 -0.0007602899 -0.0007602899 -0.0007602899 -0.0007602899
[56] -0.0007602899  0.8021422432  0.7510019545 -0.0007602899  0.6998616658
[61]  0.6487213770 -0.0007602899  0.5975810883 -0.0007602899  0.5464407996
[66]  0.4953005108 -0.0007602899  0.4441602221  0.3930199334  0.3418796446
[71] -0.0007602899  0.2907393559 -0.0007602899  0.2395990672 -0.0007602899
[76] -0.0007602899 -0.0007602899 -0.0007602899 -0.0007602899 -0.0007602899
[81] -0.0007602899

$boxes$x2
 [1] 0.16378035 0.01712578 0.30716433 0.04168625 0.57264240 0.25036785
 [7] 0.12611289 0.08466709 0.06624673 0.10308744 0.09080720 0.11536768
[13] 0.16755869 0.13976639 0.19518923 0.17676887 0.16448863 0.18904911
[19] 0.21360958 0.37446105 0.23800830 0.51091380 0.37166381 0.26256877
[25] 0.48075886 0.42878371 0.34939389 0.28712925 0.41165853 0.33970402
[31] 0.31168972 0.36771831 0.33625020 0.39934818 0.36081067 0.43772393
[37] 0.41607175 0.39765139 0.38537115 0.41009339 0.43465387 0.45921434
[43] 0.48377482 0.50833529 0.53289577 0.65032555 0.62039247 0.58492502
[49] 0.55729448 0.61271732 0.59413519 0.58185496 0.60657720 0.63113767
[55] 0.65569815 0.68025862 0.89491694 0.79028908 0.70465734 0.87575905
[61] 0.77637201 0.72921781 0.82368797 0.75377829 0.89343588 0.83644790
[67] 0.77833876 0.89439527 0.86292716 0.82438966 0.80289924 0.84588007
[73] 0.82745972 0.86446219 0.85202019 0.87674243 0.90130291 0.92586338
[79] 0.95042386 0.97498434 0.99954481

$boxes$y2
 [1] 0.99906311 0.04273971 0.94792282 0.04273971 0.89678253 0.84564224
 [7] 0.79450195 0.74336167 0.04273971 0.69222138 0.04273971 0.04273971
[13] 0.74336167 0.04273971 0.69222138 0.64108109 0.04273971 0.04273971
[19] 0.04273971 0.79450195 0.04273971 0.74336167 0.69222138 0.04273971
[25] 0.64108109 0.58994080 0.53880051 0.04273971 0.48766022 0.43651993
[31] 0.04273971 0.38537964 0.04273971 0.33423936 0.04273971 0.28309907
[37] 0.23195878 0.18081849 0.04273971 0.04273971 0.04273971 0.04273971
[43] 0.04273971 0.04273971 0.04273971 0.69222138 0.64108109 0.58994080
[49] 0.04273971 0.53880051 0.48766022 0.04273971 0.04273971 0.04273971
[55] 0.04273971 0.04273971 0.84564224 0.79450195 0.04273971 0.74336167
[61] 0.69222138 0.04273971 0.64108109 0.04273971 0.58994080 0.53880051
[67] 0.04273971 0.48766022 0.43651993 0.38537964 0.04273971 0.33423936
[73] 0.04273971 0.28309907 0.04273971 0.04273971 0.04273971 0.04273971
[79] 0.04273971 0.04273971 0.04273971


$split.labs
[1] ""

$split.cex
 [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[39] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
[77] 1 1 1 1 1

$split.box
$split.box$x1
 [1] 0.13790682         NA 0.28632609         NA 0.54657181 0.22673256
 [7] 0.10241289 0.06268473         NA 0.07938744         NA         NA
[13] 0.14392340         NA 0.17320687 0.15141593         NA         NA
[19]         NA 0.34481399         NA 0.48543733 0.34038146         NA
[25] 0.45119415 0.40359253 0.31982918         NA 0.38983795 0.31623049
[31]         NA 0.33807125         NA 0.37564818         NA 0.41237098
[37] 0.38478939 0.37246021         NA         NA         NA         NA
[43]         NA         NA         NA 0.62662555 0.59675717 0.55973384
[49]         NA 0.58901732 0.57231461         NA         NA         NA
[55]         NA         NA 0.86347283 0.76048025         NA 0.84766788
[61] 0.75455142         NA 0.79835267         NA 0.86981823 0.81111261
[67]         NA 0.87241292 0.83148305 0.80091613         NA 0.82405948
[73]         NA 0.84076219         NA         NA         NA         NA
[79]         NA         NA         NA

$split.box$y1
 [1] 0.9338857        NA 0.8827454        NA 0.8316051 0.7804648 0.7293245
 [8] 0.6781842        NA 0.6270440        NA        NA 0.6781842        NA
[15] 0.6270440 0.5759037        NA        NA        NA 0.7293245        NA
[22] 0.6781842 0.6270440        NA 0.5759037 0.5247634 0.4736231        NA
[29] 0.4224828 0.3713425        NA 0.3202022        NA 0.2690619        NA
[36] 0.2179216 0.1667814 0.1156411        NA        NA        NA        NA
[43]        NA        NA        NA 0.6270440 0.5759037 0.5247634        NA
[50] 0.4736231 0.4224828        NA        NA        NA        NA        NA
[57] 0.7804648 0.7293245        NA 0.6781842 0.6270440        NA 0.5759037
[64]        NA 0.5247634 0.4736231        NA 0.4224828 0.3713425 0.3202022
[71]        NA 0.2690619        NA 0.2179216        NA        NA        NA
[78]        NA        NA        NA        NA

$split.box$x2
 [1] 0.16971270         NA 0.31133197         NA 0.58204240 0.25733256
 [7] 0.13314230 0.08997885         NA 0.11011685         NA         NA
[13] 0.17452340         NA 0.20050099 0.18545122         NA         NA
[19]         NA 0.38776105         NA 0.52004321 0.38659911         NA
[25] 0.49397650 0.43762783 0.36261154         NA 0.41713206 0.34683049
[31]         NA 0.38101831         NA 0.40637759         NA 0.44640628
[37] 0.43100704 0.40649551         NA         NA         NA         NA
[43]         NA         NA         NA 0.65735496 0.62735717 0.59376913
[49]         NA 0.61974673 0.59960872         NA         NA         NA
[55]         NA         NA 0.90969047 0.80342731         NA 0.88717964
[61] 0.78184554         NA 0.83235267         NA 0.90038294 0.84511261
[67]         NA 0.89970704 0.87770069 0.83151613         NA 0.85135360
[73]         NA 0.87149161         NA         NA         NA         NA
[79]         NA         NA         NA

$split.box$y2
 [1] 0.9512567        NA 0.9001164        NA 0.8489761 0.7978358 0.7466955
 [8] 0.6955552        NA 0.6444149        NA        NA 0.6955552        NA
[15] 0.6444149 0.5932746        NA        NA        NA 0.7466955        NA
[22] 0.6955552 0.6444149        NA 0.5932746 0.5421343 0.4909941        NA
[29] 0.4398538 0.3887135        NA 0.3375732        NA 0.2864329        NA
[36] 0.2352926 0.1841523 0.1330120        NA        NA        NA        NA
[43]        NA        NA        NA 0.6444149 0.5932746 0.5421343        NA
[50] 0.4909941 0.4398538        NA        NA        NA        NA        NA
[57] 0.7978358 0.7466955        NA 0.6955552 0.6444149        NA 0.5932746
[64]        NA 0.5421343 0.4909941        NA 0.4398538 0.3887135 0.3375732
[71]        NA 0.2864329        NA 0.2352926        NA        NA        NA
[78]        NA        NA        NA        NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{leaf\_results }\OtherTok{\textless{}{-}}\NormalTok{ leaf\_results}\SpecialCharTok{$}\NormalTok{leaf\_results}
\NormalTok{leaf\_results}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
     node ncompete nsurrogate  prob_yes n_obs
1       1        0          0 0.7321238  1874
2       1        0          0 0.6451441  1874
3       2        0          0 0.7798427  1399
4      48        0          0 0.7894737    19
5      98        0          0 0.6206897   145
6      99        0          0 0.1428571    14
7      25        0          0 0.3333333    12
8      26        0          0 0.7142857    14
9      27        0          0 0.2878788    66
10     56        0          0 0.6071429    56
11     57        0          0 0.0000000     8
12     29        0          0 0.3407407   135
13     15        0          0 0.0000000     6
14      2        0          0 0.9599156   474
15      6        0          0 0.9263158   475
16    112        0          0 0.8888889   189
17    226        0          0 0.8222222   225
18    227        0          0 0.3000000    10
19    114        0          0 0.9500000    20
20    460        0          0 0.7447917   192
21    461        0          0 0.2500000     4
22    231        0          0 0.2000000     5
23     58        0          0 0.7666667    30
24    236        0          0 1.0000000     5
25   1896        0          0 1.0000000     5
26   7588        0          0 0.8888889     9
27  15178        0          0 0.7647059    17
28  30358        0          0 0.8333333     6
29 242872        0          0 0.7500000     8
30 242873        0          0 0.3333333     6
31 121437        0          0 0.2500000     4
32  60719        0          0 0.0000000     5
33   3795        0          0 0.3333333     9
34    949        0          0 0.2000000     5
35    475        0          0 0.0000000     4
36    952        0          0 1.0000000     5
37   3812        0          0 0.8181818    11
38   3813        0          0 0.3333333     9
39   1907        0          0 0.2500000    12
40    477        0          0 0.3000000    10
41    239        0          0 0.2307692    13
42     60        0          0 0.8000000     5
43    244        0          0 1.0000000     4
44    490        0          0 0.7500000     8
45   1964        0          0 0.8000000     5
46  15720        0          0 1.0000000     4
47  31442        0          0 0.8000000     5
48  62886        0          0 0.6666667     6
49  62887        0          0 0.1428571     7
50   7861        0          0 0.3125000    16
51   3931        0          0 0.0000000     4
52    983        0          0 0.0000000     4
53    123        0          0 0.2727273    33
54     31        0          0 0.0000000     6
                                                                                                                                                                                                                                                      path
1                                                                                                                                                                                                                                                     root
2                                                                                                                                                                                                                                                     root
3                                                                                                                                                                                                                                            root -> ICU=1
4                                                                                                                                                                                   root -> ICU=0 -> WT< 110.3 -> WT>=99.06 -> AGE< 60.94 -> CREAT>=0.8672
5                                                                                                                                                                          root -> ICU=0 -> WT< 110.3 -> WT>=99.06 -> AGE< 60.94 -> CREAT< 0.8672 -> SEX=1
6                                                                                                                                                                          root -> ICU=0 -> WT< 110.3 -> WT>=99.06 -> AGE< 60.94 -> CREAT< 0.8672 -> SEX=0
7                                                                                                                                                                                                    root -> ICU=0 -> WT< 110.3 -> WT>=99.06 -> AGE>=60.94
8                                                                                                                                                                                                 root -> ICU=0 -> WT< 110.3 -> WT< 99.06 -> CREAT>=0.8146
9                                                                                                                                                                                                 root -> ICU=0 -> WT< 110.3 -> WT< 99.06 -> CREAT< 0.8146
10                                                                                                                                                                               root -> ICU=0 -> WT>=110.3 -> CREAT< 1.017 -> CREAT>=0.7228 -> AGE< 57.18
11                                                                                                                                                                               root -> ICU=0 -> WT>=110.3 -> CREAT< 1.017 -> CREAT>=0.7228 -> AGE>=57.18
12                                                                                                                                                                                             root -> ICU=0 -> WT>=110.3 -> CREAT< 1.017 -> CREAT< 0.7228
13                                                                                                                                                                                                              root -> ICU=0 -> WT>=110.3 -> CREAT>=1.017
14                                                                                                                                                                                                                                          root -> BURN=1
15                                                                                                                                                                                                                                 root -> BURN=0 -> ICU=0
16                                                                                                                                                                              root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT>=71.19 -> WT< 77.38
17                                                                                                                                                                 root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT>=71.19 -> WT>=77.38 -> WT>=77.67
18                                                                                                                                                                 root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT>=71.19 -> WT>=77.38 -> WT< 77.67
19                                                                                                                                                                             root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT< 71.19 -> AGE< 48.11
20                                                                                                                                                  root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT< 71.19 -> AGE>=48.11 -> WT< 70.97 -> AGE>=50.13
21                                                                                                                                                  root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT< 71.19 -> AGE>=48.11 -> WT< 70.97 -> AGE< 50.13
22                                                                                                                                                                root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE< 76.52 -> WT< 71.19 -> AGE>=48.11 -> WT>=70.97
23                                                                                                                                                                                        root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT>=1.577
24                                                                                                                                                       root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT>=0.9737
25                                                                                                       root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT< 0.4149
26                                                                            root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE< 80.18
27                                                           root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT>=0.8007
28                                              root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT< 0.8007 -> WT>=72.39
29 root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT< 0.8007 -> WT< 72.39 -> AGE>=83.96 -> CREAT>=0.5592 -> AGE>=88.03
30 root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT< 0.8007 -> WT< 72.39 -> AGE>=83.96 -> CREAT>=0.5592 -> AGE< 88.03
31               root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT< 0.8007 -> WT< 72.39 -> AGE>=83.96 -> CREAT< 0.5592
32                                root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT< 76.64 -> AGE>=80.18 -> CREAT< 0.8007 -> WT< 72.39 -> AGE< 83.96
33                                                                                          root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE>=77.75 -> CREAT>=0.4149 -> WT>=76.64
34                                                                                                                        root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT< 0.9304 -> AGE< 77.75
35                                                                                                                                      root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT< 1.011 -> CREAT< 0.9737 -> CREAT>=0.9304
36                                                                                                                               root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT>=65.15 -> AGE< 89.46 -> AGE>=87.03
37                                                                                                      root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT>=65.15 -> AGE< 89.46 -> AGE< 87.03 -> WT>=77.08 -> WT< 83.4
38                                                                                                      root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT>=65.15 -> AGE< 89.46 -> AGE< 87.03 -> WT>=77.08 -> WT>=83.4
39                                                                                                                  root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT>=65.15 -> AGE< 89.46 -> AGE< 87.03 -> WT< 77.08
40                                                                                                                                             root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT>=65.15 -> AGE>=89.46
41                                                                                                                                                           root -> BURN=0 -> ICU=1 -> OBESE=0 -> AGE>=76.52 -> CREAT< 1.577 -> CREAT>=1.011 -> WT< 65.15
42                                                                                                                                                                                     root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT>=1.934
43                                                                                                                                                        root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT< 80.79
44                                                                                                                                           root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT>=103.8
45                                                                                                                 root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT>=99.57
46                                                                     root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT< 98.61 -> CREAT>=0.9715 -> AGE< 65.87
47                                                        root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT< 98.61 -> CREAT>=0.9715 -> AGE>=65.87 -> WT< 85.18
48                                           root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT< 98.61 -> CREAT>=0.9715 -> AGE>=65.87 -> WT>=85.18 -> WT>=91.93
49                                           root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT< 98.61 -> CREAT>=0.9715 -> AGE>=65.87 -> WT>=85.18 -> WT< 91.93
50                                                                                   root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT< 98.61 -> CREAT< 0.9715
51                                                                                                    root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT< 100.7 -> WT< 99.57 -> WT>=98.61
52                                                                                                                              root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT< 1.302 -> WT>=80.79 -> WT< 103.8 -> WT>=100.7
53                                                                                                                                                                     root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT>=0.6667 -> CREAT< 1.934 -> CREAT>=1.302
54                                                                                                                                                                                                     root -> BURN=0 -> ICU=1 -> OBESE=1 -> CREAT< 0.6667
      MODEL WT_lower WT_upper CREAT_lower CREAT_upper AGE_lower AGE_upper OBESE
1   CARLIER       NA       NA          NA          NA        NA        NA  <NA>
2  FOURNIER       NA       NA          NA          NA        NA        NA  <NA>
3    MELLON       NA       NA          NA          NA        NA        NA  <NA>
4    MELLON    99.06   110.30      0.8672          NA        NA     60.94  <NA>
5    MELLON    99.06   110.30          NA      0.8672        NA     60.94  <NA>
6    MELLON    99.06   110.30          NA      0.8672        NA     60.94  <NA>
7    MELLON    99.06   110.30          NA          NA     60.94        NA  <NA>
8    MELLON       NA    99.06      0.8146          NA        NA        NA  <NA>
9    MELLON       NA    99.06          NA      0.8146        NA        NA  <NA>
10   MELLON   110.30       NA      0.7228      1.0170        NA     57.18  <NA>
11   MELLON   110.30       NA      0.7228      1.0170     57.18        NA  <NA>
12   MELLON   110.30       NA          NA      0.7228        NA        NA  <NA>
13   MELLON   110.30       NA      1.0170          NA        NA        NA  <NA>
14  RAMBAUD       NA       NA          NA          NA        NA        NA  <NA>
15  RAMBAUD       NA       NA          NA          NA        NA        NA  <NA>
16  RAMBAUD    71.19    77.38          NA          NA        NA     76.52     0
17  RAMBAUD    77.67       NA          NA          NA        NA     76.52     0
18  RAMBAUD    77.38    77.67          NA          NA        NA     76.52     0
19  RAMBAUD       NA    71.19          NA          NA        NA     48.11     0
20  RAMBAUD       NA    70.97          NA          NA     50.13     76.52     0
21  RAMBAUD       NA    70.97          NA          NA     48.11     50.13     0
22  RAMBAUD    70.97    71.19          NA          NA     48.11     76.52     0
23  RAMBAUD       NA       NA      1.5770          NA     76.52        NA     0
24  RAMBAUD       NA       NA      0.9737      1.0110     76.52        NA     0
25  RAMBAUD       NA       NA          NA      0.4149     77.75        NA     0
26  RAMBAUD       NA    76.64      0.4149      0.9304     77.75     80.18     0
27  RAMBAUD       NA    76.64      0.8007      0.9304     80.18        NA     0
28  RAMBAUD    72.39    76.64      0.4149      0.8007     80.18        NA     0
29  RAMBAUD       NA    72.39      0.5592      0.8007     88.03        NA     0
30  RAMBAUD       NA    72.39      0.5592      0.8007     83.96     88.03     0
31  RAMBAUD       NA    72.39      0.4149      0.5592     83.96        NA     0
32  RAMBAUD       NA    72.39      0.4149      0.8007     80.18     83.96     0
33  RAMBAUD    76.64       NA      0.4149      0.9304     77.75        NA     0
34  RAMBAUD       NA       NA          NA      0.9304     76.52     77.75     0
35  RAMBAUD       NA       NA      0.9304      0.9737     76.52        NA     0
36  RAMBAUD    65.15       NA      1.0110      1.5770     87.03     89.46     0
37  RAMBAUD    77.08    83.40      1.0110      1.5770     76.52     87.03     0
38  RAMBAUD    83.40       NA      1.0110      1.5770     76.52     87.03     0
39  RAMBAUD    65.15    77.08      1.0110      1.5770     76.52     87.03     0
40  RAMBAUD    65.15       NA      1.0110      1.5770     89.46        NA     0
41  RAMBAUD       NA    65.15      1.0110      1.5770     76.52        NA     0
42  RAMBAUD       NA       NA      1.9340          NA        NA        NA     1
43  RAMBAUD       NA    80.79      0.6667      1.3020        NA        NA     1
44  RAMBAUD   103.80       NA      0.6667      1.3020        NA        NA     1
45  RAMBAUD    99.57   100.70      0.6667      1.3020        NA        NA     1
46  RAMBAUD    80.79    98.61      0.9715      1.3020        NA     65.87     1
47  RAMBAUD    80.79    85.18      0.9715      1.3020     65.87        NA     1
48  RAMBAUD    91.93    98.61      0.9715      1.3020     65.87        NA     1
49  RAMBAUD    85.18    91.93      0.9715      1.3020     65.87        NA     1
50  RAMBAUD    80.79    98.61      0.6667      0.9715        NA        NA     1
51  RAMBAUD    98.61    99.57      0.6667      1.3020        NA        NA     1
52  RAMBAUD   100.70   103.80      0.6667      1.3020        NA        NA     1
53  RAMBAUD       NA       NA      1.3020      1.9340        NA        NA     1
54  RAMBAUD       NA       NA          NA      0.6667        NA        NA     1
    ICU BURN  SEX
1  <NA> <NA> <NA>
2  <NA> <NA> <NA>
3     1 <NA> <NA>
4     0 <NA> <NA>
5     0 <NA>    1
6     0 <NA>    0
7     0 <NA> <NA>
8     0 <NA> <NA>
9     0 <NA> <NA>
10    0 <NA> <NA>
11    0 <NA> <NA>
12    0 <NA> <NA>
13    0 <NA> <NA>
14 <NA>    1 <NA>
15    0    0 <NA>
16    1    0 <NA>
17    1    0 <NA>
18    1    0 <NA>
19    1    0 <NA>
20    1    0 <NA>
21    1    0 <NA>
22    1    0 <NA>
23    1    0 <NA>
24    1    0 <NA>
25    1    0 <NA>
26    1    0 <NA>
27    1    0 <NA>
28    1    0 <NA>
29    1    0 <NA>
30    1    0 <NA>
31    1    0 <NA>
32    1    0 <NA>
33    1    0 <NA>
34    1    0 <NA>
35    1    0 <NA>
36    1    0 <NA>
37    1    0 <NA>
38    1    0 <NA>
39    1    0 <NA>
40    1    0 <NA>
41    1    0 <NA>
42    1    0 <NA>
43    1    0 <NA>
44    1    0 <NA>
45    1    0 <NA>
46    1    0 <NA>
47    1    0 <NA>
48    1    0 <NA>
49    1    0 <NA>
50    1    0 <NA>
51    1    0 <NA>
52    1    0 <NA>
53    1    0 <NA>
54    1    0 <NA>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{classification\_tree\_model\_ensembling\_test}\NormalTok{(}
  \AttributeTok{test\_data =}\NormalTok{ AMOX\_CMIN\_TEST, }
  \AttributeTok{leaf\_results =}\NormalTok{ leaf\_results, }
  \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{), }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{) }

\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{test\_results}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{GOF\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-5.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{Boxplot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-6.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_BURN }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"BURN"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_ICU }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"ICU"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"OBESE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_CREAT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"CREAT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_WT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"WT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_AGE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"AGE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_SEX }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"SEX"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_BURN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-7.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_ICU}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-8.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-9.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_CREAT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-10.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_WT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-11.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_AGE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-12.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_SEX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-13.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extrapolate dose based on the ensembled concentrations and compare it to the true simulated dose.}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{WEIGHTED\_PREDICTION) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-14.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/CT-test-15.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/CT.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.841    0.393    86.4  19.5     61.1   17.2   319
2 Incorrect                   1.07     0.715    82.4  17.5     58.3   15.6   281
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep data for ensembling ensembling}
\NormalTok{test\_data\_CT }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{CT =}\NormalTok{ DOSE\_PRED) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"ID"}\NormalTok{,}\StringTok{"CT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Regression tree informed
ensembling}\label{regression-tree-informed-ensembling}

This method is similar to the previous one with the difference that not
prediction correctness is used as a target variable, but bias:

\[
\text{Bias} = \left( \frac{true - predicted}{true} \right)
\]

Therefore these are not classification, but regression trees.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_trees }\OtherTok{\textless{}{-}} \FunctionTok{regression\_tree\_model\_ensembling\_train}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN, }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{, }
   \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-1.pdf}}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-2.pdf}}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-3.pdf}}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(model\_trees)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$CARLIER
n= 1874 

node), split, n, deviance, yval
      * denotes terminal node

   1) root 1874 34865.86000  0.9989099  
     2) OBESE=0 1062   702.16520  0.1750154 *
     3) OBESE=1 812 32499.97000  2.0764670  
       6) BURN=0 582   591.41820  0.7676584 *
       7) BURN=1 230 28388.87000  5.3883200  
        14) WT< 98.42884 224 22732.95000  4.9932470  
          28) CREAT>=0.4791462 202  5922.02600  4.2771570  
            56) CREAT< 1.738617 182  3597.67300  3.7417010  
             112) CREAT< 0.5188551 16    25.19654  1.5456500 *
             113) CREAT>=0.5188551 166  3487.87700  3.9533680  
               226) AGE>=61.68318 54   376.12620  2.8118140  
                 452) CREAT< 1.233475 49   213.98140  2.3670290 *
                 453) CREAT>=1.233475 5    57.45141  7.1707020 *
               227) AGE< 61.68318 112  3007.45300  4.5037600  
                 454) AGE< 44.68716 67   965.76070  3.5710600 *
                 455) AGE>=44.68716 45  1896.62600  5.8924480  
                   910) WT< 79.66337 32   535.72200  4.2760200 *
                   911) WT>=79.66337 13  1071.48200  9.8713500  
                    1822) WT>=86.24705 7    59.86663  4.8578000 *
                    1823) WT< 86.24705 6   630.39080 15.7204900 *
            57) CREAT>=1.738617 20  1797.31600  9.1498120  
             114) AGE< 79.13163 16   516.52690  6.9307510  
               228) AGE>=38.95545 12   169.15830  5.3293710 *
               229) AGE< 38.95545 4   224.27650 11.7348900 *
             115) AGE>=79.13163 4   886.85060 18.0260500 *
          29) CREAT< 0.4791462 22 15756.27000 11.5682600  
            58) CREAT< 0.4552245 16   253.43930  3.5341160 *
            59) CREAT>=0.4552245 6 11716.05000 32.9926300 *
        15) WT>=98.42884 6  4315.69100 20.1377000 *

$FOURNIER
n= 1874 

node), split, n, deviance, yval
      * denotes terminal node

  1) root 1874 1758.548000  0.112802500  
    2) BURN=0 1400  485.610800  0.022405060  
      4) CREAT>=1.307654 194   21.648660 -0.354953700 *
      5) CREAT< 1.307654 1206  431.892700  0.083107870  
       10) WT>=62.0667 1152  406.116200  0.066439070  
         20) CREAT>=0.5001778 1047  321.491800  0.043753680  
           40) CREAT< 0.6478214 303   71.528260 -0.099460040 *
           41) CREAT>=0.6478214 744  241.218000  0.102078600  
             82) ICU=1 449   88.843970 -0.007858985 *
             83) ICU=0 295  138.687600  0.269407400  
              166) CREAT< 0.9037332 258   61.337180  0.172237800 *
              167) CREAT>=0.9037332 37   57.928110  0.946968500  
                334) WT>=99.10049 30   15.628690  0.678138500 *
                335) WT< 99.10049 7   30.839530  2.099097000 *
         21) CREAT< 0.5001778 105   78.712830  0.292644900 *
       11) WT< 62.0667 54   18.628030  0.438708900 *
    3) BURN=1 474 1227.707000  0.379799200  
      6) WT< 106.764 470 1108.282000  0.352087300  
       12) CREAT>=0.4780456 420  529.415200  0.273756200  
         24) CREAT< 2.618205 399  387.007600  0.237248600 *
         25) CREAT>=2.618205 21  131.771800  0.967401400  
           50) WT< 80.80351 17   56.166380  0.592592600  
            100) AGE< 79.13163 13    5.584233  0.071577370 *
            101) AGE>=79.13163 4   35.584160  2.285892000 *
           51) WT>=80.80351 4   63.067400  2.560339000 *
       13) CREAT< 0.4780456 50  554.642600  1.010068000  
         26) CREAT< 0.4558391 37   23.403110  0.325263800 *
         27) CREAT>=0.4558391 13  464.503300  2.959127000  
           54) AGE< 64.21698 9   60.903920  1.102549000  
            108) CREAT< 0.4746831 5    3.557012  0.025735370 *
            109) CREAT>=0.4746831 4   44.302230  2.448566000 *
           55) AGE>=64.21698 4  302.778000  7.136429000 *
      7) WT>=106.764 4   76.654380  3.635948000 *

$MELLON
n= 1874 

node), split, n, deviance, yval
      * denotes terminal node

  1) root 1874 1341.676000 -0.09842143  
    2) CREAT>=0.9666415 565   90.713960 -0.53310710  
      4) CREAT>=1.307654 281   17.977790 -0.71006640 *
      5) CREAT< 1.307654 284   55.230320 -0.35801710 *
    3) CREAT< 0.9666415 1309 1098.125000  0.08920073  
      6) CREAT>=0.4780456 1178  494.121100  0.00598905  
       12) AGE>=33.99646 1096  367.495400 -0.03554535  
         24) AGE>=58.4259 438   95.409610 -0.17454480 *
         25) AGE< 58.4259 658  257.990100  0.05698014  
           50) AGE< 58.24237 654  192.511400  0.04460311 *
           51) AGE>=58.24237 4   48.997970  2.08062400 *
       13) AGE< 33.99646 82   99.463990  0.56113180  
         26) CREAT>=0.7194811 38   11.039900  0.17262940 *
         27) CREAT< 0.7194811 44   77.735210  0.89665660 *
      7) CREAT< 0.4780456 131  522.499300  0.83747060  
       14) CREAT< 0.4772553 127  424.193000  0.75692190  
         28) WT< 64.37212 15    8.491578  0.02810875 *
         29) WT>=64.37212 112  406.666800  0.85453080  
           58) WT>=66.3071 104  335.532700  0.71313920  
            116) AGE>=68.463 36   27.453180  0.26242660 *
            117) AGE< 68.463 68  296.894700  0.95175170  
              234) AGE< 66.38402 64   99.053660  0.78142230 *
              235) AGE>=66.38402 4  166.275900  3.67702200 *
           59) WT< 66.3071 8   42.026430  2.69262100 *
       15) CREAT>=0.4772553 4   71.320660  3.39489400 *

$RAMBAUD
n= 1874 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 1874 801.68570000 -0.41704860  
   2) CREAT< 3.742774 1859 510.78710000 -0.44137250  
     4) AGE< 74.62672 1547 319.88970000 -0.49514220  
       8) BURN=1 397 125.82020000 -0.59983190  
        16) WT< 102.1165 383  99.38896000 -0.63054040 *
        17) WT>=102.1165 14  16.18940000  0.24026520 *
       9) BURN=0 1150 188.21630000 -0.45900150  
        18) WT>=62.36345 1120 174.42420000 -0.47330200 *
        19) WT< 62.36345 30   5.01204200  0.07488477 *
     5) AGE>=74.62672 312 164.24780000 -0.17476410  
      10) CREAT< 2.600505 303 126.68960000 -0.20724230  
        20) BURN=1 58  54.16797000 -0.62656580  
          40) AGE< 98.80252 50   5.66133100 -0.75765210 *
          41) AGE>=98.80252 8  42.27758000  0.19272360  
            82) AGE>=111.2772 4   0.06203214 -0.84675680 *
            83) AGE< 111.2772 4  33.57139000  1.23220400 *
        21) BURN=0 245  59.90908000 -0.10797380 *
      11) CREAT>=2.600505 9  26.47824000  0.91866590 *
   3) CREAT>=3.742774 15 153.48770000  2.59748300  
     6) WT< 79.28145 11  63.87212000  1.65300900 *
     7) WT>=79.28145 4  52.81923000  5.19478900 *
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{regression\_tree\_model\_ensembling\_test}\NormalTok{(}
  \AttributeTok{test\_data =}\NormalTok{ AMOX\_CMIN\_TEST, }
   \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{), }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{) }

\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{test\_results}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{GOF\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-5.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{Boxplot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-6.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_BURN }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"BURN"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_ICU }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"ICU"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"OBESE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_CREAT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"CREAT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_WT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"WT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_AGE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"AGE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_SEX }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"SEX"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_BURN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-7.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_ICU}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-8.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-9.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_CREAT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-10.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_WT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-11.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_AGE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-12.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_SEX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-13.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extrapolate dose based on the ensembled concentrations and compare it to the true simulated dose.}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{WEIGHTED\_PREDICTION) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-14.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/RT-test-15.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/RT.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.825    0.371    86.5  19.0     60.9   16.6   344
2 Incorrect                   1.12     0.742    81.8  17.9     58.3   16.3   256
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep data for ensembling ensembling}
\NormalTok{test\_data\_RT }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{RT =}\NormalTok{ DOSE\_PRED) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"ID"}\NormalTok{,}\StringTok{"RT"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Weighed model ensembling}\label{weighed-model-ensembling}

This method is used to attribute weights to models based on their
performance in different subgroups and on the overall performance of
models in different subgroups.

The method is based on Agema et al. (2024).

\subsection{Model influence}\label{model-influence}

To calculate model influence, first, differences are calculated between
\(Cmin_{\text{pred}}\) and \(Cmin_{\text{ind}}\) for a particular set of
covariates. Then we use this difference to calculate pooled MPE and RMSE
values for each model. MPE and RMSE will be used to calculate scores as
discussed in a later section.

\pandocbounded{\includegraphics[keepaspectratio]{images/clipboard-1093848730.png}}

\subsection{Subgroup influence}\label{subgroup-influence}

The data is divided into subgroups. For categorical covariates (ICU,
BURN, OBESE, SEX), a subgroup is a category, thus we have
two-two-two-two subgroups for ICU, BURN, SEX and OBESE. Continuous
covariates (WT, CREAT, AGE) are divided into four quantiles, and each
quantile will represent a subgroup.\\
First, ratios are calculated between\(Cmin_{\text{pred}}\) and the
\(Cmin_{\text{ind}}\) for a particular set of covariates. For each
sugbroup we will calculate the proportion of ratios \textbf{outside} the
bioequivalence range of {[}0.80-1.25{]}. This proportion will represent
subgroup influence. The logic behind giving more influence to subgroups
with more ratios outside the bioequivalence range is that sugbroup
having overall good predictions (many ratios inside the bioequivalence
range), means that we can use any of the models for that subgroup, thus
its influence will be lower in attributing model weights. A model having
a good performance in a sugbroup with bad predictions (many ratios
outside the bioequivalence range) will be preferred to a model having
good performance in a subgroup having overall good predictions.

\pandocbounded{\includegraphics[keepaspectratio]{images/clipboard-2578669345.png}}

\subsection{Score calculation}\label{score-calculation}

Scores are calculated with a negative exponential function: \[
\text{Score}_{\text{MPE}} = e^{\text{penalty} \cdot |\text{MPE}|}
\] \[
\text{Score}_{\text{RMSE}} = e^{\text{penalty} \cdot |\text{RMSE}|}
\]Model score is the product of RMSE and MPE scores. \[
\text{Score}_{\text{Carlier}} = \text{Score}_{\text{RMSE}} \cdot \text{Score}_{\text{MPE}}
\] Model score is normalized by the sum of scores. \[
\text{Influence}_{\text{Carlier}} = \frac{\text{Score}_{\text{Carlier}}}{\sum \text{Score}}
\] For this negative exponential calculation, the two penalties have to
be defined

\textbf{Table 1.} Tuning of penalty terms for dose prediction on
\textbf{simulated data}

\begin{longtable}[]{@{}ccc@{}}
\toprule\noalign{}
\textbf{Penalty RMSE} & \textbf{Penalty MPE} & \textbf{Correct
predictions (\%)} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
-4 & -20 & 37.7 \\
-25 & -5 & 46.0 \\
-25 & -3 & 45.5 \\
-25 & -1 & 45.7 \\
-4 & -2 & 45.0 \\
\textbf{-8} & \textbf{-1} & \textbf{46.2} \\
-2 & -4 & 41.5 \\
-2 & -6 & 39.8 \\
-2 & -8 & 39.3 \\
-1 & -8 & 38.5 \\
\end{longtable}

The combination of -8 for RMSE and -1 for MPE gives the highest
proportion of correct dose predictions on simulated data.

\pandocbounded{\includegraphics[keepaspectratio]{images/clipboard-106276185.png}}

To test the algorithm we check to which 8 subgroups (ICU, BURN, WT,
CREAT, OBESE, SEX, AGE) a subject belongs, and we add the obtain the
corresponding model and influence scores from the all\_scores table. We
normalize the four subgroup influences by their sum (so they add up to 1
for that subject). Then, for each subgroup we multiply the model
influences with the normalized subgroup influence. As a product of this
multiplication we have a model weights for each of the 4 models for each
of the four subgroups. For each model, we add the four weights (for
example Carlier weight for ICU = 0, Carlier weight for BURN = 1 etc). As
a final step, we normalize the weights of the models by their sum so
they add up to 1 for each subject. Then, we ensemble the separate Cmax
predictions of the four models based on their weight. The administered
dose is extrapolated by dividing the weighted concentration prediction
by the target concentration (= 60 mg/L).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{training\_results }\OtherTok{\textless{}{-}} \FunctionTok{weighed\_model\_ensembling\_train}\NormalTok{(}
  \AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN, }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{, }
  \AttributeTok{pen\_RMSE =} \SpecialCharTok{{-}}\DecValTok{8}\NormalTok{, }
  \AttributeTok{pen\_MPE =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }
   \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{))}

\NormalTok{all\_scores }\OtherTok{\textless{}{-}}\NormalTok{ training\_results}\SpecialCharTok{$}\NormalTok{all\_scores}
\FunctionTok{print}\NormalTok{(all\_scores)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 80 x 10
   COVARIATE QUANTILE SUBGROUP_INFLUENCE MODEL   MPE  RMSE MODEL_INFLUENCE LABEL
   <chr>     <chr>                 <dbl> <chr> <dbl> <dbl>           <dbl> <chr>
 1 AGE       18.5-49~              0.762 CARL~ 1.51  1.55      0.000000894 AGE_7
 2 AGE       18.5-49~              0.762 FOUR~ 0.534 0.591     0.00520     AGE_7
 3 AGE       18.5-49~              0.762 MELL~ 0.555 0.745     0.00148     AGE_7
 4 AGE       18.5-49~              0.762 RAMB~ 0.667 0.921     0.000324    AGE_7
 5 AGE       49.4-57~              0.692 CARL~ 1.09  1.30      0.0000105   AGE_9
 6 AGE       49.4-57~              0.692 FOUR~ 0.423 0.554     0.00777     AGE_9
 7 AGE       49.4-57~              0.692 MELL~ 0.410 0.675     0.00301     AGE_9
 8 AGE       49.4-57~              0.692 RAMB~ 0.566 0.782     0.00109     AGE_9
 9 AGE       57.4-69~              0.728 CARL~ 1.27  1.03      0.0000709   AGE_~
10 AGE       57.4-69~              0.728 FOUR~ 0.474 0.612     0.00465     AGE_~
# i 70 more rows
# i 2 more variables: lower <dbl>, upper <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{training\_results}\SpecialCharTok{$}\NormalTok{MPE\_plot }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{training\_results}\SpecialCharTok{$}\NormalTok{RMSE\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{training\_results}\SpecialCharTok{$}\NormalTok{SUBGROUP\_INFLUENCE\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{weighed\_model\_ensembling\_test}\NormalTok{(}
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{, }
  \AttributeTok{test\_data =}\NormalTok{ AMOX\_CMIN\_TEST, }
  \AttributeTok{all\_scores =}\NormalTok{ all\_scores, }
   \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{))}

\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{test\_results}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{GOF\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{Boxplot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-5.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_BURN }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"BURN"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_ICU }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"ICU"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"OBESE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_CREAT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"CREAT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_WT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"WT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_AGE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"AGE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_SEX }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"SEX"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_BURN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-6.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_ICU}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-7.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-8.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_CREAT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-9.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_WT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-10.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_AGE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-11.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_SEX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-12.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}}\NormalTok{ weight\_OBESE }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"WME weight attribution, stratified by OBESE"}\NormalTok{)}
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/WME\_OBESE.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ weight\_OBESE,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\CommentTok{\# Extrapolate dose based on the ensembled concentrations and compare it to the true simulated dose.}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{WEIGHTED\_PREDICTION) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-13.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/WME-14.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/WME.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.812    0.359    86.1  19.1     60.9   17.3   314
2 Incorrect                   1.10     0.719    82.8  18.0     58.6   15.5   286
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep data for ensembling ensembling}
\NormalTok{test\_data\_WME }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{WME =}\NormalTok{ DOSE\_PRED) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"ID"}\NormalTok{,}\StringTok{"WME"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Factor Analysis of Mixed Data
(FAMD)}\label{factor-analysis-of-mixed-data-famd}

In FAMD, Principal Component Analyisis (PCA) is applied to continuous
covariates and multiple correspondence analysis (MCA) to categorical
covariates. FAMD is an unsupervised machine learning method which is
based on dimensionality reduction. Principal components are uncorrelated
linear combinations of initial variables. They are directions in the
variable space, perpendicular to each other that explain a maximum
variance of the data. The first principal component explains most of the
variance, as it has most of the dispersion of the data points along it,
then the subsequent ones explain less and less and if a certain
percentage (in this case, 90 \%) of the data variance is explained, no
more principal components are added. This process simplifies the dataset
while retaining most of the relevant information.

Nearest neighbors is a classification technique that relies on the
proximity of a data point to different classes in a variable space. To
measure proximity, we can use euclidean distance, which is the length of
a straight line connecting to points, or the Mahalanobis distance which
accounts for variance and correlation between the variables as well.
Mahalanobis distances are calculated between the centroids (geometric
means) of model cohorts and a new subject. Model weights were calculated
by taking the normalized reciprocal of these distances.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result }\OtherTok{\textless{}{-}}\NormalTok{ stpbrioche}\SpecialCharTok{::}\FunctionTok{famd}\NormalTok{(}
  \AttributeTok{train =}\NormalTok{ AMOX\_CMIN\_TRAIN, }
  \AttributeTok{test =}\NormalTok{ AMOX\_CMIN\_TEST, }
   \AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
  \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{), }
  \AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{)}

\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ result}\SpecialCharTok{$}\NormalTok{test\_results}
\NormalTok{result}\SpecialCharTok{$}\NormalTok{GOF\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{contrib\_dim1 }\OtherTok{\textless{}{-}}\NormalTok{ result}\SpecialCharTok{$}\NormalTok{contrib\_dim1}
\NormalTok{contrib\_dim1 }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/FAMD1.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ contrib\_dim1,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}
\NormalTok{contrib\_dim2 }\OtherTok{\textless{}{-}}\NormalTok{ result}\SpecialCharTok{$}\NormalTok{contrib\_dim2}
\NormalTok{contrib\_dim2 }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/FAMD2.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ contrib\_dim2,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}
\NormalTok{contrib\_quant\_var }\OtherTok{\textless{}{-}}\NormalTok{ result}\SpecialCharTok{$}\NormalTok{contrib\_quant\_var}
\NormalTok{contrib\_quant\_var}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-4.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/FAMD3.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ contrib\_quant\_var,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\NormalTok{weight\_BURN }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"BURN"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_ICU }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"ICU"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"OBESE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_CREAT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"CREAT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_WT }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"WT"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_AGE }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"AGE"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{weight\_SEX }\OtherTok{\textless{}{-}} \FunctionTok{generate\_weight\_plot}\NormalTok{(test\_data, }\StringTok{"SEX"}\NormalTok{, }\AttributeTok{is\_categorical =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{weight\_BURN}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-5.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_ICU}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-6.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-7.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_CREAT}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-8.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_AGE}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-9.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_SEX}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-10.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weight\_OBESE }\OtherTok{\textless{}{-}}\NormalTok{ weight\_OBESE }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"FAMD weight attribution, stratified by OBESE"}\NormalTok{)}
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/FAMD\_OBESE.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ weight\_OBESE,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\CommentTok{\# Extrapolate dose based on the ensembled concentrations and compare it to the true simulated dose.}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60}\SpecialCharTok{/}\NormalTok{WEIGHTED\_PREDICTION) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM) }\CommentTok{\# Administered dose extrapolation to reach 60 mg/L}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-11.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/FAMD-12.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/FAMD.RData"}\NormalTok{)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.856    0.407    87.0  19.2     59.9   17.0   329
2 Incorrect                   1.06     0.718    81.5  17.5     59.6   15.9   271
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep data for ensembling ensembling}
\NormalTok{test\_data\_FAMD }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{FAMD =}\NormalTok{ DOSE\_PRED) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{"ID"}\NormalTok{,}\StringTok{"FAMD"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Ensembling ensembling}\label{ensembling-ensembling}

Ensembling for machine learning and PopPK ensembling. A dose prediction
to reach 60 mg/L is made for each subject and the method with the dose
prediction closest to the true dose is selected. A decision tree is
trained to predict the most suited dose for each subject.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# For ML, take only one line per patient (the true concentration)}
\NormalTok{train }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TRAIN }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{II =}\NormalTok{ FREQ)}

\NormalTok{test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{II =}\NormalTok{ FREQ)}

\NormalTok{test\_data\_ML }\OtherTok{\textless{}{-}} \FunctionTok{machine\_learning}\NormalTok{(}\AttributeTok{train =}\NormalTok{ train, }\AttributeTok{test =}\NormalTok{ test,  }\AttributeTok{continuous\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{), }
                                 \AttributeTok{categorical\_cov =} \FunctionTok{c}\NormalTok{(}\StringTok{"OBESE"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{), }\AttributeTok{target\_variable =} \StringTok{"CMIN"}\NormalTok{, }\AttributeTok{target\_concentration =} \DecValTok{60}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1991}\NormalTok{)}

\CommentTok{\# Put together the predictions of the 8 methods}
\NormalTok{datasets }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(test\_data\_ML, test\_data\_WME, test\_data\_FAMD, test\_data\_CT, test\_data\_RT)}
\CommentTok{\# Merge the datasets}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{reduce}\NormalTok{(datasets, full\_join, }\AttributeTok{by =} \StringTok{"ID"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{arrange}\NormalTok{(ID)}

\CommentTok{\# Divide the data to training and test data (50{-}50)}
\NormalTok{idx }\OtherTok{\textless{}{-}} \FunctionTok{seq\_len}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data)) }\SpecialCharTok{\%\%} \DecValTok{2} \SpecialCharTok{==} \DecValTok{1}

\NormalTok{train  }\OtherTok{\textless{}{-}}\NormalTok{ data[idx, ]}
\NormalTok{test}\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{!}\NormalTok{idx, ]}

\CommentTok{\# Add the name of the best method (whose dose prediction is the closest to the target dose) in a new column called Method}
\NormalTok{methods }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"RF"}\NormalTok{, }\StringTok{"XGB"}\NormalTok{, }\StringTok{"KNN"}\NormalTok{, }\StringTok{"SVM"}\NormalTok{, }\StringTok{"WME"}\NormalTok{, }\StringTok{"CT"}\NormalTok{, }\StringTok{"RT"}\NormalTok{, }\StringTok{"FAMD"}\NormalTok{)}

\NormalTok{train }\OtherTok{\textless{}{-}}\NormalTok{ train }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rowwise}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{Method =}\NormalTok{ methods[}\FunctionTok{which.min}\NormalTok{(}\FunctionTok{abs}\NormalTok{(}\FunctionTok{c\_across}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(methods)) }\SpecialCharTok{{-}}\NormalTok{ DOSE\_TARGET))]}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\CommentTok{\# Range for complexity parameter to test (based on cross{-}validation)}
\NormalTok{cp\_values }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.015}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.001}\NormalTok{) }

\CommentTok{\# Convert categorical variables to factors}
\NormalTok{train}\SpecialCharTok{$}\NormalTok{Method }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(train}\SpecialCharTok{$}\NormalTok{Method)}
\NormalTok{train}\SpecialCharTok{$}\NormalTok{ICU }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(train}\SpecialCharTok{$}\NormalTok{ICU)}
\NormalTok{train}\SpecialCharTok{$}\NormalTok{BURN }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(train}\SpecialCharTok{$}\NormalTok{BURN)}
\NormalTok{train}\SpecialCharTok{$}\NormalTok{OBESE }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(train}\SpecialCharTok{$}\NormalTok{OBESE)}
\NormalTok{train}\SpecialCharTok{$}\NormalTok{SEX }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(train}\SpecialCharTok{$}\NormalTok{SEX)}

\CommentTok{\# Perform cross{-}validation for each complexity value}
\NormalTok{cv\_results }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(cp\_values, }\ControlFlowTok{function}\NormalTok{(cp) \{}
\NormalTok{  ensfit }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(}
\NormalTok{    Method }\SpecialCharTok{\textasciitilde{}}\NormalTok{ WT }\SpecialCharTok{+}\NormalTok{ CREAT }\SpecialCharTok{+}\NormalTok{ ICU }\SpecialCharTok{+}\NormalTok{ BURN }\SpecialCharTok{+}\NormalTok{ OBESE }\SpecialCharTok{+}\NormalTok{ AGE }\SpecialCharTok{+}\NormalTok{ SEX,}
    \AttributeTok{data =}\NormalTok{ train,}
    \AttributeTok{method =} \StringTok{\textquotesingle{}class\textquotesingle{}}\NormalTok{,}
    \AttributeTok{parms =} \FunctionTok{list}\NormalTok{(}\AttributeTok{split =} \StringTok{"information"}\NormalTok{),}
    \AttributeTok{control =} \FunctionTok{rpart.control}\NormalTok{(}
      \AttributeTok{cp =}\NormalTok{ cp, }\CommentTok{\# Complexity parameter}
      \AttributeTok{xval =} \DecValTok{5}\NormalTok{, }\CommentTok{\# Cross{-}validation}
      \AttributeTok{minsplit =} \DecValTok{4}\NormalTok{, }\CommentTok{\# Minimum number of samples to split}
      \AttributeTok{minbucket =} \DecValTok{4} \CommentTok{\# Minimum number of samples in a leaf}
\NormalTok{    )}
\NormalTok{  )}
  \FunctionTok{min}\NormalTok{(ensfit}\SpecialCharTok{$}\NormalTok{cptable[, }\StringTok{"xerror"}\NormalTok{]) }\CommentTok{\# Extract the minimum cross{-}validation error}
\NormalTok{\})}

\CommentTok{\# Find the best cp value}
\NormalTok{best\_cp }\OtherTok{\textless{}{-}}\NormalTok{ cp\_values[}\FunctionTok{which.min}\NormalTok{(cv\_results)]}

\CommentTok{\# Fit the final decision tree with the best cp value}
\NormalTok{ensfit }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(}
\NormalTok{  Method }\SpecialCharTok{\textasciitilde{}}\NormalTok{ WT }\SpecialCharTok{+}\NormalTok{ CREAT }\SpecialCharTok{+}\NormalTok{ ICU }\SpecialCharTok{+}\NormalTok{ BURN }\SpecialCharTok{+}\NormalTok{ OBESE }\SpecialCharTok{+}\NormalTok{ AGE }\SpecialCharTok{+}\NormalTok{ SEX,}
  \AttributeTok{data =}\NormalTok{ train,}
  \AttributeTok{method =} \StringTok{\textquotesingle{}class\textquotesingle{}}\NormalTok{,}
  \AttributeTok{parms =} \FunctionTok{list}\NormalTok{(}\AttributeTok{split =} \StringTok{"information"}\NormalTok{),}
  \AttributeTok{control =} \FunctionTok{rpart.control}\NormalTok{(}
    \AttributeTok{cp =}\NormalTok{ best\_cp,}
    \AttributeTok{xval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{minsplit =} \DecValTok{4}\NormalTok{,}
    \AttributeTok{minbucket =} \DecValTok{4}
\NormalTok{  )}
\NormalTok{)}

\CommentTok{\# Plot the tree}
\FunctionTok{rpart.plot}\NormalTok{(ensfit, }\AttributeTok{type =} \DecValTok{3}\NormalTok{, }\AttributeTok{extra =} \DecValTok{0}\NormalTok{, }\AttributeTok{cex.main =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{box.palette =} \StringTok{"Blues"}\NormalTok{, }\AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Ensembling ensembling"}\NormalTok{, }\StringTok{"(cp ="}\NormalTok{, best\_cp, }\StringTok{")"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/ens-ens-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{jpeg}\NormalTok{(}\StringTok{"Figures/ensembling\_ensembling\_plot.jpg"}\NormalTok{, }\AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{units =} \StringTok{"in"}\NormalTok{, }\AttributeTok{res =} \DecValTok{300}\NormalTok{)}
\FunctionTok{rpart.plot}\NormalTok{(ensfit, }\AttributeTok{type =} \DecValTok{3}\NormalTok{, }\AttributeTok{extra =} \DecValTok{0}\NormalTok{, }\AttributeTok{cex =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{cex.main =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{box.palette =} \StringTok{"Blues"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Ensembling ensembling"}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
pdf 
  2 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get for which patient which method is the best}
\NormalTok{leaves }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(ensfit}\SpecialCharTok{$}\NormalTok{frame)[ensfit}\SpecialCharTok{$}\NormalTok{frame}\SpecialCharTok{$}\NormalTok{var }\SpecialCharTok{==} \StringTok{"\textless{}leaf\textgreater{}"}\NormalTok{]}
\NormalTok{paths }\OtherTok{\textless{}{-}} \FunctionTok{path.rpart}\NormalTok{(ensfit, leaves, }\AttributeTok{print.it =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{leaf\_classes }\OtherTok{\textless{}{-}}\NormalTok{ ensfit}\SpecialCharTok{$}\NormalTok{frame}\SpecialCharTok{$}\NormalTok{yval[}\FunctionTok{which}\NormalTok{(ensfit}\SpecialCharTok{$}\NormalTok{frame}\SpecialCharTok{$}\NormalTok{var }\SpecialCharTok{==} \StringTok{"\textless{}leaf\textgreater{}"}\NormalTok{)]}
\NormalTok{leaf\_labels }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{attr}\NormalTok{(ensfit, }\StringTok{"ylevels"}\NormalTok{)[leaf\_classes])}
\NormalTok{leaf\_summary }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Method =}\NormalTok{ leaf\_labels,}
  \AttributeTok{Path =} \FunctionTok{sapply}\NormalTok{(paths, }\ControlFlowTok{function}\NormalTok{(path) }\FunctionTok{paste}\NormalTok{(path, }\AttributeTok{collapse =} \StringTok{" \& "}\NormalTok{))}
\NormalTok{)}

\FunctionTok{print}\NormalTok{(leaf\_summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    Method
2      KNN
24    FAMD
100     CT
101    SVM
102    KNN
103    SVM
26      RT
54    FAMD
55      RT
7      SVM
                                                                                Path
2                                                                root & CREAT>=2.313
24                           root & CREAT< 2.313 & WT< 104.9 & CREAT>=0.6538 & SEX=1
100    root & CREAT< 2.313 & WT< 104.9 & CREAT>=0.6538 & SEX=0 & OBESE=1 & WT< 87.52
101    root & CREAT< 2.313 & WT< 104.9 & CREAT>=0.6538 & SEX=0 & OBESE=1 & WT>=87.52
102 root & CREAT< 2.313 & WT< 104.9 & CREAT>=0.6538 & SEX=0 & OBESE=0 & CREAT>=1.041
103 root & CREAT< 2.313 & WT< 104.9 & CREAT>=0.6538 & SEX=0 & OBESE=0 & CREAT< 1.041
26                   root & CREAT< 2.313 & WT< 104.9 & CREAT< 0.6538 & CREAT>=0.6076
54       root & CREAT< 2.313 & WT< 104.9 & CREAT< 0.6538 & CREAT< 0.6076 & AGE< 68.5
55       root & CREAT< 2.313 & WT< 104.9 & CREAT< 0.6538 & CREAT< 0.6076 & AGE>=68.5
7                                                    root & CREAT< 2.313 & WT>=104.9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make predictions for the test data}
\NormalTok{test\_data}\SpecialCharTok{$}\NormalTok{ICU }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(test\_data}\SpecialCharTok{$}\NormalTok{ICU)}
\NormalTok{test\_data}\SpecialCharTok{$}\NormalTok{BURN }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(test\_data}\SpecialCharTok{$}\NormalTok{BURN)}
\NormalTok{test\_data}\SpecialCharTok{$}\NormalTok{OBESE }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(test\_data}\SpecialCharTok{$}\NormalTok{OBESE)}
\NormalTok{test\_data}\SpecialCharTok{$}\NormalTok{SEX }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(test\_data}\SpecialCharTok{$}\NormalTok{SEX)}

\NormalTok{test\_data}\SpecialCharTok{$}\NormalTok{Method }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(ensfit, }\AttributeTok{newdata =}\NormalTok{ test\_data, }\AttributeTok{type =} \StringTok{"class"}\NormalTok{)}

\CommentTok{\# Add the dose prediction of the best predicted method}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ test\_data }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rowwise}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =} \FunctionTok{cur\_data}\NormalTok{()[[Method]]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{DOSE\_PRED =}\NormalTok{ (}\DecValTok{60} \SpecialCharTok{/}\NormalTok{ WEIGHTED\_PREDICTION)}\SpecialCharTok{*}\NormalTok{DOSE\_ADM)}

\NormalTok{results }\OtherTok{\textless{}{-}} \FunctionTok{explore\_predictions}\NormalTok{(test\_data)}
\NormalTok{results}\SpecialCharTok{$}\NormalTok{target\_attainment }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/ens-ens-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{crcl\_plot }\OtherTok{\textless{}{-}}\NormalTok{ results}\SpecialCharTok{$}\NormalTok{crcl\_plot}
\NormalTok{crcl\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Precision_dosing_methods_files/figure-pdf/ens-ens-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{results}\SpecialCharTok{$}\NormalTok{summary\_stats }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 9
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT mean_AGE sd_AGE Count
  <chr>                       <dbl>    <dbl>   <dbl> <dbl>    <dbl>  <dbl> <int>
1 Correct                     0.856    0.407    87.0  19.2     59.9   17.0   329
2 Incorrect                   1.06     0.718    81.5  17.5     59.6   15.9   271
# i 1 more variable: Proportion <dbl>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(crcl\_plot, }\AttributeTok{file =} \StringTok{"Figures/Ens.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bookmarksetup{startatroot}

\chapter{Machine learning dose
prediction}\label{machine-learning-dose-prediction}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidymodels)}
\FunctionTok{library}\NormalTok{(vip) }\CommentTok{\# for variable importance}
\FunctionTok{library}\NormalTok{(shapviz) }\CommentTok{\# for SHAP values}
\FunctionTok{library}\NormalTok{(doParallel) }\CommentTok{\# for parallel processing}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ranger) }\CommentTok{\# for random forest}
\FunctionTok{library}\NormalTok{(kknn) }\CommentTok{\# for KNN}
\FunctionTok{library}\NormalTok{(here)}
\FunctionTok{library}\NormalTok{(probably) }\CommentTok{\# for GOF plot}
\FunctionTok{library}\NormalTok{(brulee) }\CommentTok{\# for ML ensembling}
\FunctionTok{library}\NormalTok{(stacks) }\CommentTok{\# for ML ensembling}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(rpart) }\CommentTok{\# for decision trees}
\FunctionTok{library}\NormalTok{(rpart.plot) }\CommentTok{\# for decision trees}
\FunctionTok{library}\NormalTok{(purrr)}
\FunctionTok{library}\NormalTok{(stringr) }\CommentTok{\# for decision tree path strings}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(mrgsolve)}
\FunctionTok{library}\NormalTok{(kernlab)}
\FunctionTok{library}\NormalTok{(e1071)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Import or generate training and test data}
\NormalTok{here}\SpecialCharTok{::}\FunctionTok{i\_am}\NormalTok{(}\StringTok{"Amoxicillin/a\_priori/For\_publication/Machine\_Learning.qmd"}\NormalTok{)}

\NormalTok{AMOX\_CMIN\_TRAIN }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"Amoxicillin/a\_priori/For\_publication/AMOX\_CMIN\_TRAIN.csv"}\NormalTok{), }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}

\NormalTok{AMOX\_CMIN\_TEST }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"Amoxicillin/a\_priori/For\_publication/AMOX\_CMIN\_TEST.csv"}\NormalTok{), }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}

\CommentTok{\# Select only observed data}
\NormalTok{ AMOX\_CMIN\_TRAIN }\OtherTok{\textless{}{-}}\NormalTok{  AMOX\_CMIN\_TRAIN }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
   \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{INF =} \DecValTok{24}\SpecialCharTok{/}\NormalTok{FREQ,}
    \AttributeTok{DOSE\_ADM =}\NormalTok{ DOSE\_ADM }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{24} \SpecialCharTok{/}\NormalTok{ FREQ),}
    \AttributeTok{DOSE\_TARGET =}\NormalTok{ (}\DecValTok{60} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM,}
    \AttributeTok{DOSE\_inf =}\NormalTok{ (}\DecValTok{40} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM,}
    \AttributeTok{DOSE\_sup =}\NormalTok{ (}\DecValTok{80} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM}
\NormalTok{  )}

\NormalTok{AMOX\_CMIN\_TEST }\OtherTok{\textless{}{-}}\NormalTok{  AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(REFERENCE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{INF =} \DecValTok{24}\SpecialCharTok{/}\NormalTok{FREQ,}
    \AttributeTok{DOSE\_ADM =}\NormalTok{ DOSE\_ADM }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{24} \SpecialCharTok{/}\NormalTok{ FREQ),}
    \AttributeTok{DOSE\_TARGET =}\NormalTok{ (}\DecValTok{60} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM,}
    \AttributeTok{DOSE\_inf =}\NormalTok{ (}\DecValTok{40} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM,}
    \AttributeTok{DOSE\_sup =}\NormalTok{ (}\DecValTok{80} \SpecialCharTok{/}\NormalTok{ CMIN\_IND) }\SpecialCharTok{*}\NormalTok{ DOSE\_ADM}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

For ML, instead of an iterative dose search, the ML algorithms are
trained on covariates to predict the daily dose which allows to reach a
concentration of 60 mg/L. The target dose is obtained by linear
extrapolation to attain 60 mg/L. For intermittent infusion, the daily
dose is fractioned by the number of administratins. The predictors are
the covariates (WT, CREAT, BURN, OBESE, ICU) as well as the dosing
scheme coded as the number of daily administrations (1 for continuous
infusion).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select predictors and target}
\NormalTok{data\_recipe }\OtherTok{\textless{}{-}} \FunctionTok{recipe}\NormalTok{(DOSE\_TARGET }\SpecialCharTok{\textasciitilde{}}\NormalTok{ WT }\SpecialCharTok{+}\NormalTok{ CREAT }\SpecialCharTok{+}\NormalTok{ BURN }\SpecialCharTok{+}\NormalTok{ ICU }\SpecialCharTok{+}\NormalTok{ OBESE }\SpecialCharTok{+}\NormalTok{ SEX }\SpecialCharTok{+}\NormalTok{ AGE }\SpecialCharTok{+}\NormalTok{ INF, }\AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_mutate}\NormalTok{(}\AttributeTok{BURN =} \FunctionTok{factor}\NormalTok{(BURN), }\AttributeTok{ICU =} \FunctionTok{factor}\NormalTok{(ICU), }\AttributeTok{OBESE =} \FunctionTok{factor}\NormalTok{(OBESE), }\AttributeTok{SEX =} \FunctionTok{factor}\NormalTok{(SEX)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_dummy}\NormalTok{(}\FunctionTok{all\_nominal\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_numeric\_predictors}\NormalTok{())  }\CommentTok{\# Normalize numeric variables}
  
\NormalTok{svm\_spec }\OtherTok{\textless{}{-}} \FunctionTok{svm\_rbf}\NormalTok{(}\AttributeTok{mode =} \StringTok{"regression"}\NormalTok{, }\AttributeTok{cost =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{rbf\_sigma =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"kernlab"}\NormalTok{)}

\NormalTok{rf\_spec }\OtherTok{\textless{}{-}} \FunctionTok{rand\_forest}\NormalTok{(}\AttributeTok{mode =} \StringTok{"regression"}\NormalTok{, }\AttributeTok{trees =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{mtry =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"ranger"}\NormalTok{, }\AttributeTok{importance =} \StringTok{"impurity"}\NormalTok{)}

\NormalTok{xgb\_spec }\OtherTok{\textless{}{-}} \FunctionTok{boost\_tree}\NormalTok{(}\AttributeTok{mode =} \StringTok{"regression"}\NormalTok{, }\AttributeTok{trees =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{learn\_rate =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{tree\_depth =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"xgboost"}\NormalTok{)}

\NormalTok{knn\_spec }\OtherTok{\textless{}{-}} \FunctionTok{nearest\_neighbor}\NormalTok{(}\AttributeTok{mode =} \StringTok{"regression"}\NormalTok{, }\AttributeTok{neighbors =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"kknn"}\NormalTok{)}

\CommentTok{\# Create cross{-}validation folds}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1995}\NormalTok{)}
\NormalTok{folds }\OtherTok{\textless{}{-}} \FunctionTok{vfold\_cv}\NormalTok{(AMOX\_CMIN\_TRAIN, }\AttributeTok{v =} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{XGboost}\label{xgboost}

XGBoost is based on decision trees and the boosting algorithm,
developing trees sequentially to correct the prediction errors of
previous trees. Model overfitting is controlled by incorporating Lasso
(L1) and Ridge (L2) algorithms. XGBoost is faster and has better
computational efficiency compared to Random Forest. While XGBoost is
less interpretable, it is better suited for larger datasets than Random
Forest. Whereas Random Forest helps reduce variance, XGBoost primarily
reduces bias.

The hyperparameters to define are as follows:

\begin{itemize}
\item
  \textbf{Î·} -- learning rate (default: 0.3)
\item
  \textbf{Î³} -- the minimum loss required for a new split; if increased,
  the algorithm becomes more conservative
\item
  \textbf{max depth} -- tree depth (typical values range from 3 to 10)
\item
  \textbf{minimum child weight} - minimum number of observations in the
  terminal node
\item
  \textbf{Î»/Î±} -- regularization parameters for Ridge/Lasso
\item
  \textbf{max levels} -- maximum number of nodes
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Parallel processing}
\NormalTok{num\_cores }\OtherTok{\textless{}{-}}\NormalTok{ parallel}\SpecialCharTok{::}\FunctionTok{detectCores}\NormalTok{() }\SpecialCharTok{{-}} \DecValTok{1}
\CommentTok{\#num\_cores\textless{}{-}2}
\NormalTok{cl }\OtherTok{\textless{}{-}} \FunctionTok{makeCluster}\NormalTok{(num\_cores,}\AttributeTok{outfile=}\StringTok{"log.txt"}\NormalTok{,}\AttributeTok{type=}\StringTok{"PSOCK"}\NormalTok{,}\AttributeTok{rscript\_args =} \FunctionTok{c}\NormalTok{(}\StringTok{"{-}{-}no{-}init{-}file"}\NormalTok{, }\StringTok{"{-}{-}no{-}site{-}file"}\NormalTok{,}
\StringTok{"{-}{-}no{-}environ"}\NormalTok{))}
\FunctionTok{registerDoParallel}\NormalTok{(cl)}

\CommentTok{\# XGboost}
\NormalTok{xgb\_wf }\OtherTok{\textless{}{-}} \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_model}\NormalTok{(xgb\_spec) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_recipe}\NormalTok{(data\_recipe)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1995}\NormalTok{)}
\NormalTok{tune\_xgb }\OtherTok{\textless{}{-}} \FunctionTok{tune\_grid}\NormalTok{(}
\NormalTok{  xgb\_wf, }
  \AttributeTok{resamples =}\NormalTok{ folds, }
  \AttributeTok{grid =} \DecValTok{10}\NormalTok{,  }
  \AttributeTok{control =} \FunctionTok{control\_stack\_grid}\NormalTok{()}
\NormalTok{)}

\NormalTok{tuning\_xgboost }\OtherTok{\textless{}{-}} \FunctionTok{autoplot}\NormalTok{(tune\_xgb, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{,  }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Hyperparameter tuning {-} XGboost"}\NormalTok{)}
\NormalTok{tuning\_xgboost}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/xgboost-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Stop parallel processing}
\FunctionTok{stopCluster}\NormalTok{(cl)}
\FunctionTok{registerDoSEQ}\NormalTok{()}

\CommentTok{\# Select the best model based on RMSE}
\NormalTok{best\_xgb }\OtherTok{\textless{}{-}} \FunctionTok{select\_best}\NormalTok{(tune\_xgb, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{)}

\CommentTok{\# Finalize the model}
\NormalTok{final\_xgb\_wf }\OtherTok{\textless{}{-}} \FunctionTok{finalize\_workflow}\NormalTok{(xgb\_wf, best\_xgb)}
\NormalTok{final\_xgb\_wf}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
== Workflow ====================================================================
Preprocessor: Recipe
Model: boost_tree()

-- Preprocessor ----------------------------------------------------------------
3 Recipe Steps

* step_mutate()
* step_dummy()
* step_normalize()

-- Model -----------------------------------------------------------------------
Boosted Tree Model Specification (regression)

Main Arguments:
  trees = 889
  tree_depth = 1
  learn_rate = 0.00359381366380463

Computational engine: xgboost 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit the final model on the training data}
\NormalTok{final\_xgb\_fit }\OtherTok{\textless{}{-}} \FunctionTok{fit}\NormalTok{(final\_xgb\_wf, }\AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN)}

\CommentTok{\# Predict on test data}
\NormalTok{xgb\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_xgb\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST)}

\CommentTok{\# Calculate the true dosing interval (to rech 40 and 80 mg/L) and see if the predicted dose to reach 60 mg/L is in this interval}
\NormalTok{xgb\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\CommentTok{\# Calculate uner{-} and overdosing}
\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
  Dosing         n Proportion Label            
  <fct>      <int>      <dbl> <chr>            
1 On target    273       45.5 "On target\n46%" 
2 Overdosed    263       43.8 "Overdosed\n44%" 
3 Underdosed    64       10.7 "Underdosed\n11%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# CREAT and WT statistics}
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 45.5 %"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Clinical CREAT blins}
\NormalTok{xgb\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

\CommentTok{\# Calculate the proportion of correct predictions in each CREAT bin}
\NormalTok{bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

\CommentTok{\# Bar plot for correct prediction percentages}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }
            \AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"XGBoost {-} simulation"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"CREAT (mL/min)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"\% Correct"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/xgboost-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(p3, }\AttributeTok{file =} \StringTok{"Figures/XGB.RData"}\NormalTok{)}


\CommentTok{\# Print mean and sd of covariates for correct and incorrect predictions}
\FunctionTok{print}\NormalTok{(summary\_stats)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 7
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT Count Proportion
  <chr>                       <dbl>    <dbl>   <dbl> <dbl> <int>      <dbl>
1 Correct                     0.878    0.428    81.8  16.3   273      0.455
2 Incorrect                   1.01     0.673    86.8  20.1   327      0.545
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Variable importance plot}
\NormalTok{XGB\_VIP }\OtherTok{\textless{}{-}}\NormalTok{ final\_xgb\_fit }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{extract\_fit\_engine}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{vip}\NormalTok{(}\AttributeTok{geom =} \StringTok{"point"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Variable Importance {-} XGBoost"}\NormalTok{)}
\NormalTok{XGB\_VIP}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/xgboost-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/XGB\_VIP.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ XGB\_VIP,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\CommentTok{\# Box plot for observed vs predicted dose}
\NormalTok{long\_data }\OtherTok{\textless{}{-}}\NormalTok{ xgb\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_longer}\NormalTok{(}
    \AttributeTok{cols =} \FunctionTok{c}\NormalTok{(DOSE\_ADM, .pred),}
    \AttributeTok{names\_to =} \StringTok{"DOSE"}\NormalTok{,}
    \AttributeTok{values\_to =} \StringTok{"Value"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{DOSE =} \FunctionTok{recode}\NormalTok{(DOSE, }
                  \AttributeTok{DOSE\_ADM =} \StringTok{"Observed"}\NormalTok{, }
                  \AttributeTok{.pred =} \StringTok{"Predicted"}\NormalTok{)}
\NormalTok{  )}

\NormalTok{pred\_xgboost }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(long\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ DOSE, }\AttributeTok{y =}\NormalTok{ Value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"XGboost {-} dose"}\NormalTok{,}
    \AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Dose (mg)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{pred\_xgboost}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/xgboost-4.pdf}}

\section{Support Vector Machine}\label{support-vector-machine}

Introduced in 1995, Support Vector Machines (SVM) classify data by
finding a hyperplane that maximizes the distance between classes in a
multi-dimensional space. Unlike K-Nearest Neighbors (KNN), SVM is
effective for high-dimensional data. It is suitable for both linear and
non-linear problems.

\begin{itemize}
\item
  \textbf{Cost} -- regularization parameter that determines the weight
  given to classification errors. If cost increases, tolerance for
  classification errors decreases. A smaller cost improves
  generalizability.
\item
  \textbf{Ï} -- controls the shape of the decision boundary. A smaller
  value captures local trends better but may lead to overfitting and
  reduced generalizability.
\end{itemize}

\includegraphics[width=5.33333in,height=\textheight,keepaspectratio]{images/image-186925171.png}

Image source:
\href{https://medium.com/@jainvidip/understanding-support-vector-machines-svms-1f7c78bad934}{Understanding
Support Vector Machines}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# workflow}
\NormalTok{svm\_wf }\OtherTok{\textless{}{-}} \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_model}\NormalTok{(svm\_spec) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_recipe}\NormalTok{(data\_recipe)}

\CommentTok{\# Tune hyperparameters}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1995}\NormalTok{)}
\NormalTok{tune\_svm }\OtherTok{\textless{}{-}} \FunctionTok{tune\_grid}\NormalTok{(}
\NormalTok{  svm\_wf, }
  \AttributeTok{resamples =}\NormalTok{ folds, }
  \AttributeTok{grid =} \DecValTok{10}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{control\_stack\_grid}\NormalTok{()}
\NormalTok{)}

\NormalTok{tuning\_svm }\OtherTok{\textless{}{-}} \FunctionTok{autoplot}\NormalTok{(tune\_svm, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{,  }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Hyperparameter tuning {-} SVM"}\NormalTok{)}
\NormalTok{tuning\_svm}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/SVM-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select the best model}
\NormalTok{best\_svm }\OtherTok{\textless{}{-}} \FunctionTok{select\_best}\NormalTok{(tune\_svm, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{)}

\CommentTok{\# Finalize workflow}
\NormalTok{final\_svm\_wf }\OtherTok{\textless{}{-}} \FunctionTok{finalize\_workflow}\NormalTok{(svm\_wf, best\_svm)}
\NormalTok{final\_svm\_wf}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
== Workflow ====================================================================
Preprocessor: Recipe
Model: svm_rbf()

-- Preprocessor ----------------------------------------------------------------
3 Recipe Steps

* step_mutate()
* step_dummy()
* step_normalize()

-- Model -----------------------------------------------------------------------
Radial Basis Function Support Vector Machine Model Specification (regression)

Main Arguments:
  cost = 3.1748021039364
  rbf_sigma = 1

Computational engine: kernlab 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit the best model}
\NormalTok{final\_svm\_fit }\OtherTok{\textless{}{-}} \FunctionTok{fit}\NormalTok{(final\_svm\_wf, }\AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN)}

\CommentTok{\# Predict for test data}
\NormalTok{svm\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_svm\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST)}

\CommentTok{\# Calculate the true dosing interval (to rech 40 and 80 mg/L) and see if the predicted dose to reach 60 mg/L is in this interval}
\NormalTok{svm\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
  Dosing         n Proportion Label            
  <fct>      <int>      <dbl> <chr>            
1 On target    295       49.2 "On target\n49%" 
2 Overdosed    202       33.7 "Overdosed\n34%" 
3 Underdosed   103       17.2 "Underdosed\n17%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 49.17 %"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Clinical CREAT blins}
\NormalTok{svm\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

\CommentTok{\# Calculate the proportion of correct predictions in each CREAT bin}
\NormalTok{bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

\CommentTok{\# Bar plot for correct prediction percentages}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }
            \AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"SVM {-} simulation"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"CREAT (mL/min)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"\% Correct"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/SVM-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Print mean and sd of covariates for correct and incorrect predictions}
\FunctionTok{print}\NormalTok{(summary\_stats)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 7
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT Count Proportion
  <chr>                       <dbl>    <dbl>   <dbl> <dbl> <int>      <dbl>
1 Correct                     0.901    0.437    83.7  18.1   295      0.492
2 Incorrect                   0.997    0.685    85.3  19.1   305      0.508
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Box plot for observed vs predicted dose}
\NormalTok{long\_data }\OtherTok{\textless{}{-}}\NormalTok{ svm\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_longer}\NormalTok{(}
    \AttributeTok{cols =} \FunctionTok{c}\NormalTok{(DOSE\_ADM, .pred),}
    \AttributeTok{names\_to =} \StringTok{"DOSE"}\NormalTok{,}
    \AttributeTok{values\_to =} \StringTok{"Value"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{DOSE =} \FunctionTok{recode}\NormalTok{(DOSE, }
                  \AttributeTok{DOSE\_ADM =} \StringTok{"Observed"}\NormalTok{, }
                  \AttributeTok{.pred =} \StringTok{"Predicted"}\NormalTok{)}
\NormalTok{  )}

\NormalTok{pred\_svm }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(long\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ DOSE, }\AttributeTok{y =}\NormalTok{ Value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"SVM {-} Dose"}\NormalTok{,}
    \AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Dose (mg)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{pred\_svm}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/SVM-3.pdf}}

\section{Random forest}\label{random-forest}

A decision tree is a model that represents possible decision paths in a
schematic tree-like structure. In regression trees, node splitting is
done to minimize intra-group variance. In classification trees, node
purity can be measured using the Gini index, where \emph{f} is the
frequency of observations:

\[
\text{Gini index} = 2 \cdot f \cdot (1 - f)
\]

Introduced in 2001, Random Forest (RF) is a machine learning method
based on an ensemble of decision trees. It uses the bootstrap
aggregating algorithm (commonly known as ``bagging''). The performance
of an RF model is measured by prediction error, which corresponds to the
mean squared error (MSE) for regression problems. Random Forest helps
reduce variance, making it suitable for unstable, unbiased data.

Hyperparameters to define:

\begin{itemize}
\item
  \textbf{Number of trees} (typically around 400)
\item
  \textbf{mtry} -- the number of variables considered at each node.
  Default value is \(\sqrt{\text{number of predictors}}\)
\item
  \textbf{Number of observations in the terminal node (leaf)}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# workflow}
\NormalTok{rf\_wf }\OtherTok{\textless{}{-}} \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_model}\NormalTok{(rf\_spec) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_recipe}\NormalTok{(data\_recipe)}

\CommentTok{\# Tune hyperparameters}
\NormalTok{tune\_rf }\OtherTok{\textless{}{-}} \FunctionTok{tune\_grid}\NormalTok{(}
\NormalTok{  rf\_wf, }
  \AttributeTok{resamples =}\NormalTok{ folds, }
  \AttributeTok{grid =} \DecValTok{10}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{control\_stack\_grid}\NormalTok{()}
\NormalTok{)}

\NormalTok{tuning\_rf }\OtherTok{\textless{}{-}} \FunctionTok{autoplot}\NormalTok{(tune\_rf, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{,  }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Hyperparameter tuning {-} RF"}\NormalTok{)}
\NormalTok{tuning\_rf}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/Random-forest-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select the best model}
\NormalTok{best\_rf }\OtherTok{\textless{}{-}} \FunctionTok{select\_best}\NormalTok{(tune\_rf, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{)}

\CommentTok{\# Finalize workflow}
\NormalTok{final\_rf\_wf }\OtherTok{\textless{}{-}} \FunctionTok{finalize\_workflow}\NormalTok{(rf\_wf, best\_rf)}
\NormalTok{final\_rf\_wf}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
== Workflow ====================================================================
Preprocessor: Recipe
Model: rand_forest()

-- Preprocessor ----------------------------------------------------------------
3 Recipe Steps

* step_mutate()
* step_dummy()
* step_normalize()

-- Model -----------------------------------------------------------------------
Random Forest Model Specification (regression)

Main Arguments:
  mtry = 1
  trees = 1555

Engine-Specific Arguments:
  importance = impurity

Computational engine: ranger 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit the best model}
\NormalTok{final\_rf\_fit }\OtherTok{\textless{}{-}} \FunctionTok{fit}\NormalTok{(final\_rf\_wf, }\AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN)}

\CommentTok{\# Predict for test data}
\NormalTok{rf\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_rf\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST)}

\NormalTok{rf\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
  Dosing         n Proportion Label           
  <fct>      <int>      <dbl> <chr>           
1 On target    271      45.2  "On target\n45%"
2 Overdosed    283      47.2  "Overdosed\n47%"
3 Underdosed    46       7.67 "Underdosed\n8%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 45.17 %"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Clinical CREAT blins}
\NormalTok{rf\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

\CommentTok{\# Calculate the proportion of correct predictions in each CREAT bin}
\NormalTok{bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

\CommentTok{\# Bar plot for correct prediction percentages}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }
            \AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"Random forest"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"CREAT (mL/min)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"Correct predictions (\%)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/Random-forest-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Print mean and sd of covariates for correct and incorrect predictions}
\FunctionTok{print}\NormalTok{(summary\_stats)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 7
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT Count Proportion
  <chr>                       <dbl>    <dbl>   <dbl> <dbl> <int>      <dbl>
1 Correct                     0.870    0.427    82.1  17.1   271      0.452
2 Incorrect                   1.01     0.671    86.5  19.6   329      0.548
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{RF\_VIP }\OtherTok{\textless{}{-}}\NormalTok{ final\_rf\_fit }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{extract\_fit\_engine}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{vip}\NormalTok{(}\AttributeTok{geom =} \StringTok{"point"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Variable Importance {-} Random forest"}\NormalTok{)}

\NormalTok{RF\_VIP}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/Random-forest-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/RF\_VIP.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ RF\_VIP,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\CommentTok{\# Box plot for observed vs predicted DOSE}
\NormalTok{long\_data }\OtherTok{\textless{}{-}}\NormalTok{ rf\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_longer}\NormalTok{(}
    \AttributeTok{cols =} \FunctionTok{c}\NormalTok{(DOSE\_ADM, .pred),}
    \AttributeTok{names\_to =} \StringTok{"DOSE"}\NormalTok{,}
    \AttributeTok{values\_to =} \StringTok{"Value"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{DOSE =} \FunctionTok{recode}\NormalTok{(DOSE, }
                  \AttributeTok{DOSE\_ADM =} \StringTok{"Observed"}\NormalTok{, }
                  \AttributeTok{.pred =} \StringTok{"Predicted"}\NormalTok{)}
\NormalTok{  )}

\NormalTok{pred\_rf }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(long\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ DOSE, }\AttributeTok{y =}\NormalTok{ Value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"RF {-} DOSE"}\NormalTok{,}
    \AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Dose (mg)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{pred\_rf}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/Random-forest-4.pdf}}

\section{K-nearest neighbors (KNN)}\label{k-nearest-neighbors-knn}

KNN is a simple, non-parametric algorithm that is less sensitive to
outliers and is used to create clusters and make predictions based on
the similarity of data points. The disadvantage of KNN is that the
algorithm can take a long time to run, and it is less suited for
high-dimensional data.

\begin{itemize}
\item
  The value of k is determined through 5-fold cross-validation.
\item
  The distance is calculated between all data points and the target
  point.
\item
  The k nearest neighbors are selected.
\item
  The average of the target values of these nearest neighbors will be
  the prediction for the given point.
\end{itemize}

The most commonly used distance metrics are as follows:

\begin{itemize}
\item
  Euclidean Distance: The most commonly used; a straight line connecting
  two points in vector space. This distance is well-suited for outliers
  and noise but less suitable for data with different scales or high
  dimensionality. \[
  d(x, y) = \sqrt{(x - y)^2}
  \]
\item
  Manhattan Distance: Well-suited for categorical data and
  high-dimensional data. It is less suitable for data with different
  scales.
\end{itemize}

\[
d(x, y) = |x - y|
\]

\begin{itemize}
\tightlist
\item
  Minkowski Distance: A generalization of the two previous distances. It
  has an additional parameter, p, that controls the importance given to
  differences between data points. If p = 2, it becomes the Euclidean
  distance, and if p = 1, it becomes the Manhattan distance. This
  distance is suitable for mixed data but is less interpretable, and the
  value of p needs to be defined.
\end{itemize}

\[
d(x, y) = \left| (x - y)^p \right|^{1/p}
\]

Euclidean distance is the default distance used and it is the most
interpretable and intuitive. Hyperparameters to define:

\begin{itemize}
\item
  k
\item
  p (if Minkowski distance is used)
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\# KNN}

\CommentTok{\# workflow}
\NormalTok{knn\_wf }\OtherTok{\textless{}{-}} \FunctionTok{workflow}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_model}\NormalTok{(knn\_spec) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_recipe}\NormalTok{(data\_recipe)}

\CommentTok{\# Tune hyperparameters}
\NormalTok{tune\_knn }\OtherTok{\textless{}{-}} \FunctionTok{tune\_grid}\NormalTok{(}
\NormalTok{  knn\_wf, }
  \AttributeTok{resamples =}\NormalTok{ folds, }
  \AttributeTok{grid =} \DecValTok{10}\NormalTok{, }
  \AttributeTok{control =} \FunctionTok{control\_stack\_grid}\NormalTok{()}
\NormalTok{)}

\NormalTok{tuning\_knn }\OtherTok{\textless{}{-}} \FunctionTok{autoplot}\NormalTok{(tune\_rf, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{,  }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Hyperparameter tuning {-} KNN"}\NormalTok{)}
\NormalTok{tuning\_knn}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/KNN-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select the best model}
\NormalTok{best\_knn }\OtherTok{\textless{}{-}} \FunctionTok{select\_best}\NormalTok{(tune\_knn, }\AttributeTok{metric =} \StringTok{"rmse"}\NormalTok{)}

\CommentTok{\# Finalize workflow}
\NormalTok{final\_knn\_wf }\OtherTok{\textless{}{-}} \FunctionTok{finalize\_workflow}\NormalTok{(knn\_wf, best\_knn)}
\NormalTok{final\_knn\_wf}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
== Workflow ====================================================================
Preprocessor: Recipe
Model: nearest_neighbor()

-- Preprocessor ----------------------------------------------------------------
3 Recipe Steps

* step_mutate()
* step_dummy()
* step_normalize()

-- Model -----------------------------------------------------------------------
K-Nearest Neighbor Model Specification (regression)

Main Arguments:
  neighbors = 15

Computational engine: kknn 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Fit the best model}
\NormalTok{final\_knn\_fit }\OtherTok{\textless{}{-}} \FunctionTok{fit}\NormalTok{(final\_knn\_wf, }\AttributeTok{data =}\NormalTok{ AMOX\_CMIN\_TRAIN)}

\CommentTok{\# Predict for test data}
\NormalTok{knn\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_knn\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST)}

\NormalTok{knn\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
  Dosing         n Proportion Label            
  <fct>      <int>      <dbl> <chr>            
1 On target    296       49.3 "On target\n49%" 
2 Overdosed    232       38.7 "Overdosed\n39%" 
3 Underdosed    72       12   "Underdosed\n12%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 49.33 %"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Clinical CREAT blins}
\NormalTok{knn\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

\CommentTok{\# Calculate the proportion of correct predictions in each CREAT bin}
\NormalTok{bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

\CommentTok{\# Bar plot for correct prediction percentages}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }
            \AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"KNN {-} simulation"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"CREAT (mL/min)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"\% Correct"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/KNN-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Print mean and sd of covariates for correct and incorrect predictions}
\FunctionTok{print}\NormalTok{(summary\_stats)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 2 x 7
  Prediction_correctness mean_CREAT sd_CREAT mean_WT sd_WT Count Proportion
  <chr>                       <dbl>    <dbl>   <dbl> <dbl> <int>      <dbl>
1 Correct                     0.983    0.579    82.5  17.8   296      0.493
2 Incorrect                   0.917    0.576    86.5  19.3   304      0.507
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Box plot for observed vs predicted DOSE}
\NormalTok{long\_data }\OtherTok{\textless{}{-}}\NormalTok{ knn\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_longer}\NormalTok{(}
    \AttributeTok{cols =} \FunctionTok{c}\NormalTok{(DOSE\_ADM, .pred),}
    \AttributeTok{names\_to =} \StringTok{"DOSE"}\NormalTok{,}
    \AttributeTok{values\_to =} \StringTok{"Value"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{DOSE =} \FunctionTok{recode}\NormalTok{(DOSE, }
                  \AttributeTok{DOSE\_ADM =} \StringTok{"Observed"}\NormalTok{, }
                  \AttributeTok{.pred =} \StringTok{"Predicted"}\NormalTok{)}
\NormalTok{  )}

\NormalTok{pred\_knn }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(long\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ DOSE, }\AttributeTok{y =}\NormalTok{ Value)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"KNN {-} DOSE"}\NormalTok{,}
    \AttributeTok{x =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{y =} \StringTok{"Dose (mg)"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{20}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{),    }
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{), }
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{24}\NormalTok{),}
\NormalTok{  )}

\NormalTok{pred\_knn}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/KNN-3.pdf}}

\section{Stacking}\label{stacking}

The blend\_predictions function determines how member model output will
ultimately be combined in the final prediction by fitting a Lasso model
on the data stack, predicting the true assessment set outcome using the
predictions from each of the candidate members. Candidates with nonzero
stacking coefficients become members.

These plots the meta-learning model over a predefined grid of lasso
penalty values and uses an internal resampling method to determine the
best value. The autoplot() method, shown helps us understand if the
default penalization method was sufficient. It can also be used to
visualize the contribution of each model type.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{amox\_cmax }\OtherTok{\textless{}{-}} 
  \FunctionTok{stacks}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \CommentTok{\#results of tune\_grid}
  \FunctionTok{add\_candidates}\NormalTok{(tune\_xgb) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_candidates}\NormalTok{(tune\_svm) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_candidates}\NormalTok{(tune\_rf) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{add\_candidates}\NormalTok{(tune\_knn) }

\FunctionTok{as\_tibble}\NormalTok{(amox\_cmax)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 1,874 x 41
   DOSE_TARGET tune_xgb_1_04 tune_xgb_1_09 tune_xgb_1_03 tune_xgb_1_06
         <dbl>         <dbl>         <dbl>         <dbl>         <dbl>
 1      18255.         396.         31583.        15587.        14497.
 2      17141.         185.         17839.        17804.         8266.
 3      19101.         184.         19898.        17296.         7630.
 4       9512.         139.          9480.         6506.         4511.
 5      13994.         193.         15313.        14240.         9675.
 6       3787.          84.1         7188.        -1338.         3625.
 7      14099.         232.         25536.        46146.         7053.
 8      35338.         396.         13345.        11293.        11707.
 9      10534.          96.0         9693.         7682.         3687.
10      25607.         326.         17946.        17947.        13734.
# i 1,864 more rows
# i 36 more variables: tune_xgb_1_01 <dbl>, tune_xgb_1_08 <dbl>,
#   tune_xgb_1_10 <dbl>, tune_xgb_1_02 <dbl>, tune_xgb_1_05 <dbl>,
#   tune_xgb_1_07 <dbl>, tune_svm_1_01 <dbl>, tune_svm_1_02 <dbl>,
#   tune_svm_1_03 <dbl>, tune_svm_1_04 <dbl>, tune_svm_1_05 <dbl>,
#   tune_svm_1_06 <dbl>, tune_svm_1_07 <dbl>, tune_svm_1_08 <dbl>,
#   tune_svm_1_09 <dbl>, tune_svm_1_10 <dbl>, tune_rf_1_01 <dbl>, ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{conflicted}\SpecialCharTok{::}\FunctionTok{conflicts\_prefer}\NormalTok{(brulee}\SpecialCharTok{::}\NormalTok{coef)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1234}\NormalTok{)}
\NormalTok{amox\_cmax\_ens }\OtherTok{\textless{}{-}}
\NormalTok{  amox\_cmax }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{blend\_predictions}\NormalTok{()}

\FunctionTok{autoplot}\NormalTok{(amox\_cmax\_ens)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/stacking-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{autoplot}\NormalTok{(amox\_cmax\_ens, }\AttributeTok{type =} \StringTok{"members"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/stacking-2.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stacking\_plot }\OtherTok{\textless{}{-}} \FunctionTok{autoplot}\NormalTok{(amox\_cmax\_ens, }\AttributeTok{type =} \StringTok{"weights"}\NormalTok{)}
\NormalTok{stacking\_plot}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/stacking-3.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\AttributeTok{filename =} \StringTok{"Figures/stacking\_plot.jpg"}\NormalTok{,}
       \AttributeTok{plot =}\NormalTok{ stacking\_plot,}
       \AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1995}\NormalTok{)}
\NormalTok{amox\_cmax\_ens\_fitted }\OtherTok{\textless{}{-}}
\NormalTok{  amox\_cmax\_ens }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{fit\_members}\NormalTok{()}

\NormalTok{DOSE\_test }\OtherTok{\textless{}{-}}\NormalTok{ AMOX\_CMIN\_TEST }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{select}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"OBESE"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{, }\StringTok{"HT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{, }\StringTok{"INF"}\NormalTok{, }\StringTok{"MODEL\_COHORT"}\NormalTok{, }\StringTok{"FREQ"}\NormalTok{, }\StringTok{"DUR"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"DOSE\_ADM"}\NormalTok{, }\StringTok{"DOSE\_inf"}\NormalTok{, }\StringTok{"DOSE\_sup"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{CONC =} \DecValTok{60}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{()}

\NormalTok{reg\_metrics }\OtherTok{\textless{}{-}} \FunctionTok{metric\_set}\NormalTok{(rmse, rsq)}

\NormalTok{stack\_test\_predictions }\OtherTok{\textless{}{-}} 
\NormalTok{stacks}\SpecialCharTok{::}\FunctionTok{augment}\NormalTok{(amox\_cmax\_ens\_fitted, DOSE\_test)}

\NormalTok{stack\_test\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ stack\_test\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ stack\_test\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
# A tibble: 3 x 4
  Dosing         n Proportion Label           
  <fct>      <int>      <dbl> <chr>           
1 On target    298      49.7  "On target\n50%"
2 Overdosed    255      42.5  "Overdosed\n42%"
3 Underdosed    47       7.83 "Underdosed\n8%"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ stack\_test\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 49.67 %"
\end{verbatim}

\section{Decision tree based ML
ensembling}\label{decision-tree-based-ml-ensembling}

Decision tree ensembling just like stacking uses the four methods
described earlier: Random forest, XGboost, Support vector machine and K
nearest neighbors (KNN).\\
It is composed of 3 steps\\
\(1_{st}\) step - Training separately the ML models\\
First set of training data - training separately the four ML models (RF,
XGB, SVM, KNN). Predictors: covariates + dosing scheme. Target: Target
dose. Predictions are made for the first set of test data.\\
\(2_{nd}\) step - Test data preparation for decision tree\\
Predictions are made for the second set of test data with the models
trained in the 1st step. The resulting dataset has the covariates and
separate predictions for RF, XGB, SVM, and KNN as well as dose by the
PopPK models.\\
\(3_{rd}\) step - Decision tree\\
The first set of test data (including ML predictions) becomes second set
of training data. A regression tree is fitted with predictors:
Covariates + dosing scheme + ML model predictions (RF, XGB, SVM, KNN).
Target: Dose. Using the trained decision tree, predictions are made for
the test data prepared in the 2nd step.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Predict on test data with the already trained XGB model}
\NormalTok{test\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_xgb\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{XGB =}\NormalTok{ .pred}
\NormalTok{  )}

\CommentTok{\# Predict on test data with the already trained SVM model}
\NormalTok{svm\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_svm\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{SVM =}\NormalTok{ .pred}
\NormalTok{  )}

\CommentTok{\# Predict on test data with the already trained SVM model}
\NormalTok{rf\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_rf\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{RF =}\NormalTok{ .pred}
\NormalTok{  )}

\CommentTok{\# Predict on test data with the already trained SVM model}
\NormalTok{knn\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(final\_knn\_fit, }\AttributeTok{new\_data =}\NormalTok{ AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{bind\_cols}\NormalTok{(AMOX\_CMIN\_TEST) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{KNN =}\NormalTok{ .pred}
\NormalTok{  )}

\CommentTok{\# Merge the three datasets}
\NormalTok{AMOX\_TEST2 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(test\_predictions, svm\_predictions, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"TIME"}\NormalTok{, }\StringTok{"MODEL"}\NormalTok{, }\StringTok{"DOSE\_ADM"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{,}\StringTok{"ICU"}\NormalTok{, }\StringTok{"OBESE"}\NormalTok{, }\StringTok{"INF"}\NormalTok{,}\StringTok{"MODEL\_COHORT"}\NormalTok{, }\StringTok{"REFERENCE"}\NormalTok{, }\StringTok{"PRED"}\NormalTok{, }\StringTok{"FREQ"}\NormalTok{, }\StringTok{"DUR"}\NormalTok{, }\StringTok{"DOSE\_TARGET"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"DOSE\_inf"}\NormalTok{, }\StringTok{"DOSE\_sup"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{, }\StringTok{"HT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{))}
\NormalTok{AMOX\_TEST3 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(AMOX\_TEST2, rf\_predictions, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"TIME"}\NormalTok{, }\StringTok{"MODEL"}\NormalTok{, }\StringTok{"DOSE\_ADM"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{,}\StringTok{"ICU"}\NormalTok{, }\StringTok{"OBESE"}\NormalTok{, }\StringTok{"INF"}\NormalTok{,}\StringTok{"MODEL\_COHORT"}\NormalTok{, }\StringTok{"REFERENCE"}\NormalTok{, }\StringTok{"PRED"}\NormalTok{, }\StringTok{"FREQ"}\NormalTok{, }\StringTok{"DUR"}\NormalTok{, }\StringTok{"DOSE\_TARGET"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"DOSE\_inf"}\NormalTok{, }\StringTok{"DOSE\_sup"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{, }\StringTok{"HT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{))}
\NormalTok{data2 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(AMOX\_TEST3, knn\_predictions, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"TIME"}\NormalTok{, }\StringTok{"MODEL"}\NormalTok{, }\StringTok{"DOSE\_ADM"}\NormalTok{, }\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{,}\StringTok{"ICU"}\NormalTok{, }\StringTok{"OBESE"}\NormalTok{,}\StringTok{"INF"}\NormalTok{, }\StringTok{"MODEL\_COHORT"}\NormalTok{, }\StringTok{"REFERENCE"}\NormalTok{, }\StringTok{"PRED"}\NormalTok{, }\StringTok{"FREQ"}\NormalTok{, }\StringTok{"DUR"}\NormalTok{, }\StringTok{"DOSE\_TARGET"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"DOSE\_inf"}\NormalTok{, }\StringTok{"DOSE\_sup"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{, }\StringTok{"HT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{))}

\NormalTok{data2 }\OtherTok{\textless{}{-}}\NormalTok{ data2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{select}\NormalTok{(}\StringTok{"WT"}\NormalTok{, }\StringTok{"CREAT"}\NormalTok{, }\StringTok{"BURN"}\NormalTok{, }\StringTok{"ICU"}\NormalTok{, }\StringTok{"OBESE"}\NormalTok{, }\StringTok{"INF"}\NormalTok{, }\StringTok{"RF"}\NormalTok{, }\StringTok{"XGB"}\NormalTok{, }\StringTok{"KNN"}\NormalTok{,}\StringTok{"SVM"}\NormalTok{, }\StringTok{"DOSE\_ADM"}\NormalTok{ , }\StringTok{"FREQ"}\NormalTok{, }\StringTok{"DUR"}\NormalTok{, }\StringTok{"DOSE\_TARGET"}\NormalTok{, }\StringTok{"CMIN\_IND"}\NormalTok{, }\StringTok{"DOSE\_inf"}\NormalTok{, }\StringTok{"DOSE\_sup"}\NormalTok{, }\StringTok{"SEX"}\NormalTok{, }\StringTok{"HT"}\NormalTok{, }\StringTok{"AGE"}\NormalTok{)}

\CommentTok{\# Divide the data to training and test data (50{-}50)}
\NormalTok{idx }\OtherTok{\textless{}{-}} \FunctionTok{seq\_len}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data2)) }\SpecialCharTok{\%\%} \DecValTok{2} \SpecialCharTok{==} \DecValTok{1}

\NormalTok{data3 }\OtherTok{\textless{}{-}}\NormalTok{ data2[idx, ]}
\NormalTok{test\_data }\OtherTok{\textless{}{-}}\NormalTok{ data2[}\SpecialCharTok{!}\NormalTok{idx, ]}

\DocumentationTok{\#\#\#\# SECOND ML TRAINING {-} DECISION TREE \#\#\#\#}

\CommentTok{\# Range for complexity parameter to test (based on cross{-}validation)}
\NormalTok{cp\_values }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.015}\NormalTok{, }\AttributeTok{by =} \FloatTok{0.001}\NormalTok{) }

 \CommentTok{\# Perform cross{-}validation for each complexity value}
\NormalTok{  cv\_results }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(cp\_values, }\ControlFlowTok{function}\NormalTok{(cp) \{}
\NormalTok{    cfit }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(}
\NormalTok{      DOSE\_TARGET }\SpecialCharTok{\textasciitilde{}}\NormalTok{ WT }\SpecialCharTok{+}\NormalTok{ CREAT }\SpecialCharTok{+}\NormalTok{ BURN }\SpecialCharTok{+}\NormalTok{ ICU }\SpecialCharTok{+}\NormalTok{ OBESE }\SpecialCharTok{+}\NormalTok{ SEX }\SpecialCharTok{+}\NormalTok{ AGE }\SpecialCharTok{+}\NormalTok{ INF }\SpecialCharTok{+}\NormalTok{ SVM }\SpecialCharTok{+}\NormalTok{ RF }\SpecialCharTok{+}\NormalTok{ XGB }\SpecialCharTok{+}\NormalTok{ KNN,}
      \AttributeTok{data =}\NormalTok{ data3,}
      \AttributeTok{method =} \StringTok{\textquotesingle{}anova\textquotesingle{}}\NormalTok{,}
      \AttributeTok{control =} \FunctionTok{rpart.control}\NormalTok{(}
        \AttributeTok{cp =}\NormalTok{ cp, }\CommentTok{\# Complexity parameter}
        \AttributeTok{xval =} \DecValTok{5}\NormalTok{, }\CommentTok{\# Cross{-}validation}
        \AttributeTok{minsplit =} \DecValTok{4}\NormalTok{, }\CommentTok{\# Minimum number of samples to split}
        \AttributeTok{minbucket =} \DecValTok{4} \CommentTok{\# Minimum number of samples in a leaf}
\NormalTok{      )}
\NormalTok{    )}
    \FunctionTok{min}\NormalTok{(cfit}\SpecialCharTok{$}\NormalTok{cptable[, }\StringTok{"xerror"}\NormalTok{]) }\CommentTok{\# Extract the minimum cross{-}validation error}
\NormalTok{  \})}

 \CommentTok{\# Find the best cp value}
\NormalTok{  best\_cp }\OtherTok{\textless{}{-}}\NormalTok{ cp\_values[}\FunctionTok{which.min}\NormalTok{(cv\_results)]}
  
  \CommentTok{\# Fit the final decision tree with the best cp value}
\NormalTok{  regression\_tree }\OtherTok{\textless{}{-}} \FunctionTok{rpart}\NormalTok{(}
\NormalTok{    DOSE\_TARGET }\SpecialCharTok{\textasciitilde{}}\NormalTok{ WT }\SpecialCharTok{+}\NormalTok{ CREAT }\SpecialCharTok{+}\NormalTok{ BURN }\SpecialCharTok{+}\NormalTok{ ICU }\SpecialCharTok{+}\NormalTok{ OBESE }\SpecialCharTok{+}\NormalTok{ SEX }\SpecialCharTok{+}\NormalTok{ AGE }\SpecialCharTok{+}\NormalTok{ INF }\SpecialCharTok{+}\NormalTok{ SVM }\SpecialCharTok{+}\NormalTok{ RF }\SpecialCharTok{+}\NormalTok{ XGB }\SpecialCharTok{+}\NormalTok{ KNN,}
    \AttributeTok{data =}\NormalTok{ data3,}
    \AttributeTok{method =} \StringTok{\textquotesingle{}anova\textquotesingle{}}\NormalTok{,}
    \AttributeTok{control =} \FunctionTok{rpart.control}\NormalTok{(}
      \AttributeTok{cp =}\NormalTok{ best\_cp,}
      \AttributeTok{xval =} \DecValTok{5}\NormalTok{,}
      \AttributeTok{minsplit =} \DecValTok{4}\NormalTok{,}
      \AttributeTok{minbucket =} \DecValTok{4}
\NormalTok{    )}
\NormalTok{  )}
  
  \CommentTok{\# Plot the tree}
\NormalTok{ ML\_ensembling\_plot }\OtherTok{\textless{}{-}} \FunctionTok{rpart.plot}\NormalTok{(regression\_tree, }\AttributeTok{type =} \DecValTok{3}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{, }\AttributeTok{fallen.leaves =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/decision-tree-ensembling-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ ML\_ensembling\_plot}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
$obj
n= 300 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 300 223613100000  17551.230  
   2) RF< 29928.1 296  45096870000  15701.810  
     4) KNN< 14454.07 139   5103454000   9625.221 *
     5) KNN>=14454.07 157  30316740000  21081.720  
      10) SVM>=7683.966 153  19060390000  19964.870 *
      11) SVM< 7683.966 4   3765682000  63801.200 *
   3) RF>=29928.1 4 102584200000 154408.500 *

$snipped.nodes
NULL

$xlim
[1] 0 1

$ylim
[1] 0 1

$x
[1] 0.6136040 0.3070276 0.1026432 0.5114119 0.3751557 0.6476681 0.9201805

$y
[1] 1.03897910 0.74074384 0.05480275 0.44250858 0.05480275 0.05480275 0.05480275

$branch.x
      [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
x 0.613604 0.3070276 0.1026432 0.5114119 0.3751557 0.6476681 0.9201805
        NA 0.3070276 0.1026432 0.5114119 0.3751557 0.6476681 0.9201805
        NA 0.6136040 0.3070276 0.3070276 0.5114119 0.5114119 0.6136040

$branch.y
      [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
y 1.038979 0.7407438 0.1521769 0.4425086 0.1521769 0.1521769 0.1521769
        NA 1.0389791 0.7407438 0.7407438 0.4425086 0.4425086 1.0389791
        NA 1.0389791 0.7407438 0.7407438 0.4425086 0.4425086 1.0389791

$labs
[1] NA              NA              "9625\n46.3%"   NA             
[5] "20e+3\n51.0%"  "63.8e+3\n1.3%" "154e+3\n1.3%" 

$cex
[1] 1

$boxes
$boxes$x1
[1]         NA         NA 0.03791383         NA 0.31042624 0.56869747 0.84611577

$boxes$y1
[1]            NA            NA -0.0008811221            NA -0.0008811221
[6] -0.0008811221 -0.0008811221

$boxes$x2
[1]        NA        NA 0.1673727        NA 0.4398851 0.7266387 0.9942452

$boxes$y2
[1]        NA        NA 0.1521769        NA 0.1521769 0.1521769 0.1521769


$split.labs
[1] ""

$split.cex
[1] 1 1 1 1 1 1 1

$split.box
$split.box$x1
[1]  0.19617579 -0.02290852          NA  0.26430389          NA          NA
[7]          NA

$split.box$y1
[1] 0.9055701 0.6073348        NA 0.3090996        NA        NA        NA

$split.box$x2
[1] 0.4178793 0.2281950        NA 0.4860074        NA        NA        NA

$split.box$y2
[1] 0.9889507 0.6907155        NA 0.3924802        NA        NA        NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{jpeg}\NormalTok{(}\StringTok{"Figures/ML\_ensembling\_plot.jpg"}\NormalTok{, }\AttributeTok{width =} \DecValTok{8}\NormalTok{, }\AttributeTok{height =} \DecValTok{6}\NormalTok{, }\AttributeTok{units =} \StringTok{"in"}\NormalTok{, }\AttributeTok{res =} \DecValTok{300}\NormalTok{)}
\FunctionTok{rpart.plot}\NormalTok{(regression\_tree, }\AttributeTok{type =} \DecValTok{3}\NormalTok{, }\AttributeTok{extra =} \DecValTok{0}\NormalTok{, }\AttributeTok{cex.main =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{main =} \StringTok{"ML ensembling"}\NormalTok{)}
\FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
pdf 
  2 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Make predictions for test data and add them to the test data}
\NormalTok{.pred }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(regression\_tree, }\AttributeTok{newdata =}\NormalTok{ test\_data)}
\NormalTok{ML\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(.pred)}
\NormalTok{ML\_predictions }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(test\_data, ML\_predictions)}

\CommentTok{\# Calculate correct dose predictions}
\NormalTok{ML\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ ML\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Prediction\_correctness =} \FunctionTok{ifelse}\NormalTok{((.pred }\SpecialCharTok{\textgreater{}=}\NormalTok{ DOSE\_inf }\SpecialCharTok{\&}\NormalTok{ .pred }\SpecialCharTok{\textless{}=}\NormalTok{ DOSE\_sup) }\SpecialCharTok{|} 
\NormalTok{                                    (.pred }\SpecialCharTok{\textgreater{}} \DecValTok{20000} \SpecialCharTok{\&}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{), }
                                    \StringTok{"Correct"}\NormalTok{, }\StringTok{"Incorrect"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{drop\_na}\NormalTok{(Prediction\_correctness)  }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Dosing =} \FunctionTok{case\_when}\NormalTok{(}
\NormalTok{    Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"} \SpecialCharTok{\textasciitilde{}} \StringTok{"On target"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textless{}}\NormalTok{ DOSE\_inf }\SpecialCharTok{\textasciitilde{}} \StringTok{"Underdosed"}\NormalTok{,}
\NormalTok{    .pred }\SpecialCharTok{\textgreater{}}\NormalTok{ DOSE\_sup }\SpecialCharTok{\textasciitilde{}} \StringTok{"Overdosed"}
\NormalTok{  ))}

\NormalTok{dosing }\OtherTok{\textless{}{-}}\NormalTok{ ML\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(Dosing) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ n }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(n) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
         \AttributeTok{Dosing =} \FunctionTok{factor}\NormalTok{(Dosing, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Overdosed"}\NormalTok{, }\StringTok{"On target"}\NormalTok{, }\StringTok{"Underdosed"}\NormalTok{)),}
         \AttributeTok{Label =} \FunctionTok{paste0}\NormalTok{(Dosing, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(Proportion), }\StringTok{"\%"}\NormalTok{))}

\FunctionTok{print}\NormalTok{(dosing)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      Dosing   n Proportion           Label
1  On target 113   37.66667  On target\n38%
2  Overdosed 148   49.33333  Overdosed\n49%
3 Underdosed  39   13.00000 Underdosed\n13%
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summary\_stats }\OtherTok{\textless{}{-}}\NormalTok{ ML\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{mean\_CREAT =} \FunctionTok{mean}\NormalTok{(CREAT),}
    \AttributeTok{sd\_CREAT =} \FunctionTok{sd}\NormalTok{(CREAT),}
    \AttributeTok{mean\_WT =} \FunctionTok{mean}\NormalTok{(WT),}
    \AttributeTok{sd\_WT =} \FunctionTok{sd}\NormalTok{(WT),}
    \AttributeTok{Count =} \FunctionTok{n}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion =}\NormalTok{ Count }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(Count))}

\NormalTok{correct\_proportion }\OtherTok{\textless{}{-}}\NormalTok{ summary\_stats }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Prediction\_correctness }\SpecialCharTok{==} \StringTok{"Correct"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{pull}\NormalTok{(Proportion)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Proportion of \textquotesingle{}correct\textquotesingle{} predictions:"}\NormalTok{, }\FunctionTok{round}\NormalTok{(correct\_proportion }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\DecValTok{2}\NormalTok{), }\StringTok{"\%"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1] "Proportion of 'correct' predictions: 37.67 %"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Clinical CREAT blins}
\NormalTok{ML\_predictions }\OtherTok{\textless{}{-}}\NormalTok{ ML\_predictions }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{CREAT\_bin =} \FunctionTok{case\_when}\NormalTok{(}\CommentTok{\# males}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{(}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      ),}
\NormalTok{      SEX }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\textasciitilde{}} \FunctionTok{cut}\NormalTok{( }\CommentTok{\# females}
\NormalTok{        CREAT,}
        \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{1.1}\NormalTok{, }\ConstantTok{Inf}\NormalTok{),}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Below normal"}\NormalTok{, }\StringTok{"Normal"}\NormalTok{, }\StringTok{"Above normal"}\NormalTok{),}
        \AttributeTok{right =} \ConstantTok{FALSE}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}

\CommentTok{\# Calculate the proportion of correct predictions in each CREAT bin}
\NormalTok{bin\_summary }\OtherTok{\textless{}{-}}\NormalTok{ ML\_predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(CREAT\_bin, Prediction\_correctness) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{Count =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  tidyr}\SpecialCharTok{::}\FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ Prediction\_correctness, }\AttributeTok{values\_from =}\NormalTok{ Count, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Proportion\_Correct =}\NormalTok{ (Correct }\SpecialCharTok{/}\NormalTok{ (Correct }\SpecialCharTok{+}\NormalTok{ Incorrect)) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}

\CommentTok{\# Bar plot for correct prediction percentages}
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(bin\_summary, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ CREAT\_bin, }\AttributeTok{y =}\NormalTok{ Proportion\_Correct)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{color =} \StringTok{"chartreuse4"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{round}\NormalTok{(Proportion\_Correct)), }
            \AttributeTok{vjust =} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =} \StringTok{"ML ensembling {-} simulation"}\NormalTok{,}
       \AttributeTok{x =} \StringTok{"CREAT (mL/min)"}\NormalTok{,}
       \AttributeTok{y =} \StringTok{"\% Correct"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{, }\AttributeTok{by =} \DecValTok{20}\NormalTok{))}

\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{Machine_Learning_files/figure-pdf/decision-tree-ensembling-2.pdf}}

\bookmarksetup{startatroot}

\chapter*{References}\label{references}
\addcontentsline{toc}{chapter}{References}

\markboth{References}{References}

\phantomsection\label{refs}
\begin{CSLReferences}{1}{0}
\bibitem[\citeproctext]{ref-Agema2024-cf}
Agema, Bram C, Tolra Kocher, AyÅenur B ÃztÃ¼rk, Eline L Giraud, Nielka P
van Erp, Brenda C M de Winter, Ron H J Mathijssen, Stijn L W Koolen,
Birgit C P Koch, and Sebastiaan D T Sassen. 2024. {``Selecting the Best
Pharmacokinetic Models for a Priori Model-Informed Precision Dosing with
Model Ensembling.''} \emph{Clin. Pharmacokinet.} 63 (10): 1449--61.

\bibitem[\citeproctext]{ref-Carlier2013-bq}
Carlier, Mieke, MichaÃ«l NoÃ«, Jan J De Waele, Veronique Stove, Alain G
Verstraete, Jeffrey Lipman, and Jason A Roberts. 2013. {``Population
Pharmacokinetics and Dosing Simulations of Amoxicillin/Clavulanic Acid
in Critically Ill Patients.''} \emph{J. Antimicrob. Chemother.} 68 (11):
2600--2608.

\bibitem[\citeproctext]{ref-fournier2018}
Fournier, Anne, Sylvain Goutelle, Yok-Ai Que, Philippe Eggimann, Olivier
Pantet, Farshid Sadeghipour, Pierre Voirol, and Chantal Csajka. 2018.
{``Population Pharmacokinetic Study of Amoxicillin-Treated Burn Patients
Hospitalized at a Swiss Tertiary-Care Center.''} \emph{Antimicrobial
Agents and Chemotherapy} 62 (9): e00505--18.
\url{https://doi.org/10.1128/AAC.00505-18}.

\bibitem[\citeproctext]{ref-Guilhaumou2019-eh}
Guilhaumou, Romain, Sihem Benaboud, Youssef Bennis, Claire
Dahyot-Fizelier, Eric Dailly, Peggy Gandia, Sylvain Goutelle, et al.
2019. {``Optimization of the Treatment with Beta-Lactam Antibiotics in
Critically Ill Patients-Guidelines from the French Society of
Pharmacology and Therapeutics (Soci{Ã©}t{Ã©} Fran{Ã§}aise de Pharmacologie
Et {Th{Ã©}rapeutique-SFPT}) and the French Society of Anaesthesia and
Intensive Care Medicine (Soci{Ã©}t{Ã©} Fran{Ã§}aise d'anesth{Ã©}sie Et
{R{Ã©}animation-SFAR}).''} \emph{Crit. Care} 23 (1): 104.

\bibitem[\citeproctext]{ref-Johnson2023-zo}
Johnson, Alistair E W, Lucas Bulgarelli, Lu Shen, Alvin Gayles, Ayad
Shammout, Steven Horng, Tom J Pollard, et al. 2023. {``{MIMIC-IV}, a
Freely Accessible Electronic Health Record Dataset.''} \emph{Sci. Data}
10 (1): 1.

\bibitem[\citeproctext]{ref-mellon2020}
Mellon, G, K Hammas, C Burdet, X Duval, C Carette, N El-Helali, L
Massias, F MentrÃ©, S Czernichow, and A -C CrÃ©mieux. 2020. {``Population
Pharmacokinetics and Dosing Simulations of Amoxicillin in Obese Adults
Receiving Co-Amoxiclav.''} \emph{Journal of Antimicrobial Chemotherapy}
75 (12): 3611--18. \url{https://doi.org/10.1093/jac/dkaa368}.

\bibitem[\citeproctext]{ref-rambaud2020}
Rambaud, Antoine, Benjamin Jean Gaborit, Colin Deschanvres, Paul Le
Turnier, RaphaÃ«l Lecomte, Nathalie Asseray-Madani, Anne-GaÃ«lle Leroy, et
al. 2020. {``Development and Validation of a Dosing Nomogram for
Amoxicillin in Infective Endocarditis.''} \emph{The Journal of
Antimicrobial Chemotherapy} 75 (10): 2941--50.
\url{https://doi.org/10.1093/jac/dkaa232}.

\end{CSLReferences}




\end{document}
